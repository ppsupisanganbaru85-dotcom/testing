<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSU-PISBAR-APP Versi 2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, get, query, orderByChild, limitToLast, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD26mSDHSGsjIMEAPtZgN-jd-ODViXe15E",
            authDomain: "absensi-ppsu-pisbar-f80f5.firebaseapp.com",
            databaseURL: "https://absensi-ppsu-pisbar-f80f5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "absensi-ppsu-pisbar-f80f5",
            storageBucket: "absensi-ppsu-pisbar-f80f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:c3c57c5fba975ee8558b66"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDB = database;
        window.firebaseStorage = storage;
        window.firebaseRefs = { ref, push, set, get, query, orderByChild, limitToLast, remove };
        window.firebaseStorageRefs = { storageRef, uploadString, getDownloadURL };
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        @keyframes gradientShift {
            0% { background: linear-gradient(45deg, #667eea, #764ba2); }
            25% { background: linear-gradient(45deg, #f093fb, #f5576c); }
            50% { background: linear-gradient(45deg, #4facfe, #00f2fe); }
            75% { background: linear-gradient(45deg, #43e97b, #38f9d7); }
            100% { background: linear-gradient(45deg, #667eea, #764ba2); }
        }
        
        .animated-bg {
            animation: gradientShift 10s ease-in-out infinite;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        
        #cameraPreview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .report-card {
            transition: transform 0.2s;
        }
        
        .report-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="animated-bg">
    <div class="min-h-screen p-4">
        <!-- Professional Header -->
        <header class="glass-effect rounded-lg mb-6 text-white">
            <div class="flex items-center justify-between p-4">
                <!-- Logo/Brand -->
                <div class="flex items-center space-x-3">
                    <img src="logoppsu.jpeg" alt="Logo PPSU" class="w-10 h-10 rounded-lg object-cover">
                    <div>
                        <h1 class="text-xl font-bold">PPSU PISANGAN BARU</h1>
                        <p class="text-xs opacity-75">Kelurahan Pisangan Baru</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex items-center space-x-2">
                    <button onclick="showPage('home')" class="nav-btn bg-indigo-500/80 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <span>🏠</span><span>Beranda</span>
                    </button>
                    <button onclick="showPage('input')" class="nav-btn bg-blue-500/80 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <span>📝</span><span>Input Data</span>
                    </button>
                    <button onclick="showPage('feed')" class="nav-btn bg-green-500/80 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <span>📋</span><span>Feed Laporan</span>
                    </button>
                    <button onclick="showPage('admin')" class="nav-btn bg-purple-500/80 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <span>👨‍💼</span><span>Admin</span>
                    </button>
                </nav>

                <!-- Mobile Hamburger Menu -->
                <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <div id="hamburger" class="space-y-1">
                        <div class="w-6 h-0.5 bg-white transition-all duration-300"></div>
                        <div class="w-6 h-0.5 bg-white transition-all duration-300"></div>
                        <div class="w-6 h-0.5 bg-white transition-all duration-300"></div>
                    </div>
                </button>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="hidden md:hidden border-t border-white/20">
                <nav class="p-4 space-y-2">
                    <button onclick="showPage('home'); closeMobileMenu()" class="w-full text-left bg-indigo-500/80 hover:bg-indigo-600 text-white px-4 py-3 rounded-lg transition-all duration-200 flex items-center space-x-3">
                        <span>🏠</span><span>Beranda</span>
                    </button>
                    <button onclick="showPage('input'); closeMobileMenu()" class="w-full text-left bg-blue-500/80 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition-all duration-200 flex items-center space-x-3">
                        <span>📝</span><span>Input Data</span>
                    </button>
                    <button onclick="showPage('feed'); closeMobileMenu()" class="w-full text-left bg-green-500/80 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition-all duration-200 flex items-center space-x-3">
                        <span>📋</span><span>Feed Laporan</span>
                    </button>
                    <button onclick="showPage('admin'); closeMobileMenu()" class="w-full text-left bg-purple-500/80 hover:bg-purple-600 text-white px-4 py-3 rounded-lg transition-all duration-200 flex items-center space-x-3">
                        <span>👨‍💼</span><span>Admin Panel</span>
                    </button>
                </nav>
            </div>
        </header>

        <!-- Home Page -->
        <div id="homePage" class="page fade-in">
            <!-- Hero Section -->
            <div class="glass-effect rounded-lg p-12 mb-8 text-white text-center">
                <div id="heroContent">
                    <h1 class="text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                        PPSU PISBAR App 
                    </h1>
                    <p class="text-xl md:text-2xl mb-8 opacity-90 max-w-2xl mx-auto">
                        Sistem Pelaporan Digital untuk Petugas PPSU
                    </p>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button onclick="showPage('input')" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            🚀 Mulai Laporan
                        </button>
                        <button onclick="showPage('feed')" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            📊 Lihat Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="glass-effect rounded-lg p-6 mb-6 text-white">
                <h2 class="text-2xl font-bold mb-4 text-center">📈 Statistik Sistem</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-400" id="homeStatTotal">0</div>
                        <div class="text-sm opacity-75">Total Laporan</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400" id="homeStatToday">0</div>
                        <div class="text-sm opacity-75">Hari Ini</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-400" id="homeStatTeams">0</div>
                        <div class="text-sm opacity-75">Petugas Aktif</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-yellow-400" id="homeStatPhotos">0</div>
                        <div class="text-sm opacity-75">Foto Dokumentasi</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="glass-effect rounded-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-4 text-center">🕒 Aktivitas Terbaru</h2>
                <div id="recentActivity" class="space-y-3">
                    <!-- Recent activities will be populated here -->
                </div>
            </div>

            <!-- Jadwal Piket Section -->
            <div class="glass-effect rounded-lg p-6 mt-6 text-white">
                <h2 class="text-2xl font-bold mb-4 text-center">📅 Jadwal Piket PPSU</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="text-left p-3 font-semibold text-gray-700">No</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Tanggal</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Jam</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Tim</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Petugas Aktif</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Shift</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Lokasi</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Deskripsi</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Foto</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Schedule data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="noScheduleMessage" class="text-center py-8 text-white/70 hidden">
                    <p class="text-lg">📋 Belum ada jadwal piket</p>
                    <p class="text-sm mt-2">Admin akan menginformasikan disini</p>
                </div>
            </div>

            <!-- Custom Content Section (Admin Editable) -->
            <div id="customContentSection" class="glass-effect rounded-lg p-6 mt-6 text-white">
                <div id="customContent">
                    <!-- Admin can customize this content -->
                </div>
            </div>
        </div>

        <!-- Input Data Page -->
        <div id="inputPage" class="page fade-in">
            <div class="glass-effect rounded-lg p-6 text-white">
                <h2 class="text-xl font-bold mb-4">📝 Input Data Laporan</h2>
                <form id="reportForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tim</label>
                            <input type="text" id="tim" required class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan nama tim (contoh: Tim A)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nama Petugas Aktif</label>
                            <input type="text" id="petugasAktif" required class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan nama petugas">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Shift Jam Kerja</label>
                            <input type="text" id="shift" required class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan shift (contoh: Pagi 07:00-15:00)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nama Petugas Tidak Aktif</label>
                            <input type="text" id="petugasTidakAktif" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan nama petugas (opsional)">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Lokasi Kerja</label>
                        <input type="text" id="lokasi" required class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan lokasi kerja">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Deskripsi Pengerjaan</label>
                        <textarea id="deskripsi" required rows="3" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Jelaskan detail pekerjaan yang dilakukan"></textarea>
                    </div>

                    <!-- Foto Dokumentasi -->
                    <div>
                        <label class="block text-sm font-medium mb-2">📸 Foto Dokumentasi</label>
                        <div class="space-y-3">
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="startCamera('user')" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                    📱 Kamera Depan
                                </button>
                                <button type="button" onclick="startCamera('environment')" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                    📷 Kamera Belakang
                                </button>
                                <button type="button" onclick="document.getElementById('fileInput').click()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition-colors">
                                    🖼️ Ambil Galeri
                                </button>
                            </div>
                            
                            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                            
                            <div id="cameraContainer" class="hidden">
                                <video id="cameraPreview" autoplay playsinline></video>
                                <div class="mt-2 flex gap-2">
                                    <button type="button" onclick="capturePhoto()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                                        📸 Ambil Foto
                                    </button>
                                    <button type="button" onclick="stopCamera()" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">
                                        ❌ Tutup Kamera
                                    </button>
                                </div>
                            </div>
                            
                            <div id="photoPreview" class="hidden">
                                <img id="previewImage" class="w-full max-w-md h-64 object-contain bg-black/20 rounded-lg border border-white/30">
                                <button type="button" onclick="removePhoto()" class="mt-2 bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                                    🗑️ Hapus Foto
                                </button>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        💾 Simpan Laporan
                    </button>
                </form>
            </div>
        </div>

        <!-- Feed Page -->
        <div id="feedPage" class="page hidden">
            <div class="glass-effect rounded-lg p-6 text-white mb-4">
                <h2 class="text-xl font-bold text-center">📋 Feed Laporan PPSU</h2>
            </div>
            <div id="feedContainer" class="space-y-6">
                <!-- Reports will be displayed here -->
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="page hidden">
            <!-- Login Form -->
            <div id="adminLogin" class="glass-effect rounded-lg p-6 text-white max-w-md mx-auto">
                <h2 class="text-xl font-bold mb-4 text-center">🔐 Login Admin</h2>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Username</label>
                        <input type="text" id="username" required class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="password" required class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Masukkan password">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        🔑 Login
                    </button>
                </form>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden">
                <div class="glass-effect rounded-lg p-6 text-white">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">👨‍💼 Admin Panel</h2>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                            🚪 Logout
                        </button>
                    </div>
                    
                    <!-- Schedule Management -->
                    <div class="glass-effect rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold mb-4">📅 Kelola Jadwal Piket</h3>
                        
                        <!-- Add Schedule Form -->
                        <div class="bg-white/10 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold mb-3">➕ Tambah Jadwal Baru</h4>
                            <form id="scheduleForm" class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Nama Petugas</label>
                                    <input type="text" id="scheduleNama" required class="w-full p-2 rounded bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Nama petugas">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Tanggal</label>
                                    <input type="date" id="scheduleTanggal" required class="w-full p-2 rounded bg-white/20 border border-white/30 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Jam Piket</label>
                                    <input type="text" id="scheduleJam" required class="w-full p-2 rounded bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="07:00-15:00">
                                </div>
                                <div class="flex items-end">
                                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                        ➕ Tambah
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Schedule List -->
                        <div class="bg-white/10 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">📋 Daftar Jadwal</h4>
                            <div id="scheduleList" class="space-y-2 max-h-60 overflow-y-auto">
                                <!-- Schedule items will be populated here -->
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="syncScheduleToSheets()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors text-sm">
                                    🔄 Sync Jadwal ke Sheets
                                </button>
                                <button onclick="clearAllSchedules()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors text-sm">
                                    🗑️ Hapus Semua
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Content Management -->
                    <div class="glass-effect rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold mb-2">🎨 Kelola Konten Beranda</h3>
                        <div class="space-y-4">
                            <!-- Hero Section Editor -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Judul Hero Section</label>
                                <input type="text" id="heroTitle" class="w-full p-2 rounded bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Judul utama beranda">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Subtitle Hero Section</label>
                                <input type="text" id="heroSubtitle" class="w-full p-2 rounded bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Subtitle beranda">
                            </div>
                            
                            <!-- Custom Content Editor -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Konten Kustom (HTML)</label>
                                <textarea id="customContentEditor" rows="8" class="w-full p-3 rounded bg-white/20 border border-white/30 text-white placeholder-white/70 font-mono text-sm" placeholder="Masukkan HTML untuk konten kustom..."></textarea>
                                <p class="text-xs text-white/60 mt-1">Gunakan HTML untuk membuat konten yang menarik. Contoh: &lt;h3&gt;Judul&lt;/h3&gt;&lt;p&gt;Paragraf&lt;/p&gt;</p>
                            </div>
                            
                            <div class="flex flex-wrap gap-2">
                                <button onclick="updateHomeContent()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                    💾 Simpan Konten
                                </button>
                                <button onclick="resetHomeContent()" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">
                                    🔄 Reset Default
                                </button>
                                <button onclick="previewHomeContent()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                    👁️ Preview
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Firebase Status -->
                    <div class="glass-effect rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold mb-2">☁️ Status Koneksi Database</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <div id="firebaseStatus" class="text-sm">
                                    <span class="inline-block w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                    Menghubungkan ke Firebase...
                                </div>
                                <div class="text-xs text-white/70 mt-1">
                                    Batas harian: <span id="dailyUsage">0</span>/${DAILY_LIMIT} laporan
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="syncPendingReports()" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm transition-colors">
                                    🔄 Sync Pending
                                </button>
                                <button onclick="cleanOldFirebaseData()" class="bg-orange-500 hover:bg-orange-600 px-3 py-1 rounded text-sm transition-colors">
                                    🧹 Bersihkan Data Lama
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Google Sheets Integration -->
                    <div class="glass-effect rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold mb-2">📊 Google Sheets Integration</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Google Apps Script Web App URL</label>
                                <input type="url" id="webAppUrl" class="w-full p-2 rounded bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                                <p class="text-xs text-white/60 mt-1">Masukkan URL Web App dari Google Apps Script yang sudah dibuat</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="syncToSheets()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                🔄 Sync ke Google Sheets
                            </button>
                            <button onclick="enableAutoSync()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                ⚡ Aktifkan Auto-Sync
                            </button>
                            <button onclick="disableAutoSync()" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">
                                ⏹️ Nonaktifkan Auto-Sync
                            </button>
                        </div>
                        <div id="syncStatus" class="mt-2 text-sm text-white/70"></div>
                    </div>
                    
                    <div class="glass-effect rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold mb-4">🔍 Filter & Pencarian Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Filter Tim</label>
                                <select id="filterTim" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white">
                                    <option value="">Semua Tim</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Cari Petugas</label>
                                <input type="text" id="filterPetugas" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Nama petugas">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Cari Lokasi</label>
                                <input type="text" id="filterLokasi" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70" placeholder="Lokasi kerja">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Filter Tanggal</label>
                                <input type="date" id="filterTanggal" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterReports()" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg transition-colors">
                                🔍 Cari Data
                            </button>
                            <button onclick="resetFilters()" class="bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded-lg transition-colors">
                                🔄 Reset Filter
                            </button>
                            <button onclick="exportFilteredData()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition-colors">
                                📊 Export Hasil
                            </button>
                        </div>
                        <div id="filterResults" class="mt-3 text-sm opacity-75"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="glass-effect rounded-lg p-4 text-center">
                            <h3 class="text-lg font-bold">📊 Total Laporan</h3>
                            <p id="totalReports" class="text-2xl font-bold text-green-400">0</p>
                        </div>
                        <div class="glass-effect rounded-lg p-4 text-center">
                            <h3 class="text-lg font-bold">📅 Hari Ini</h3>
                            <p id="todayReports" class="text-2xl font-bold text-blue-400">0</p>
                        </div>
                        <div class="glass-effect rounded-lg p-4 text-center">
                            <h3 class="text-lg font-bold">📆 Bulan Ini</h3>
                            <p id="monthReports" class="text-2xl font-bold text-purple-400">0</p>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="bg-white rounded-lg p-6 mb-6 shadow-lg">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">📋 Tabel Rekap Data</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-100 border-b-2 border-gray-300">
                                        <th class="text-left p-3 font-semibold text-gray-700">No</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Tanggal</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Jam</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Tim</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Petugas Aktif</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Shift</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Lokasi</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Deskripsi</th>
                                        <th class="text-left p-3 font-semibold text-gray-700">Foto</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody">
                                    <!-- Table data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="adminReportsContainer" class="space-y-4">
                        <!-- Admin reports will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let capturedPhoto = null;
        let reports = JSON.parse(localStorage.getItem('ppsuReports')) || [];
        let schedules = JSON.parse(localStorage.getItem('ppsuSchedules')) || [];

        // Firebase Data Management Functions
        const DAILY_LIMIT = 45; // Maximum 45 reports per day
        let isFirebaseReady = false;

        // Wait for Firebase to be ready
        setTimeout(() => {
            if (window.firebaseDB) {
                isFirebaseReady = true;
                console.log('✅ Firebase connected successfully');
                updateFirebaseStatus();
                loadDataFromFirebase();
                updateDailyUsage();
            } else {
                updateFirebaseStatus(false);
            }
        }, 1000);

        // Update Firebase status indicator
        function updateFirebaseStatus(connected = true) {
            const statusElement = document.getElementById('firebaseStatus');
            if (!statusElement) return;

            if (connected && isFirebaseReady) {
                statusElement.innerHTML = `
                    <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    Terhubung ke Firebase Cloud Database
                `;
            } else {
                statusElement.innerHTML = `
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    Offline - Data tersimpan lokal saja
                `;
            }
        }

        // Update daily usage counter
        async function updateDailyUsage() {
            const dailyUsageElement = document.getElementById('dailyUsage');
            if (!dailyUsageElement || !isFirebaseReady) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const todayRef = window.firebaseRefs.ref(window.firebaseDB, `reports/${today}`);
                const snapshot = await window.firebaseRefs.get(todayRef);
                
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                dailyUsageElement.textContent = count;
                
                // Update color based on usage
                const parent = dailyUsageElement.parentElement;
                if (count >= DAILY_LIMIT) {
                    parent.className = parent.className.replace('text-white/70', 'text-red-300');
                } else if (count >= DAILY_LIMIT * 0.8) {
                    parent.className = parent.className.replace('text-white/70', 'text-yellow-300');
                } else {
                    parent.className = parent.className.replace(/text-(red|yellow)-300/, 'text-white/70');
                }
            } catch (error) {
                console.error('Error updating daily usage:', error);
            }
        }

        // Sync pending local reports to Firebase
        async function syncPendingReports() {
            if (!isFirebaseReady) {
                alert('❌ Firebase tidak terhubung!');
                return;
            }

            const localReports = JSON.parse(localStorage.getItem('ppsuReports')) || [];
            const pendingReports = localReports.filter(report => !report.synced);
            
            if (pendingReports.length === 0) {
                alert('✅ Tidak ada laporan pending untuk disync!');
                return;
            }

            let syncedCount = 0;
            const button = document.querySelector('button[onclick="syncPendingReports()"]');
            const originalText = button.textContent;
            button.textContent = '⏳ Syncing...';
            button.disabled = true;

            for (const report of pendingReports) {
                const success = await saveReportToFirebase(report);
                if (success) {
                    report.synced = true;
                    syncedCount++;
                }
            }

            // Update localStorage
            localStorage.setItem('ppsuReports', JSON.stringify(localReports));
            
            button.textContent = originalText;
            button.disabled = false;
            
            alert(`✅ ${syncedCount} dari ${pendingReports.length} laporan berhasil disync ke Firebase!`);
            
            // Refresh data
            await loadDataFromFirebase();
            updateDailyUsage();
        }

        // Compress image to reduce storage usage
        function compressImage(dataUrl, quality = 0.6, maxWidth = 800) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = dataUrl;
            });
        }

        // Save report to Firebase with daily limit check
        async function saveReportToFirebase(report) {
            if (!isFirebaseReady) {
                console.warn('Firebase not ready, saving to localStorage only');
                return false;
            }

            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Check daily limit
                const todayRef = window.firebaseRefs.ref(window.firebaseDB, `reports/${today}`);
                const snapshot = await window.firebaseRefs.get(todayRef);
                
                if (snapshot.exists()) {
                    const todayReports = Object.keys(snapshot.val()).length;
                    if (todayReports >= DAILY_LIMIT) {
                        alert(`⚠️ Batas harian tercapai! Maksimal ${DAILY_LIMIT} laporan per hari.\nLaporan disimpan di perangkat saja.`);
                        return false;
                    }
                }

                // Compress photo if exists
                let compressedPhoto = null;
                if (report.foto) {
                    compressedPhoto = await compressImage(report.foto, 0.5, 600);
                }

                // Prepare compressed data
                const compressedReport = {
                    t: report.tim,                    // tim
                    pa: report.petugasAktif,         // petugasAktif
                    s: report.shift,                 // shift
                    pta: report.petugasTidakAktif || '', // petugasTidakAktif
                    l: report.lokasi,                // lokasi
                    d: report.deskripsi,             // deskripsi
                    tgl: report.tanggal,             // tanggal
                    j: report.jam,                   // jam
                    ts: report.timestamp,            // timestamp
                    f: compressedPhoto ? 1 : 0       // foto flag (1 = ada, 0 = tidak ada)
                };

                // Save to Firebase Realtime Database
                const reportRef = window.firebaseRefs.push(todayRef);
                await window.firebaseRefs.set(reportRef, compressedReport);

                // Save photo to Firebase Storage if exists
                if (compressedPhoto) {
                    const photoRef = window.firebaseStorageRefs.storageRef(window.firebaseStorage, `photos/${today}/${reportRef.key}.jpg`);
                    await window.firebaseStorageRefs.uploadString(photoRef, compressedPhoto, 'data_url');
                }

                console.log('✅ Report saved to Firebase successfully');
                return true;

            } catch (error) {
                console.error('❌ Firebase save error:', error);
                alert('⚠️ Gagal menyimpan ke cloud, data tersimpan di perangkat saja.');
                return false;
            }
        }

        // Load data from Firebase (only recent data to save reads)
        async function loadDataFromFirebase() {
            if (!isFirebaseReady) return;

            try {
                // Load only last 7 days to minimize reads
                const last7Days = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toISOString().split('T')[0]);
                }

                let firebaseReports = [];
                
                for (const date of last7Days) {
                    const dayRef = window.firebaseRefs.ref(window.firebaseDB, `reports/${date}`);
                    const snapshot = await window.firebaseRefs.get(dayRef);
                    
                    if (snapshot.exists()) {
                        const dayReports = snapshot.val();
                        for (const [key, report] of Object.entries(dayReports)) {
                            // Decompress data
                            const fullReport = {
                                id: key,
                                tim: report.t,
                                petugasAktif: report.pa,
                                shift: report.s,
                                petugasTidakAktif: report.pta,
                                lokasi: report.l,
                                deskripsi: report.d,
                                tanggal: report.tgl,
                                jam: report.j,
                                timestamp: report.ts,
                                foto: null, // Will load on demand
                                hasPhoto: report.f === 1
                            };
                            firebaseReports.push(fullReport);
                        }
                    }
                }

                // Merge with localStorage data (keep local as backup)
                const localReports = JSON.parse(localStorage.getItem('ppsuReports')) || [];
                const mergedReports = [...firebaseReports, ...localReports];
                
                // Remove duplicates based on timestamp
                const uniqueReports = mergedReports.filter((report, index, self) => 
                    index === self.findIndex(r => r.timestamp === report.timestamp)
                );

                reports = uniqueReports.sort((a, b) => b.timestamp - a.timestamp);
                
                console.log(`✅ Loaded ${firebaseReports.length} reports from Firebase`);
                
                // Update displays if on relevant pages
                if (document.getElementById('homePage').classList.contains('fade-in')) {
                    updateHomeStatistics();
                    displayRecentActivity();
                }

            } catch (error) {
                console.error('❌ Firebase load error:', error);
            }
        }

        // Load photo on demand to save bandwidth
        async function loadPhotoOnDemand(reportId, date) {
            if (!isFirebaseReady) return null;

            try {
                const photoRef = window.firebaseStorageRefs.storageRef(window.firebaseStorage, `photos/${date}/${reportId}.jpg`);
                const photoUrl = await window.firebaseStorageRefs.getDownloadURL(photoRef);
                return photoUrl;
            } catch (error) {
                console.error('Photo load error:', error);
                return null;
            }
        }

        // Clean old data to stay within limits (run weekly)
        async function cleanOldFirebaseData() {
            if (!isFirebaseReady) return;

            try {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - 30); // Keep only last 30 days
                
                const reportsRef = window.firebaseRefs.ref(window.firebaseDB, 'reports');
                const snapshot = await window.firebaseRefs.get(reportsRef);
                
                if (snapshot.exists()) {
                    const allDates = Object.keys(snapshot.val());
                    for (const date of allDates) {
                        if (new Date(date) < cutoffDate) {
                            const oldDateRef = window.firebaseRefs.ref(window.firebaseDB, `reports/${date}`);
                            await window.firebaseRefs.remove(oldDateRef);
                            console.log(`🗑️ Cleaned old data for ${date}`);
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Cleanup error:', error);
            }
        }

        // Save schedules to Firebase
        async function saveSchedulesToFirebase(scheduleData) {
            if (!isFirebaseReady) return false;

            try {
                const schedulesRef = window.firebaseRefs.ref(window.firebaseDB, 'schedules');
                await window.firebaseRefs.set(schedulesRef, scheduleData);
                console.log('✅ Schedules saved to Firebase');
                return true;
            } catch (error) {
                console.error('❌ Schedule save error:', error);
                return false;
            }
        }

        // Load schedules from Firebase
        async function loadSchedulesFromFirebase() {
            if (!isFirebaseReady) return;

            try {
                const schedulesRef = window.firebaseRefs.ref(window.firebaseDB, 'schedules');
                const snapshot = await window.firebaseRefs.get(schedulesRef);
                
                if (snapshot.exists()) {
                    const firebaseSchedules = Object.values(snapshot.val());
                    schedules = firebaseSchedules;
                    localStorage.setItem('ppsuSchedules', JSON.stringify(schedules));
                    console.log('✅ Schedules loaded from Firebase');
                }
            } catch (error) {
                console.error('❌ Schedule load error:', error);
            }
        }

        // Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageName + 'Page').classList.remove('hidden');
            
            if (pageName === 'home') {
                updateHomeStatistics();
                displayRecentActivity();
                displayScheduleTable();
                loadHomeContent();
            } else if (pageName === 'feed') {
                displayFeed();
            } else if (pageName === 'admin') {
                checkAdminLogin();
            }
        }

        // Admin Login Functions
        function checkAdminLogin() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                displayAdminPanel();
            } else {
                document.getElementById('adminLogin').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'eLfidachannel' && password === 'Pis212bar@') {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                displayAdminPanel();
                alert('✅ Login berhasil! Selamat datang Admin Elfira');
            } else {
                alert('❌ Username atau password salah!');
            }
        });

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Google Sheets Integration
        async function syncToSheets() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            
            if (!webAppUrl) {
                alert('❌ Masukkan URL Google Apps Script Web App terlebih dahulu!');
                return;
            }

            if (reports.length === 0) {
                alert('❌ Tidak ada data untuk disinkronkan!');
                return;
            }

            try {
                // Show loading
                const syncButton = document.querySelector('button[onclick="syncToSheets()"]');
                const originalText = syncButton.textContent;
                syncButton.textContent = '⏳ Menyinkronkan...';
                syncButton.disabled = true;

                // Prepare data for Google Sheets
                const dataToSync = reports.map((report, index) => ({
                    no: index + 1,
                    tanggal: report.tanggal,
                    jam: report.jam,
                    tim: report.tim,
                    petugasAktif: report.petugasAktif,
                    shift: report.shift,
                    petugasTidakAktif: report.petugasTidakAktif || '-',
                    lokasi: report.lokasi,
                    deskripsi: report.deskripsi,
                    foto: report.foto || '',
                    timestamp: report.timestamp
                }));

                // Send data to Google Apps Script
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveData',
                        data: dataToSync
                    })
                });

                // Reset button
                syncButton.textContent = originalText;
                syncButton.disabled = false;

                // Since we're using no-cors, we can't read the response
                // But we can assume success if no error was thrown
                alert(`✅ Data berhasil dikirim ke Google Sheets!\n\n${reports.length} laporan telah disinkronkan termasuk foto.`);
                
                // Save sync timestamp
                localStorage.setItem('lastSyncTime', new Date().toISOString());
                
            } catch (error) {
                // Reset button on error
                const syncButton = document.querySelector('button[onclick="syncToSheets()"]');
                syncButton.textContent = '🔄 Sync ke Google Sheets';
                syncButton.disabled = false;
                
                alert('❌ Terjadi kesalahan saat sinkronisasi: ' + error.message);
                console.error('Sync error:', error);
            }
        }

        // Auto-sync function (optional)
        function enableAutoSync() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            if (!webAppUrl) {
                alert('❌ Masukkan URL Web App terlebih dahulu!');
                return;
            }
            
            localStorage.setItem('autoSyncEnabled', 'true');
            localStorage.setItem('webAppUrl', webAppUrl);
            alert('✅ Auto-sync diaktifkan! Data akan otomatis tersinkron setiap ada laporan baru.');
        }

        function disableAutoSync() {
            localStorage.removeItem('autoSyncEnabled');
            alert('✅ Auto-sync dinonaktifkan.');
        }

        // Check and perform auto-sync
        async function checkAutoSync() {
            const autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
            const savedWebAppUrl = localStorage.getItem('webAppUrl');
            
            if (autoSyncEnabled && savedWebAppUrl && reports.length > 0) {
                document.getElementById('webAppUrl').value = savedWebAppUrl;
                try {
                    await syncToSheets();
                } catch (error) {
                    console.error('Auto-sync failed:', error);
                }
            }
        }

        function extractSheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        // Camera functions
        async function startCamera(facingMode) {
            try {
                if (currentStream) {
                    stopCamera();
                }

                const constraints = {
                    video: {
                        facingMode: facingMode
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraPreview');
                video.srcObject = currentStream;
                document.getElementById('cameraContainer').classList.remove('hidden');
            } catch (error) {
                alert('Tidak dapat mengakses kamera: ' + error.message);
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraContainer').classList.add('hidden');
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.8);
            showPhotoPreview(capturedPhoto);
            stopCamera();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedPhoto = e.target.result;
                    showPhotoPreview(capturedPhoto);
                };
                reader.readAsDataURL(file);
            }
        }

        function showPhotoPreview(photoData) {
            document.getElementById('previewImage').src = photoData;
            document.getElementById('photoPreview').classList.remove('hidden');
        }

        function removePhoto() {
            capturedPhoto = null;
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '⏳ Menyimpan...';
            submitBtn.disabled = true;
            
            const now = new Date();
            const report = {
                id: Date.now(),
                tim: document.getElementById('tim').value,
                petugasAktif: document.getElementById('petugasAktif').value,
                shift: document.getElementById('shift').value,
                petugasTidakAktif: document.getElementById('petugasTidakAktif').value,
                lokasi: document.getElementById('lokasi').value,
                deskripsi: document.getElementById('deskripsi').value,
                foto: capturedPhoto,
                tanggal: now.toLocaleDateString('id-ID'),
                jam: now.toLocaleTimeString('id-ID'),
                timestamp: now.getTime()
            };

            // Save to localStorage first (backup)
            reports.push(report);
            localStorage.setItem('ppsuReports', JSON.stringify(reports));
            
            // Try to save to Firebase
            const firebaseSaved = await saveReportToFirebase(report);
            
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            
            if (firebaseSaved) {
                alert('✅ Laporan berhasil disimpan ke cloud dan perangkat!');
            } else {
                alert('✅ Laporan disimpan di perangkat!\n⚠️ Akan otomatis sync ke cloud saat koneksi membaik.');
            }
            
            this.reset();
            removePhoto();
            
            // Update displays
            updateHomeStatistics();
            displayRecentActivity();
            
            // Check for auto-sync (Google Sheets)
            await checkAutoSync();
        });

        // Display feed
        async function displayFeed() {
            const container = document.getElementById('feedContainer');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = '<div class="glass-effect rounded-lg p-8 text-center text-white"><p class="text-lg">📝 Belum ada laporan tersimpan</p><p class="text-sm opacity-75 mt-2">Laporan yang dibuat akan muncul di sini</p></div>';
                return;
            }

            const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);

            for (const report of sortedReports) {
                const reportCard = document.createElement('div');
                reportCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden report-card';
                
                // Determine photo display
                let photoHtml = '';
                if (report.foto) {
                    // Local photo
                    photoHtml = `
                        <div class="px-4 pb-4">
                            <img src="${report.foto}" alt="Dokumentasi" class="w-full max-h-96 object-contain bg-gray-100 rounded-lg border">
                        </div>
                    `;
                } else if (report.hasPhoto && report.id) {
                    // Firebase photo - load on demand
                    const reportDate = new Date(report.timestamp).toISOString().split('T')[0];
                    photoHtml = `
                        <div class="px-4 pb-4">
                            <div id="photo-${report.id}" class="w-full h-48 bg-gray-100 rounded-lg border flex items-center justify-center cursor-pointer" onclick="loadFirebasePhoto('${report.id}', '${reportDate}')">
                                <div class="text-center text-gray-500">
                                    <div class="text-2xl mb-2">📸</div>
                                    <div class="text-sm">Klik untuk memuat foto</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                reportCard.innerHTML = `
                    <!-- Header Post -->
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${report.petugasAktif.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800">${report.petugasAktif}</h3>
                                <p class="text-sm text-gray-500">${report.tim} • ${report.tanggal} ${report.jam}</p>
                            </div>
                            ${isFirebaseReady ? '<div class="text-xs text-green-600">☁️ Cloud</div>' : '<div class="text-xs text-gray-500">📱 Local</div>'}
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-4">
                        <div class="mb-3">
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">📍 ${report.lokasi}</span>
                            <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">⏰ ${report.shift}</span>
                        </div>
                        <p class="text-gray-800 mb-3">${report.deskripsi}</p>
                        ${report.petugasTidakAktif ? `<p class="text-sm text-gray-600 mb-3"><strong>Petugas Tidak Aktif:</strong> ${report.petugasTidakAktif}</p>` : ''}
                    </div>
                    
                    <!-- Photo -->
                    ${photoHtml}
                    
                    <!-- Footer -->
                    <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span>📋 Laporan PPSU</span>
                            <span>${(report.foto || report.hasPhoto) ? '📸 Dengan Foto' : '📝 Tanpa Foto'}</span>
                        </div>
                    </div>
                `;
                container.appendChild(reportCard);
            }
        }

        // Load Firebase photo on demand
        async function loadFirebasePhoto(reportId, date) {
            const photoContainer = document.getElementById(`photo-${reportId}`);
            if (!photoContainer) return;

            photoContainer.innerHTML = '<div class="text-center text-gray-500"><div class="text-2xl mb-2">⏳</div><div class="text-sm">Memuat foto...</div></div>';

            try {
                const photoUrl = await loadPhotoOnDemand(reportId, date);
                if (photoUrl) {
                    photoContainer.innerHTML = `<img src="${photoUrl}" alt="Dokumentasi" class="w-full max-h-96 object-contain bg-gray-100 rounded-lg border">`;
                } else {
                    photoContainer.innerHTML = '<div class="text-center text-red-500"><div class="text-2xl mb-2">❌</div><div class="text-sm">Foto tidak dapat dimuat</div></div>';
                }
            } catch (error) {
                photoContainer.innerHTML = '<div class="text-center text-red-500"><div class="text-2xl mb-2">❌</div><div class="text-sm">Error memuat foto</div></div>';
            }
        }

        // Admin panel
        function displayAdminPanel() {
            updateStatistics();
            populateTeamFilter();
            displayAdminReports();
            displayDataTable();
            loadContentEditor();
            displayScheduleList();
        }

        function displayDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';

            if (reports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Belum ada data laporan</td></tr>';
                return;
            }

            const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);

            sortedReports.forEach((report, index) => {
                const shortDesc = report.deskripsi.length > 50 ? report.deskripsi.substring(0, 50) + '...' : report.deskripsi;
                const shortLokasi = report.lokasi.length > 20 ? report.lokasi.substring(0, 20) + '...' : report.lokasi;
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';

                let photoCellHtml = '<span class="text-red-500 text-lg">❌</span>';
                if (report.foto) { // Foto dari local storage (data URL)
                    photoCellHtml = `
                        <a href="${report.foto}" target="_blank" title="Klik untuk melihat gambar penuh">
                            <img src="${report.foto}" alt="thumbnail" class="w-16 h-16 object-cover rounded-md hover:scale-110 transition-transform">
                        </a>
                    `;
                } else if (report.hasPhoto) { // Foto dari Firebase
                    photoCellHtml = `
                        <a id="link-${report.id}" href="#" target="_blank" title="Klik untuk memuat dan melihat gambar" onclick="loadAndOpenPhoto(event, '${report.id}', '${new Date(report.timestamp).toISOString().split('T')[0]}')">
                            <img id="img-${report.id}" src="https://via.placeholder.com/64x64.png?text=Load" alt="thumbnail" class="w-16 h-16 object-cover rounded-md hover:scale-110 transition-transform">
                        </a>
                    `;
                }

                row.innerHTML = `
                    <td class="p-3 text-gray-800">${index + 1}</td>
                    <td class="p-3 text-gray-800">${report.tanggal}</td>
                    <td class="p-3 text-gray-800">${report.jam}</td>
                    <td class="p-3 text-gray-800 font-medium">${report.tim}</td>
                    <td class="p-3 text-gray-800">${report.petugasAktif}</td>
                    <td class="p-3 text-gray-600 text-sm">${report.shift}</td>
                    <td class="p-3 text-gray-800" title="${report.lokasi}">${shortLokasi}</td>
                    <td class="p-3 text-gray-600 max-w-xs">
                        <span id="desc-${report.id}">${shortDesc}</span>
                        ${report.deskripsi.length > 50 ? `
                            <button onclick="toggleDescription(${report.id}, '${report.deskripsi.replace(/'/g, "\\'")}', '${shortDesc}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm ml-1 underline">
                                Lihat selengkapnya
                            </button>
                        ` : ''}
                    </td>
                    <td class="p-3 text-center">
                        ${photoCellHtml}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadAndOpenPhoto(event, reportId, date) {
            event.preventDefault();
            const link = document.getElementById(`link-${reportId}`);
            const img = document.getElementById(`img-${reportId}`);
            
            // Jika URL sudah ada, langsung buka
            if (link.href && link.href !== '#') {
                window.open(link.href, '_blank');
                return;
            }

            img.src = "https://via.placeholder.com/64x64.png?text=Wait";
            
            try {
                const photoUrl = await loadPhotoOnDemand(reportId, date);
                if (photoUrl) {
                    img.src = photoUrl;
                    link.href = photoUrl;
                    window.open(photoUrl, '_blank'); // Buka di tab baru setelah berhasil dimuat
                } else {
                    img.alt = "Gagal muat";
                    alert('Gagal memuat foto.');
                }
            } catch (error) {
                img.alt = "Error";
                alert('Terjadi error saat memuat foto.');
            }
        }

        function toggleDescription(reportId, fullDesc, shortDesc) {
            const element = document.getElementById(`desc-${reportId}`);
            const button = element.nextElementSibling;
            
            if (element.textContent === shortDesc) {
                element.textContent = fullDesc;
                button.textContent = 'Lihat lebih sedikit';
            } else {
                element.textContent = shortDesc;
                button.textContent = 'Lihat selengkapnya';
            }
        }

        function updateStatistics() {
            const today = new Date().toLocaleDateString('id-ID');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const todayReports = reports.filter(report => report.tanggal === today);
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.timestamp);
                return reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear;
            });

            document.getElementById('totalReports').textContent = reports.length;
            document.getElementById('todayReports').textContent = todayReports.length;
            document.getElementById('monthReports').textContent = monthReports.length;
        }

        function displayAdminReports() {
            const container = document.getElementById('adminReportsContainer');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = '<p class="text-center text-white/70">Belum ada laporan tersimpan.</p>';
                return;
            }

            const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);

            sortedReports.forEach(report => {
                const reportCard = document.createElement('div');
                reportCard.className = 'glass-effect rounded-lg p-4 mb-4';
                reportCard.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <strong>Tim:</strong> ${report.tim}<br>
                            <strong>Petugas:</strong> ${report.petugasAktif}
                        </div>
                        <div>
                            <strong>Tanggal:</strong> ${report.tanggal}<br>
                            <strong>Jam:</strong> ${report.jam}
                        </div>
                        <div>
                            <strong>Shift:</strong> ${report.shift}<br>
                            <strong>Lokasi:</strong> ${report.lokasi}
                        </div>
                        <div class="text-right">
                            ${report.foto ? '📸 Ada Foto' : '📷 Tanpa Foto'}
                        </div>
                    </div>
                `;
                container.appendChild(reportCard);
            });
        }

        function filterReports() {
            const timFilter = document.getElementById('filterTim').value;
            const petugasFilter = document.getElementById('filterPetugas').value.toLowerCase().trim();
            const lokasiFilter = document.getElementById('filterLokasi').value.toLowerCase().trim();
            const tanggalFilter = document.getElementById('filterTanggal').value;
            
            let filteredReports = reports;
            
            // Filter by Tim
            if (timFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.tim.toLowerCase().includes(timFilter.toLowerCase())
                );
            }
            
            // Filter by Petugas (search in both active and inactive)
            if (petugasFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.petugasAktif.toLowerCase().includes(petugasFilter) ||
                    (report.petugasTidakAktif && report.petugasTidakAktif.toLowerCase().includes(petugasFilter))
                );
            }
            
            // Filter by Lokasi
            if (lokasiFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.lokasi.toLowerCase().includes(lokasiFilter)
                );
            }
            
            // Filter by Tanggal
            if (tanggalFilter) {
                const filterDate = new Date(tanggalFilter).toLocaleDateString('id-ID');
                filteredReports = filteredReports.filter(report => 
                    report.tanggal === filterDate
                );
            }
            
            // Update filter results info
            const resultsInfo = document.getElementById('filterResults');
            resultsInfo.textContent = `Menampilkan ${filteredReports.length} dari ${reports.length} laporan`;
            
            if (filteredReports.length === 0) {
                resultsInfo.textContent += ' - Tidak ada data yang sesuai dengan filter';
                resultsInfo.className = 'mt-3 text-sm text-red-300';
            } else {
                resultsInfo.className = 'mt-3 text-sm text-green-300';
            }

            // Update table with filtered data
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';

            if (filteredReports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Tidak ada data yang sesuai filter</td></tr>';
            } else {
                const sortedReports = [...filteredReports].sort((a, b) => b.timestamp - a.timestamp);

                sortedReports.forEach((report, index) => {
                    const shortDesc = report.deskripsi.length > 50 ? report.deskripsi.substring(0, 50) + '...' : report.deskripsi;
                    const shortLokasi = report.lokasi.length > 20 ? report.lokasi.substring(0, 20) + '...' : report.lokasi;
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';

                    let photoCellHtml = '<span class="text-red-500 text-lg">❌</span>';
                    if (report.foto) { // Foto dari local storage (data URL)
                        photoCellHtml = `
                            <a href="${report.foto}" target="_blank" title="Klik untuk melihat gambar penuh">
                                <img src="${report.foto}" alt="thumbnail" class="w-16 h-16 object-cover rounded-md hover:scale-110 transition-transform">
                            </a>
                        `;
                    } else if (report.hasPhoto) { // Foto dari Firebase
                        photoCellHtml = `
                            <a id="link-${report.id}" href="#" target="_blank" title="Klik untuk memuat dan melihat gambar" onclick="loadAndOpenPhoto(event, '${report.id}', '${new Date(report.timestamp).toISOString().split('T')[0]}')">
                                <img id="img-${report.id}" src="https://via.placeholder.com/64x64.png?text=Load" alt="thumbnail" class="w-16 h-16 object-cover rounded-md hover:scale-110 transition-transform">
                            </a>
                        `;
                    }

                    row.innerHTML = `
                        <td class="p-3 text-gray-800">${index + 1}</td>
                        <td class="p-3 text-gray-800">${report.tanggal}</td>
                        <td class="p-3 text-gray-800">${report.jam}</td>
                        <td class="p-3 text-gray-800 font-medium">${report.tim}</td>
                        <td class="p-3 text-gray-800">${report.petugasAktif}</td>
                        <td class="p-3 text-gray-600 text-sm">${report.shift}</td>
                        <td class="p-3 text-gray-800" title="${report.lokasi}">${shortLokasi}</td>
                        <td class="p-3 text-gray-600 max-w-xs">
                            <span id="desc-${report.id}">${shortDesc}</span>
                            ${report.deskripsi.length > 50 ? `
                                <button onclick="toggleDescription(${report.id}, '${report.deskripsi.replace(/'/g, "\\'")}', '${shortDesc}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm ml-1 underline">
                                    Lihat selengkapnya
                                </button>
                            ` : ''}
                        </td>
                        <td class="p-3 text-center">
                            ${photoCellHtml}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        async function loadAndOpenPhoto(event, reportId, date) {
            event.preventDefault();
            const link = document.getElementById(`link-${reportId}`);
            const img = document.getElementById(`img-${reportId}`);
            
            // Jika URL sudah ada, langsung buka
            if (link.href && link.href !== '#') {
                window.open(link.href, '_blank');
                return;
            }

            img.src = "https://via.placeholder.com/64x64.png?text=Wait";
            
            try {
                const photoUrl = await loadPhotoOnDemand(reportId, date);
                if (photoUrl) {
                    img.src = photoUrl;
                    link.href = photoUrl;
                    window.open(photoUrl, '_blank'); // Buka di tab baru setelah berhasil dimuat
                } else {
                    img.alt = "Gagal muat";
                    alert('Gagal memuat foto.');
                }
            } catch (error) {
                img.alt = "Error";
                alert('Terjadi error saat memuat foto.');
            }
        }

        function toggleDescription(reportId, fullDesc, shortDesc) {
            const element = document.getElementById(`desc-${reportId}`);
            const button = element.nextElementSibling;
            
            if (element.textContent === shortDesc) {
                element.textContent = fullDesc;
                button.textContent = 'Lihat lebih sedikit';
            } else {
                element.textContent = shortDesc;
                button.textContent = 'Lihat selengkapnya';
            }
        }

        function updateStatistics() {
            const today = new Date().toLocaleDateString('id-ID');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const todayReports = reports.filter(report => report.tanggal === today);
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.timestamp);
                return reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear;
            });

            document.getElementById('totalReports').textContent = reports.length;
            document.getElementById('todayReports').textContent = todayReports.length;
            document.getElementById('monthReports').textContent = monthReports.length;
        }

        function displayAdminReports() {
            const container = document.getElementById('adminReportsContainer');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = '<p class="text-center text-white/70">Belum ada laporan tersimpan.</p>';
                return;
            }

            const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);

            sortedReports.forEach(report => {
                const reportCard = document.createElement('div');
                reportCard.className = 'glass-effect rounded-lg p-4 mb-4';
                reportCard.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <strong>Tim:</strong> ${report.tim}<br>
                            <strong>Petugas:</strong> ${report.petugasAktif}
                        </div>
                        <div>
                            <strong>Tanggal:</strong> ${report.tanggal}<br>
                            <strong>Jam:</strong> ${report.jam}
                        </div>
                        <div>
                            <strong>Shift:</strong> ${report.shift}<br>
                            <strong>Lokasi:</strong> ${report.lokasi}
                        </div>
                        <div class="text-right">
                            ${report.foto ? '📸 Ada Foto' : '📷 Tanpa Foto'}
                        </div>
                    </div>
                `;
                container.appendChild(reportCard);
            });
        }

        function filterReports() {
            const timFilter = document.getElementById('filterTim').value;
            const petugasFilter = document.getElementById('filterPetugas').value.toLowerCase().trim();
            const lokasiFilter = document.getElementById('filterLokasi').value.toLowerCase().trim();
            const tanggalFilter = document.getElementById('filterTanggal').value;
            
            let filteredReports = reports;
            
            // Filter by Tim
            if (timFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.tim.toLowerCase().includes(timFilter.toLowerCase())
                );
            }
            
            // Filter by Petugas (search in both active and inactive)
            if (petugasFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.petugasAktif.toLowerCase().includes(petugasFilter) ||
                    (report.petugasTidakAktif && report.petugasTidakAktif.toLowerCase().includes(petugasFilter))
                );
            }
            
            // Filter by Lokasi
            if (lokasiFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.lokasi.toLowerCase().includes(lokasiFilter)
                );
            }
            
            // Filter by Tanggal
            if (tanggalFilter) {
                const filterDate = new Date(tanggalFilter).toLocaleDateString('id-ID');
                filteredReports = filteredReports.filter(report => 
                    report.tanggal === filterDate
                );
            }
            
            // Update filter results info
            const resultsInfo = document.getElementById('filterResults');
            resultsInfo.textContent = `Menampilkan ${filteredReports.length} dari ${reports.length} laporan`;
            
            if (filteredReports.length === 0) {
                resultsInfo.textContent += ' - Tidak ada data yang sesuai dengan filter';
                resultsInfo.className = 'mt-3 text-sm text-red-300';
            } else {
                resultsInfo.className = 'mt-3 text-sm text-green-300';
            }

            // Update table with filtered data
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';

            if (filteredReports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Tidak ada data yang sesuai filter</td></tr>';
            } else {
                const sortedReports = [...filteredReports].sort((a, b) => b.timestamp - a.timestamp);

                sortedReports.forEach((report, index) => {
                    const shortDesc = report.deskripsi.length > 50 ? report.deskripsi.substring(0, 50) + '...' : report.deskripsi;
                    const shortLokasi = report.lokasi.length > 20 ? report.lokasi.substring(0, 20) + '...' : report.lokasi;
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';

                    let photoCellHtml = '<span class="text-red-500 text-lg">❌</span>';
                    if (report.foto) { // Foto dari local storage (data URL)
                        photoCellHtml = `
                            <a href="${report.foto}" target="_blank" title="Klik untuk melihat gambar penuh">
                                <img src="${report.foto}" alt="thumbnail" class="w-16 h-16 object-cover rounded-md hover:scale-110 transition-transform">
                            </a>
                        `;
                    } else if (report.hasPhoto) { // Foto dari Firebase
                        photoCellHtml = `
                            <a id="link-${report.id}" href="#" target="_blank" title="Klik untuk memuat dan melihat gambar" onclick="loadAndOpenPhoto(event, '${report.id}', '${new Date(report.timestamp).toISOString().split('T')[0]}')">
                                <img id="img-${report.id}" src="https://via.placeholder.com/64x64.png?text=Load" alt="thumbnail" class="w-16 h-16 object-cover rounded-md hover:scale-110 transition-transform">
                            </a>
                        `;
                    }

                    row.innerHTML = `
                        <td class="p-3 text-gray-800">${index + 1}</td>
                        <td class="p-3 text-gray-800">${report.tanggal}</td>
                        <td class="p-3 text-gray-800">${report.jam}</td>
                        <td class="p-3 text-gray-800 font-medium">${report.tim}</td>
                        <td class="p-3 text-gray-800">${report.petugasAktif}</td>
                        <td class="p-3 text-gray-600 text-sm">${report.shift}</td>
                        <td class="p-3 text-gray-800" title="${report.lokasi}">${shortLokasi}</td>
                        <td class="p-3 text-gray-600 max-w-xs">
                            <span id="desc-${report.id}">${shortDesc}</span>
                            ${report.deskripsi.length > 50 ? `
                                <button onclick="toggleDescription(${report.id}, '${report.deskripsi.replace(/'/g, "\\'")}', '${shortDesc}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm ml-1 underline">
                                    Lihat selengkapnya
                                </button>
                            ` : ''}
                        </td>
                        <td class="p-3 text-center">
                            ${photoCellHtml}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        // Reset filters function
        function resetFilters() {
            document.getElementById('filterTim').value = '';
            document.getElementById('filterPetugas').value = '';
            document.getElementById('filterLokasi').value = '';
            document.getElementById('filterTanggal').value = '';
            
            const resultsInfo = document.getElementById('filterResults');
            resultsInfo.textContent = '';
            
            // Refresh the display
            displayDataTable();
            displayAdminReports();
            
            alert('✅ Filter berhasil direset!');
        }
        
        // Export filtered data function
        function exportFilteredData() {
            const timFilter = document.getElementById('filterTim').value;
            const petugasFilter = document.getElementById('filterPetugas').value.toLowerCase().trim();
            const lokasiFilter = document.getElementById('filterLokasi').value.toLowerCase().trim();
            const tanggalFilter = document.getElementById('filterTanggal').value;
            
            let filteredReports = reports;
            
            // Apply same filters as filterReports function
            if (timFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.tim.toLowerCase().includes(timFilter.toLowerCase())
                );
            }
            
            if (petugasFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.petugasAktif.toLowerCase().includes(petugasFilter) ||
                    (report.petugasTidakAktif && report.petugasTidakAktif.toLowerCase().includes(petugasFilter))
                );
            }
            
            if (lokasiFilter) {
                filteredReports = filteredReports.filter(report => 
                    report.lokasi.toLowerCase().includes(lokasiFilter)
                );
            }
            
            if (tanggalFilter) {
                const filterDate = new Date(tanggalFilter).toLocaleDateString('id-ID');
                filteredReports = filteredReports.filter(report => 
                    report.tanggal === filterDate
                );
            }
            
            if (filteredReports.length === 0) {
                alert('❌ Tidak ada data untuk diekspor!');
                return;
            }
            
            // Prepare export data
            const exportData = [
                ['No', 'Tanggal', 'Jam', 'Tim', 'Petugas Aktif', 'Shift', 'Petugas Tidak Aktif', 'Lokasi', 'Deskripsi', 'Ada Foto']
            ];
            
            filteredReports.forEach((report, index) => {
                exportData.push([
                    index + 1,
                    report.tanggal,
                    report.jam,
                    report.tim,
                    report.petugasAktif,
                    report.shift,
                    report.petugasTidakAktif || '-',
                    report.lokasi,
                    report.deskripsi,
                    report.foto ? 'Ya' : 'Tidak'
                ]);
            });
            
            // Convert to CSV format
            const csvContent = exportData.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `PPSU_Laporan_Filtered_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Data berhasil diekspor! (${filteredReports.length} laporan)`);
        }
        
        // Populate team filter options dynamically
        function populateTeamFilter() {
            const teamSelect = document.getElementById('filterTim');
            const teams = [...new Set(reports.map(report => report.tim))].sort();
            
            // Clear existing options except "Semua Tim"
            teamSelect.innerHTML = '<option value="">Semua Tim</option>';
            
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
        }

        // Home Page Functions
        function updateHomeStatistics() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayReports = reports.filter(report => report.tanggal === today);
            const teams = [...new Set(reports.map(report => report.tim))];
            const photosCount = reports.filter(report => report.foto).length;

            document.getElementById('homeStatTotal').textContent = reports.length;
            document.getElementById('homeStatToday').textContent = todayReports.length;
            document.getElementById('homeStatTeams').textContent = teams.length;
            document.getElementById('homeStatPhotos').textContent = photosCount;
        }

        function displayRecentActivity() {
            const container = document.getElementById('recentActivity');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = '<p class="text-white/70 text-center py-4">Belum ada aktivitas terbaru</p>';
                return;
            }

            const recentReports = [...reports]
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);

            recentReports.forEach(report => {
                const activityItem = document.createElement('div');
                activityItem.className = 'bg-white/10 rounded-lg p-3 flex items-center space-x-3';
                activityItem.innerHTML = `
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        ${report.petugasAktif.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">${report.petugasAktif} - ${report.tim}</p>
                        <p class="text-sm text-gray-500">${report.lokasi} • ${report.tanggal} ${report.jam}</p>
                    </div>
                    <div class="text-right">
                        ${report.foto ? '<span class="text-green-400">📸</span>' : '<span class="text-gray-400">📝</span>'}
                    </div>
                `;
                container.appendChild(activityItem);
            });
        }

        function loadHomeContent() {
            // Load saved content
            const savedHeroTitle = localStorage.getItem('heroTitle');
            const savedHeroSubtitle = localStorage.getItem('heroSubtitle');
            const savedCustomContent = localStorage.getItem('customContent');

            // Update hero section if saved content exists
            if (savedHeroTitle || savedHeroSubtitle) {
                const heroContent = document.getElementById('heroContent');
                heroContent.innerHTML = `
                    <h1 class="text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                        ${savedHeroTitle || 'PPSU-PISBAR'}
                    </h1>
                    <p class="text-xl md:text-2xl mb-8 opacity-90 max-w-2xl mx-auto">
                        ${savedHeroSubtitle || 'Sistem Pelaporan Digital untuk Petugas PPSU'}
                    </p>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button onclick="showPage('input')" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            🚀 Mulai Laporan
                        </button>
                        <button onclick="showPage('feed')" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            📊 Lihat Data
                        </button>
                    </div>
                `;
            }

            // Update custom content if saved content exists
            if (savedCustomContent) {
                document.getElementById('customContent').innerHTML = savedCustomContent;
            }
        }

        function updateHomeContent() {
            const heroTitle = document.getElementById('heroTitle').value;
            const heroSubtitle = document.getElementById('heroSubtitle').value;
            const customContent = document.getElementById('customContentEditor').value;

            // Save to localStorage
            if (heroTitle) localStorage.setItem('heroTitle', heroTitle);
            if (heroSubtitle) localStorage.setItem('heroSubtitle', heroSubtitle);
            if (customContent) localStorage.setItem('customContent', customContent);

            // Update the home page immediately
            if (heroTitle || heroSubtitle) {
                const heroContent = document.getElementById('heroContent');
                heroContent.innerHTML = `
                    <h1 class="text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                        ${heroTitle || 'PPSU-PISBAR'}
                    </h1>
                    <p class="text-xl md:text-2xl mb-8 opacity-90 max-w-2xl mx-auto">
                        ${heroSubtitle || 'Sistem Pelaporan Digital untuk Petugas PPSU'}
                    </p>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button onclick="showPage('input')" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            🚀 Mulai Laporan
                        </button>
                        <button onclick="showPage('feed')" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            📊 Lihat Data
                        </button>
                    </div>
                `;
            }

            if (customContent) {
                document.getElementById('customContent').innerHTML = customContent;
            }

            alert('✅ Konten beranda berhasil diperbarui!');
            
            // Clear the form
            document.getElementById('heroTitle').value = '';
            document.getElementById('heroSubtitle').value = '';
            document.getElementById('customContentEditor').value = '';
        }

        function resetHomeContent() {
            // Remove saved content
            localStorage.removeItem('heroTitle');
            localStorage.removeItem('heroSubtitle');
            localStorage.removeItem('customContent');

            // Reset to default
            const heroContent = document.getElementById('heroContent');
            heroContent.innerHTML = `
                <h1 class="text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                    PPSU-PISBAR
                </h1>
                <p class="text-xl md:text-2xl mb-8 opacity-90 max-w-2xl mx-auto">
                    Sistem Pelaporan Digital untuk Petugas PPSU
                </p>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="showPage('input')" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        🚀 Mulai Laporan
                    </button>
                    <button onclick="showPage('feed')" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        📊 Lihat Data
                    </button>
                </div>
            `;

            document.getElementById('customContent').innerHTML = ``;

            alert('✅ Konten beranda berhasil direset ke default!');
        }

        function previewHomeContent() {
            showPage('home');
            alert('👁️ Silakan lihat preview konten di halaman beranda!');
        }

        function displayAdminPanel() {
            updateStatistics();
            populateTeamFilter();
            displayAdminReports();
            displayDataTable();
            loadContentEditor();
            displayScheduleList();
        }

        // Schedule Management Functions
        function displayScheduleTable() {
            const tableBody = document.getElementById('scheduleTableBody');
            const noScheduleMessage = document.getElementById('noScheduleMessage');
            
            tableBody.innerHTML = '';
            
            if (schedules.length === 0) {
                tableBody.parentElement.parentElement.style.display = 'none';
                noScheduleMessage.classList.remove('hidden');
                return;
            }
            
            tableBody.parentElement.parentElement.style.display = 'block';
            noScheduleMessage.classList.add('hidden');
            
            // Sort schedules by date
            const sortedSchedules = [...schedules].sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            
            sortedSchedules.forEach(schedule => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/20 hover:bg-white/10 transition-colors';
                
                // Format date to show day name
                const date = new Date(schedule.tanggal);
                const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const dayName = dayNames[date.getDay()];
                const formattedDate = date.toLocaleDateString('id-ID');
                
                // Check if schedule is today or upcoming
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;
                
                row.innerHTML = `
                    <td class="p-3 font-medium ${isToday ? 'text-yellow-300' : isPast ? 'text-gray-400' : 'text-white'}">${schedule.nama}</td>
                    <td class="p-3 ${isToday ? 'text-yellow-300' : isPast ? 'text-gray-400' : 'text-white/90'}">${formattedDate}</td>
                    <td class="p-3 ${isToday ? 'text-yellow-300' : isPast ? 'text-gray-400' : 'text-white/90'}">${dayName}</td>
                    <td class="p-3 ${isToday ? 'text-yellow-300' : isPast ? 'text-gray-400' : 'text-white/90'}">${schedule.jam}</td>
                `;
                
                if (isToday) {
                    row.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                }
                
                tableBody.appendChild(row);
            });
        }

        function displayScheduleList() {
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = '';
            
            if (schedules.length === 0) {
                scheduleList.innerHTML = '<p class="text-white/70 text-center py-4">Belum ada jadwal piket</p>';
                return;
            }
            
            // Sort schedules by date (newest first for admin view)
            const sortedSchedules = [...schedules].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            sortedSchedules.forEach((schedule, index) => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'bg-white/10 rounded-lg p-3 flex items-center justify-between';
                
                const date = new Date(schedule.tanggal);
                const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const dayName = dayNames[date.getDay()];
                const formattedDate = date.toLocaleDateString('id-ID');
                
                scheduleItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium">${schedule.nama}</div>
                        <div class="text-sm text-white/70">${formattedDate} (${dayName}) • ${schedule.jam}</div>
                    </div>
                    <button onclick="deleteSchedule(${index})" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition-colors">
                        🗑️ Hapus
                    </button>
                `;
                
                scheduleList.appendChild(scheduleItem);
            });
        }

        // Schedule form submission
        document.addEventListener('DOMContentLoaded', function() {
            const scheduleForm = document.getElementById('scheduleForm');
            if (scheduleForm) {
                scheduleForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = '⏳ Menyimpan...';
                    submitBtn.disabled = true;
                    
                    const nama = document.getElementById('scheduleNama').value;
                    const tanggal = document.getElementById('scheduleTanggal').value;
                    const jam = document.getElementById('scheduleJam').value;
                    
                    const newSchedule = {
                        id: Date.now(),
                        nama: nama,
                        tanggal: tanggal,
                        jam: jam,
                        timestamp: new Date().getTime()
                    };
                    
                    schedules.push(newSchedule);
                    localStorage.setItem('ppsuSchedules', JSON.stringify(schedules));
                    
                    // Save to Firebase
                    await saveSchedulesToFirebase(schedules);
                    
                    // Reset button
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    
                    alert('✅ Jadwal piket berhasil ditambahkan!');
                    
                    // Reset form
                    this.reset();
                    
                    // Refresh displays
                    displayScheduleList();
                    displayScheduleTable();
                    
                    // Auto-sync if enabled
                    checkScheduleAutoSync();
                });
            }
            
            // Load schedules from Firebase on startup
            setTimeout(() => {
                if (isFirebaseReady) {
                    loadSchedulesFromFirebase();
                }
            }, 2000);
        });

        function deleteSchedule(index) {
            if (confirm('❓ Yakin ingin menghapus jadwal ini?')) {
                schedules.splice(index, 1);
                localStorage.setItem('ppsuSchedules', JSON.stringify(schedules));
                
                displayScheduleList();
                displayScheduleTable();
                
                alert('✅ Jadwal berhasil dihapus!');
            }
        }

        function clearAllSchedules() {
            if (confirm('❓ Yakin ingin menghapus SEMUA jadwal piket? Tindakan ini tidak dapat dibatalkan!')) {
                schedules = [];
                localStorage.setItem('ppsuSchedules', JSON.stringify(schedules));
                
                displayScheduleList();
                displayScheduleTable();
                
                alert('✅ Semua jadwal berhasil dihapus!');
            }
        }

        // Schedule sync to Google Sheets
        async function syncScheduleToSheets() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            
            if (!webAppUrl) {
                alert('❌ Masukkan URL Google Apps Script Web App terlebih dahulu!');
                return;
            }

            if (schedules.length === 0) {
                alert('❌ Tidak ada jadwal untuk disinkronkan!');
                return;
            }

            try {
                const syncButton = document.querySelector('button[onclick="syncScheduleToSheets()"]');
                const originalText = syncButton.textContent;
                syncButton.textContent = '⏳ Menyinkronkan...';
                syncButton.disabled = true;

                // Prepare schedule data for Google Sheets
                const scheduleDataToSync = schedules.map((schedule, index) => {
                    const date = new Date(schedule.tanggal);
                    const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                    const dayName = dayNames[date.getDay()];
                    
                    return {
                        no: index + 1,
                        nama: schedule.nama,
                        tanggal: date.toLocaleDateString('id-ID'),
                        hari: dayName,
                        jam: schedule.jam,
                        timestamp: schedule.timestamp
                    };
                });

                // Send schedule data to Google Apps Script
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveSchedule',
                        data: scheduleDataToSync
                    })
                });

                syncButton.textContent = originalText;
                syncButton.disabled = false;

                alert(`✅ Jadwal piket berhasil dikirim ke Google Sheets!\n\n${schedules.length} jadwal telah disinkronkan.`);
                
                localStorage.setItem('lastScheduleSyncTime', new Date().toISOString());
                
            } catch (error) {
                const syncButton = document.querySelector('button[onclick="syncScheduleToSheets()"]');
                syncButton.textContent = '🔄 Sync Jadwal ke Sheets';
                syncButton.disabled = false;
                
                alert('❌ Terjadi kesalahan saat sinkronisasi jadwal: ' + error.message);
                console.error('Schedule sync error:', error);
            }
        }

        // Check and perform auto-sync for schedules
        async function checkScheduleAutoSync() {
            const autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
            const savedWebAppUrl = localStorage.getItem('webAppUrl');
            
            if (autoSyncEnabled && savedWebAppUrl && schedules.length > 0) {
                document.getElementById('webAppUrl').value = savedWebAppUrl;
                try {
                    await syncScheduleToSheets();
                } catch (error) {
                    console.error('Schedule auto-sync failed:', error);
                }
            }
        }

        function loadContentEditor() {
            // Load current content into editor
            const savedHeroTitle = localStorage.getItem('heroTitle') || '';
            const savedHeroSubtitle = localStorage.getItem('heroSubtitle') || '';
            const savedCustomContent = localStorage.getItem('customContent') || '';

            document.getElementById('heroTitle').value = savedHeroTitle;
            document.getElementById('heroSubtitle').value = savedHeroSubtitle;
            document.getElementById('customContentEditor').value = savedCustomContent;
        }

        // Mobile menu functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.getElementById('hamburger');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                // Animate hamburger to X
                hamburger.children[0].style.transform = 'rotate(45deg) translate(6px, 6px)';
                hamburger.children[1].style.opacity = '0';
                hamburger.children[2].style.transform = 'rotate(-45deg) translate(6px, -6px)';
            } else {
                mobileMenu.classList.add('hidden');
                // Reset hamburger
                hamburger.children[0].style.transform = 'none';
                hamburger.children[1].style.opacity = '1';
                hamburger.children[2].style.transform = 'none';
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.getElementById('hamburger');
            
            mobileMenu.classList.add('hidden');
            // Reset hamburger
            hamburger.children[0].style.transform = 'none';
            hamburger.children[1].style.opacity = '1';
            hamburger.children[2].style.transform = 'none';
        }

        // Initialize app
        showPage('home');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9892f559322b7e32',t:'MTc1OTU2Mjg2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
