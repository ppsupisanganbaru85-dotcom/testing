<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSU-Pisbar-App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- OpenStreetMap Leaflet (Free Alternative) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, orderBy, query, serverTimestamp, updateDoc, setDoc, where, limit } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';
        
        // KONFIGURASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDhtb3vYVPopaNHyhUlHaxsFhA6_gbyDvg",
            authDomain: "aplikasi-laporan-ppsu.firebaseapp.com",
            databaseURL: "https://aplikasi-laporan-ppsu-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aplikasi-laporan-ppsu",
            storageBucket: "aplikasi-laporan-ppsu.firebasestorage.app",
            messagingSenderId: "990462370722",
            appId: "1:990462370722:web:4ab77301f1decdfc1c88fb",
            measurementId: "G-7T6X3MMYEH"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.storage = getStorage(window.firebaseApp);
        
        // Export Firebase functions to global scope
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.orderBy = orderBy;
        window.query = query;
        window.serverTimestamp = serverTimestamp;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.where = where;
        window.limit = limit;
        window.ref = ref;
        window.uploadString = uploadString;
        window.getDownloadURL = getDownloadURL;
        window.deleteObject = deleteObject;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            animation: gradientShift 8s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
            50% { background: linear-gradient(135deg, #764ba2 0%, #f093fb 50%, #667eea 100%); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .pulse-button {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .hamburger {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            padding: 4px;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: white;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }
        
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
            z-index: 1000;
            padding-top: 80px;
        }
        
        .mobile-menu.active {
            left: 0;
        }
        
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .camera-preview {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #000;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        .capture-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 4px solid #ccc;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .capture-btn:hover {
            transform: scale(1.1);
        }
        
        .post-animation {
            animation: postSlideIn 0.5s ease-out;
        }
        
        @keyframes postSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .location-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
        }
        
        .location-status.loading {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .location-status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }
        
        .location-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .camera-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .photo-preview-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .photo-preview-image {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Custom Scrollbar Styles */
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Image Modal Styles */
        .image-modal {
            backdrop-filter: blur(10px);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .image-modal-content {
            animation: imageZoomIn 0.4s ease-out;
        }
        
        @keyframes imageZoomIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Table Cell Text Truncation */
        .table-cell-truncate {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .table-cell-truncate:hover {
            overflow: visible;
            white-space: normal;
            word-break: break-word;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 8px;
            position: relative;
            z-index: 10;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .marquee-text {
            display: inline-block;
            min-width: 100%;
            animation: marquee 15s linear infinite;
            font-family: 'Pacifico', cursive;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        @media (max-width: 640px) {
            .marquee-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
        <div class="px-6 py-4">
            <div class="mb-8">
                <h1 class="text-white text-xl font-bold">PPSU-Pisbar-App</h1>
            </div>
            <nav class="space-y-2">
                <button onclick="navigateToPage('home')" class="nav-btn w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>üè†</span>
                    <span>Beranda</span>
                </button>
                <button onclick="navigateToPage('reports')" class="nav-btn w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>üìù</span>
                    <span>Laporan</span>
                </button>
                <button onclick="navigateToPage('feed')" class="nav-btn w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>üí¨</span>
                    <span>Feed</span>
                </button>
                <button onclick="navigateToPage('admin')" class="nav-btn w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>‚öôÔ∏è</span>
                    <span>Admin</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm">
        <span id="notificationText">Berhasil!</span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50" id="mainNav">
        <div class="max-w-screen-xl w-full mx-auto px-4 sm:px-6 py-4">
            <div class="flex flex-row justify-between items-center gap-4">
                <!-- Logo and Status -->
                <div class="flex items-center space-x-3">
                    <img src="logoppsu.jpeg" alt="Logo PPSU"
                         class="w-12 h-12 md:w-14 md:h-14 rounded-xl shadow-lg border border-white/20 object-cover bg-white/95"
                         style="min-width:48px;">
                    <h1 class="text-white text-xl md:text-2xl font-semibold tracking-tight ml-2">PPSU PISANGAN BARU</h1>
                    <div id="firebaseStatus"
                         class="hidden sm:block text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-300 border border-blue-500/30 ml-2">
                        üîÑ Connecting...
                    </div>
                </div>
                <!-- Desktop Navigation Menu -->
                <div class="hidden md:flex items-center space-x-2 mt-3 md:mt-0">
                    <button onclick="navigateToPage('home')" class="nav-desktop-btn px-5 py-3 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 text-base font-medium flex items-center space-x-2">
                        <span>üè†</span>
                        <span>Beranda</span>
                    </button>
                    <button onclick="navigateToPage('reports')" class="nav-desktop-btn px-5 py-3 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 text-base font-medium flex items-center space-x-2">
                        <span>üìù</span>
                        <span>Laporan</span>
                    </button>
                    <button onclick="navigateToPage('feed')" class="nav-desktop-btn px-5 py-3 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 text-base font-medium flex items-center space-x-2">
                        <span>üí¨</span>
                        <span>Feed</span>
                    </button>
                    <button onclick="navigateToPage('admin')" class="nav-desktop-btn px-5 py-3 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 text-base font-medium flex items-center space-x-2">
                        <span>‚öôÔ∏è</span>
                        <span>Admin</span>
                    </button>
                </div>
                <!-- Mobile Hamburger Menu -->
                 <div class="hamburger md:hidden" id="hamburgerMenu" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </nav>


    <div class="w-full overflow-hidden bg-gradient-to-r from-purple-500/30 via-pink-500/30 to-blue-500/30 py-2 mb-2">
        <div class="marquee-text text-white font-bold whitespace-nowrap">
            Bumi Itu Cuma Satu &nbsp; ‚Ä¢ &nbsp; Bukan Mantan yang bisa diganti &nbsp; ‚Ä¢ &nbsp; Kalo Bumi Rusak Gak Ada Mode Restart Bro &nbsp; ‚Ä¢ &nbsp;
        </div>
    </div>
    
    <!-- Home Page -->
    <div id="homePage" class="page fade-in">
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h2 class="text-lg md:text-xl font-bold text-white mb-3 leading-snug">
                    <span class="font-semibold tracking-normal">Selamat Datang di</span><br>
                    <span class="bg-gradient-to-r from-purple-300 via-pink-300 to-blue-300 bg-clip-text text-transparent font-black text-xl md:text-2xl tracking-tight">
                        PPSU-Pisbar-App V2.0
                    </span>
                </h2>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4 md:gap-6 max-w-5xl mx-auto">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 card-hover border border-white/20">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-lg md:text-xl">üìù</span>
                        </div>
                        <h3 class="text-white text-lg md:text-xl font-semibold mb-2">Input Laporan</h3>
                        <p class="text-white/70 mb-3 text-sm">Buat laporan kerja harian dengan mudah</p>
                        <button onclick="navigateToPage('reports')" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            Mulai Laporan
                        </button>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 card-hover border border-white/20">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-lg md:text-xl">üí¨</span>
                        </div>
                        <h3 class="text-white text-lg md:text-xl font-semibold mb-2">Feed Aktivitas</h3>
                        <p class="text-white/70 mb-3 text-sm">Lihat dan komentari aktivitas tim</p>
                        <button onclick="navigateToPage('feed')" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            Lihat Feed
                        </button>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 card-hover border border-white/20">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-lg md:text-xl">‚öôÔ∏è</span>
                        </div>
                        <h3 class="text-white text-lg md:text-xl font-semibold mb-2">Panel Admin</h3>
                        <p class="text-white/70 mb-3 text-sm">Kelola petugas dan rekap laporan</p>
                        <button onclick="navigateToPage('admin')" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            Masuk Admin
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Spreadsheet Links Section -->
            <div class="mt-12 max-w-6xl mx-auto">
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-2xl">üìä</span>
                        </div>
                        <h3 class="text-white text-xl md:text-2xl font-bold mb-2">Laporan Kepgub September 2025</h3>
                        <p class="text-white/70 text-sm">buat laporan bulanan per tim langsung ke spreadsheet</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="spreadsheetLinksContainer">
                        <!-- Links will be populated by JavaScript -->
                    </div>
                    
                    <div class="mt-6 text-center">
                        <p class="text-white/50 text-xs">
                          KELURAHAN PISANGAN BARU
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reportsPage" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-white mb-6 text-center">Input Laporan Kerja</h2>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20">
                    <form id="reportForm" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                                <input type="text" id="team" placeholder="Masukkan nama tim" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Shift Jam Kerja</label>
                                <input type="text" id="shift" placeholder="Masukkan shift jam kerja" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Nama Petugas Aktif</label>
                                <input type="text" id="activeOfficers" placeholder="Masukkan nama petugas aktif" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Nama Petugas Tidak Aktif <span class="text-white/50">(Opsional)</span></label>
                                <input type="text" id="inactiveOfficers" placeholder="Masukkan nama petugas tidak aktif (jika ada)" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Lokasi Kerja</label>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="location" placeholder="Klik 'Ambil Lokasi' atau ketik manual" class="flex-1 px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <button type="button" onclick="getLocationWithGoogleMaps()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm whitespace-nowrap">
                                     Ambil Lokasi 
                                </button>
                            </div>
                            <div id="locationStatus" class="location-status hidden">
                                <span id="locationStatusText">Mengambil lokasi...</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Foto Dokumentasi</label>
                            <div class="camera-container">
                                <!-- Live Camera Preview -->
                                <video id="cameraPreview" class="camera-preview hidden" autoplay playsinline muted></video>
                                
                                <!-- Camera Status Overlay -->
                                <div id="cameraStatus" class="camera-status hidden">
                                    <span id="cameraStatusText">üî¥ Kamera Live</span>
                                </div>
                                
                                <!-- Camera Controls Overlay -->
                                <!-- ...existing code... -->
                                <div id="cameraControls" class="camera-controls hidden">
                                <button type="button" onclick="capturePhotoAdvanced()" class="capture-btn bg-white hover:bg-gray-100 transition-all">
                                üì∏
                                </button>
                                <button type="button" onclick="switchCamera()" class="capture-btn bg-blue-500 hover:bg-blue-600 text-white transition-all">
                                üîÑ
                                </button>
                              <!-- Tambahkan tombol kamera depan -->
                              <button type="button" onclick="openFrontCamera()" class="capture-btn bg-indigo-500 hover:bg-indigo-600 text-white transition-all" title="Kamera Depan">
                              ü§≥
                            </button>
                            </div>
                                
                                <!-- Hidden Canvas for Processing -->
                                <canvas id="photoCanvas" class="hidden"></canvas>
                                
                                <!-- Photo Preview -->
                                <div id="photoPreview" class="photo-preview-container hidden">
                                    <img id="previewImage" class="photo-preview-image">
                                    <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-lg text-xs font-medium shadow-lg">
                                        ‚úÖ Foto Siap
                                    </div>
                                    <div class="absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs" id="photoInfo">
                                        üì∑ Resolusi: Loading...
                                    </div>
                                </div>
                                
                                <!-- Camera Controls -->
                                <div class="flex flex-col gap-3 mt-3">
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <button type="button" onclick="startCameraAdvanced()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium" id="startCameraBtn">
                                            üì∑ Buka Kamera Live
                                        </button>
                                        <button type="button" onclick="retakePhotoAdvanced()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium hidden" id="retakeBtn">
                                            üîÑ Foto Ulang
                                        </button>
                                        <button type="button" onclick="stopCameraAdvanced()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium hidden" id="stopCameraBtn">
                                            ‚èπÔ∏è Tutup Kamera
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Camera Tips -->
                                <div class="mt-2 text-white/60 text-xs space-y-1">
                                    <p>üí° <strong>Tips Foto Optimal:</strong> Pastikan pencahayaan cukup</p>
                                    <p>üì± Gunakan kamera belakang untuk dokumentasi lapangan</p>
                                    <p>üî•<strong>info:</strong> Tidak bisa upload file gunakan kamera)</p>
                                </div>
                            </div>
                        </div>
                        
                       <div>
                            <label class="block text-white font-medium mb-1 text-sm">Deskripsi Pengerjaan</label>
                            <textarea id="description" rows="3" placeholder="Jelaskan detail pekerjaan yang dilakukan..." class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition-all pulse-button text-sm">
                                üì§ Submit Laporan
                            </button>
                            <div class="mt-2 text-white/60 text-xs">
                                üõ°Ô∏è <strong>laporan cukup input sekali!</strong>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Feed Page -->
    <!-- Feed Page -->
    <div id="feedPage" class="page hidden">
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
            <!-- Feed Header -->
            <div class="sticky top-16 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm">
                <div class="max-w-2xl mx-auto px-4 sm:px-6 py-3">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 text-center">Feed Aktivitas</h2>
                </div>
            </div>
            
            <div class="max-w-2xl mx-auto px-4 sm:px-6 py-4 space-y-4">
                <!-- Create Post Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-4">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-semibold text-sm">üë§</span>
                            </div>
                            <button onclick="toggleCreatePost()" class="flex-1 bg-gray-100 hover:bg-gray-200 rounded-full px-4 py-2.5 text-left text-gray-600 transition-colors">
                                Apa yang ingin Anda bagikan?
                            </button>
                        </div>
                        
                        <!-- Expanded Create Post Form -->
                        <div id="createPostForm" class="hidden">
                            <form id="postForm" class="space-y-3">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <input type="text" id="postAuthor" placeholder="Nama Anda" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    <input type="text" id="postTeam" placeholder="Tim" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                </div>
                                
                                <textarea id="postContent" rows="3" placeholder="Bagikan informasi, pengumuman, atau update kegiatan..." class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm"></textarea>
                                
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="postLocation" placeholder="Lokasi (opsional)" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    <button type="button" onclick="getPostLocationWithGoogleMaps()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors text-sm whitespace-nowrap">
                                        üìç GPS
                                    </button>
                                </div>
                                
                                <div class="flex justify-between items-center pt-2">
                                    <div class="text-xs text-gray-500">
                                        üõ°Ô∏è Anti-duplikasi aktif
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="button" onclick="toggleCreatePost()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors text-sm">
                                            Batal
                                        </button>
                                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors text-sm font-medium">
                                            Posting
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Feed Container -->
                <div id="feedContainer" class="space-y-4">
                    <!-- Feed items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Login -->
    <div id="adminLoginPage" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-md mx-auto">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h2 class="text-xl font-bold text-white mb-4 text-center">Login Admin</h2>
                    
                    <form id="adminLoginForm" class="space-y-3">
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Username</label>
                            <input type="text" id="adminUsername" placeholder="Masukkan username" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Password</label>
                            <input type="password" id="adminPassword" placeholder="Masukkan password" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 rounded-lg font-semibold hover:shadow-lg transition-all text-sm">
                            üîê Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-white">Dashboard Admin</h2>
                <button onclick="logout()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                    üö™ Logout
                </button>
            </div>
            
            <!-- Filter & Stats Section -->
            <div class="mb-8 space-y-6">
                <!-- Advanced Filter Panel -->
                <div class="bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10 overflow-hidden shadow-xl">
                    <div class="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-purple-500/10 to-blue-500/10">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <span class="mr-3 text-xl">üîç</span>
                            <span>Filter & Rekap Data</span>
                            <span class="ml-auto text-sm text-white/60" id="filterStatus">Semua Data</span>
                        </h3>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <!-- Filter Petugas -->
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Filter Petugas</label>
                                <select id="filterOfficer" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                    <option value="">Semua Petugas</option>
                                </select>
                            </div>
                            
                            <!-- Filter Tim -->
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Filter Tim</label>
                                <select id="filterTeam" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                    <option value="">Semua Tim</option>
                                </select>
                            </div>
                            
                            <!-- Filter Periode -->
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Filter Periode</label>
                                <select id="filterPeriod" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                    <option value="">Semua Periode</option>
                                    <option value="today">Hari Ini</option>
                                    <option value="yesterday">Kemarin</option>
                                    <option value="week">7 Hari Terakhir</option>
                                    <option value="month">Bulan Ini</option>
                                    <option value="lastmonth">Bulan Lalu</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            
                            <!-- Filter Actions -->
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Aksi Filter</label>
                                <div class="flex space-x-2">
                                    <button onclick="applyFilters()" class="flex-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium">
                                        üîç Filter
                                    </button>
                                    <button onclick="resetFilters()" class="bg-gray-500/20 text-white px-4 py-2 rounded-lg hover:bg-gray-500/30 transition-all text-sm">
                                        üîÑ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Date Range (Hidden by default) -->
                        <div id="customDateRange" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-white/5 rounded-xl border border-white/10">
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Tanggal Mulai</label>
                                <input type="date" id="startDate" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Tanggal Akhir</label>
                                <input type="date" id="endDate" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        
                        <!-- Filter Results Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-xl p-4 border border-blue-500/20">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-300" id="filteredReports">0</div>
                                    <div class="text-white/70 text-sm">Laporan Filtered</div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-green-500/10 to-blue-500/10 rounded-xl p-4 border border-green-500/20">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-300" id="filteredPosts">0</div>
                                    <div class="text-white/70 text-sm">Post Filtered</div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-300" id="filteredOfficers">0</div>
                                    <div class="text-white/70 text-sm">Petugas Aktif</div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-orange-500/10 to-red-500/10 rounded-xl p-4 border border-orange-500/20">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-300" id="filteredTeams">0</div>
                                    <div class="text-white/70 text-sm">Tim Aktif</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Stats Cards -->
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-white" id="totalReports">0</div>
                            <div class="text-white/70">Total Laporan</div>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-white" id="todayReports">0</div>
                            <div class="text-white/70">Laporan Hari Ini</div>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-white" id="activeOfficersCount">0</div>
                            <div class="text-white/70">Petugas Aktif</div>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-white" id="totalPosts">0</div>
                            <div class="text-white/70">Total Postingan</div>
                        </div>
                    </div>
                </div>
            </div>
            

            
            <!-- Export Buttons -->
            <div class="mb-6 flex space-x-4">
                <button onclick="exportToExcel()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                    üìä Export Excel
                </button>
                <button onclick="exportToPDF()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors">
                    üìÑ Export PDF
                </button>
            </div>
            
            <!-- Management Tables -->
            <div class="space-y-8">
                <!-- Reports Management Table -->
                <div class="bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10 overflow-hidden shadow-xl">
                    <div class="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-blue-500/10 to-purple-500/10">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <span class="mr-3 text-xl">üìã</span>
                            <span>Laporan Kerja</span>
                            <span class="ml-auto text-sm text-white/60" id="reportsCount">0 laporan</span>
                        </h3>
                    </div>
                    
                    <div class="overflow-x-auto scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
                        <table class="w-full text-sm min-w-[800px]">
                            <thead class="bg-white/10 sticky top-0">
                                <tr>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[100px]">Tanggal</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[80px]">Tim</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[100px]">Shift</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[150px]">Petugas</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[200px]">Lokasi</th>
                                    <th class="text-center py-4 px-4 font-semibold text-white/90 min-w-[80px]">Foto</th>
                                    <th class="text-center py-4 px-4 font-semibold text-white/90 min-w-[120px]">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody" class="divide-y divide-white/5">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Feed Posts Management Table -->
                <div class="bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10 overflow-hidden shadow-xl">
                    <div class="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-green-500/10 to-blue-500/10">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <span class="mr-3 text-xl">üí¨</span>
                            <span>Postingan Feed</span>
                            <span class="ml-auto text-sm text-white/60" id="postsCount">0 postingan</span>
                        </h3>
                    </div>
                    
                    <div class="overflow-x-auto scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
                        <table class="w-full text-sm min-w-[700px]">
                            <thead class="bg-white/10 sticky top-0">
                                <tr>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[100px]">Tanggal</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[120px]">Penulis</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[80px]">Tim</th>
                                    <th class="text-left py-4 px-4 font-semibold text-white/90 min-w-[250px]">Konten</th>
                                    <th class="text-center py-4 px-4 font-semibold text-white/90 min-w-[80px]">Tipe</th>
                                    <th class="text-center py-4 px-4 font-semibold text-white/90 min-w-[120px]">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="feedTableBody" class="divide-y divide-white/5">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Spreadsheet Links Management -->
                <div class="bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10 overflow-hidden shadow-xl">
                    <div class="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-emerald-500/10 to-teal-500/10">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <span class="mr-3 text-xl">üìä</span>
                            <span>Kelola Link Spreadsheet</span>
                            <span class="ml-auto text-sm text-white/60">Laporan Kepgub</span>
                        </h3>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Form untuk mengedit link -->
                            <div class="space-y-4">
                                <h4 class="text-white font-semibold mb-4">‚úèÔ∏è Edit Link Tim</h4>
                                
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-white/80 text-sm font-medium mb-1">Pilih Tim</label>
                                        <select id="editTeamSelect" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                                            <option value="">-- Pilih Tim --</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-white/80 text-sm font-medium mb-1">Link Spreadsheet</label>
                                        <input type="url" id="editTeamLink" placeholder="https://bit.ly/..." class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button onclick="updateSpreadsheetLink()" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium">
                                            üíæ Update Link
                                        </button>
                                        <button onclick="testSpreadsheetLink()" class="bg-blue-500/20 text-blue-300 px-4 py-2 rounded-lg hover:bg-blue-500/30 transition-all text-sm">
                                            üîó Test
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preview link yang aktif -->
                            <div class="space-y-4">
                                <h4 class="text-white font-semibold mb-4">üìã Link Aktif Saat Ini</h4>
                                
                                <div class="bg-white/5 rounded-xl p-4 max-h-80 overflow-y-auto scrollbar-thin">
                                    <div id="currentLinksPreview" class="space-y-3">
                                        <!-- Current links will be populated here -->
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <button onclick="resetToDefaultLinks()" class="bg-orange-500/20 text-orange-300 px-4 py-2 rounded-lg hover:bg-orange-500/30 transition-all text-sm">
                                        üîÑ Reset Default
                                    </button>
                                    <button onclick="deleteAllLinks()" class="bg-red-500/20 text-red-300 px-4 py-2 rounded-lg hover:bg-red-500/30 transition-all text-sm">
                                        üóëÔ∏è Hapus Semua
                                    </button>
                                    <button onclick="exportSpreadsheetLinks()" class="bg-purple-500/20 text-purple-300 px-4 py-2 rounded-lg hover:bg-purple-500/30 transition-all text-sm">
                                        üì§ Export
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                            <div class="flex items-start space-x-3">
                                <span class="text-blue-300 text-lg">üí°</span>
                                <div class="text-blue-200 text-sm">
                                   <p class="font-medium mb-1">PPSU-PISBAR-App:</p>
                                    <ul class="space-y-1 text-blue-200/80">
                                        <li>‚Ä¢ @KELURAHAN PISANGAN BARU</li>
                                        
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Report Modal -->
    <div id="editReportModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">‚úèÔ∏è Edit Laporan</h3>
                <button onclick="closeEditModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
            </div>
            
            <form id="editReportForm" class="space-y-4">
                <input type="hidden" id="editReportId">
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                        <input type="text" id="editTeam" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Shift</label>
                        <input type="text" id="editShift" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Petugas Aktif</label>
                        <input type="text" id="editActiveOfficers" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Petugas Tidak Aktif</label>
                        <input type="text" id="editInactiveOfficers" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Lokasi</label>
                    <input type="text" id="editLocation" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Deskripsi</label>
                    <textarea id="editDescription" rows="3" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditModal()" class="px-6 py-2 bg-gray-500/20 text-white rounded-lg hover:bg-gray-500/30 transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg hover:shadow-lg transition-all">
                        üíæ Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">‚úèÔ∏è Edit Postingan</h3>
                <button onclick="closeEditPostModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
            </div>
            
            <form id="editPostForm" class="space-y-4">
                <input type="hidden" id="editPostId">
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Penulis</label>
                        <input type="text" id="editPostAuthor" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                        <input type="text" id="editPostTeam" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Konten</label>
                    <textarea id="editPostContent" rows="4" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Lokasi</label>
                    <input type="text" id="editPostLocation" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditPostModal()" class="px-6 py-2 bg-gray-500/20 text-white rounded-lg hover:bg-gray-500/30 transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg hover:shadow-lg transition-all">
                        üíæ Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let reports = [];
        let feedPosts = [];
        let filteredReports = [];
        let filteredPosts = [];
        let cameraStream = null;
        let capturedPhoto = null;
        let reportsListener = null;
        let feedListener = null;
        let availableCameras = [];
        let currentCameraIndex = 0;
        let spreadsheetLinks = {};
        let spreadsheetListener = null;
        let currentFilters = {
            officer: '',
            team: '',
            period: '',
            startDate: '',
            endDate: ''
        };
        
        // Default spreadsheet links
        const defaultSpreadsheetLinks = {
            'Tim Penyapuan': 'https://bit.ly/TimPenyapuanSeptemberLaporanKepgub',
            'Tim Saluran 1': 'https://bit.ly/TimSaluran1SeptemberLaporanKepgub',
            'Tim Saluran 2': 'https://bit.ly/TimSaluran2SeptemberLaporanKepgub',
            'Tim Saluran 3': 'https://bit.ly/TimSaluran3SeptemberLaporanKepgub',
            'Tim Saluran 4': 'https://bit.ly/TimSaluran4SeptemberLaporanKepgub',
            'Tim Taman': 'https://bit.ly/TimTamanSeptemberLaporanKepgub',
            'Tim Penataan': 'https://bit.ly/TimPenataanSeptemberLaporanKepgub',
            'Tim TRC': 'https://bit.ly/TimTRCseptemberLaporanKepgub',
            'Tim Zondal': 'https://bit.ly/TimZondalSeptemberLaporanKepgub'
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ PPSU-Pisbar-App Starting...');
            showPage('home');
            setupEventListeners();
            initializeSpreadsheetLinks();
            
            // Initialize Firebase
            setTimeout(() => {
                if (window.db) {
                    console.log(' Firebase SDK loaded successfully!');
                    testFirebaseConnection();
                    initializeFirebaseListeners();
                    showNotification('terhubung!.', 'success');
                } else {
                    console.log('‚ö†Ô∏è Firebase not ready, using fallback...');
                    initializeFallbackMode();
                }
            }, 1000);
            
            checkDeviceCapabilities();
            
            // Initialize FREE storage monitoring
            if (freeStorageMode) {
                setTimeout(() => {
                    startStorageMonitoring();
                    updateFreeStoragePanel();
                }, 2000);
            }
        });
        
        function initializeFallbackMode() {
            console.log('Initializing fallback mode...');
            reports = JSON.parse(localStorage.getItem('ppsu_reports') || '[]');
            feedPosts = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
            spreadsheetLinks = JSON.parse(localStorage.getItem('ppsu_spreadsheet_links') || JSON.stringify(defaultSpreadsheetLinks));
            
            // Initialize filtered data
            filteredReports = [...reports];
            filteredPosts = [...feedPosts];
            
            loadFeedPosts();
            updateAdminStats();
            updateReportsTable();
            updateFeedTable();
            updateCurrentLinksPreview();
            loadSpreadsheetLinks();
            initializeFilters();
            showNotification('üì± Mode offline aktif - data tersimpan lokal', 'info');
        }
        
        // Initialize spreadsheet links
        function initializeSpreadsheetLinks() {
            // Load from localStorage first
            spreadsheetLinks = JSON.parse(localStorage.getItem('ppsu_spreadsheet_links') || JSON.stringify(defaultSpreadsheetLinks));
            loadSpreadsheetLinks();
            populateTeamSelect();
        }
        
        // Navigation function
        function navigateToPage(pageId) {
            console.log('Navigate to page:', pageId);
            showPage(pageId);
            
            // Close mobile menu if open
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const hamburger = document.querySelector('.hamburger');
            
            if (mobileMenu && mobileMenu.classList.contains('active')) {
                mobileMenu.classList.remove('active');
                mobileOverlay.classList.remove('active');
                hamburger.classList.remove('active');
            }
        }
        
        // Check device capabilities
        async function checkDeviceCapabilities() {
            // Check camera
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log(`Found ${videoDevices.length} camera(s)`);
                    
                    if (videoDevices.length > 0) {
                        showNotification(`üì∑ ${videoDevices.length} kamera tersedia`, 'success');
                    }
                } catch (error) {
                    console.log('Camera check error:', error);
                }
            }
            
            // Check location
            if (navigator.geolocation) {
                console.log('Geolocation API tersedia');
                showNotification('üìç GPS tersedia', 'success');
            } else {
                showNotification('‚ö†Ô∏è GPS tidak tersedia di browser ini', 'info');
            }
        }
        
        // Firebase connection test
        async function testFirebaseConnection() {
            try {
                console.log('üîç Testing Firebase connection...');
                
                const testQuery = query(collection(window.db, 'reports'));
                const snapshot = await getDocs(testQuery);
                
                console.log(`‚úÖ Firestore READ successful! Found ${snapshot.size} existing reports`);
                
                const testDoc = {
                    test: true,
                    timestamp: serverTimestamp(),
                    message: 'Connection test successful',
                    testTime: new Date().toISOString()
                };
                
                const testRef = await addDoc(collection(window.db, 'connection_test'), testDoc);
                console.log('‚úÖ Firestore WRITE successful! Test doc ID:', testRef.id);
                
                await deleteDoc(doc(window.db, 'connection_test', testRef.id));
                console.log('‚úÖ Firestore cleanup successful');
                
                showNotification('üéâ Firebase FULLY CONNECTED!', 'success');
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('‚ùå Firebase connection failed:', error);
                showNotification(`‚ùå Firebase connection failed: ${error.message}`, 'error');
                updateConnectionStatus(false);
                initializeFallbackMode();
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('firebaseStatus');
            
            if (connected) {
                statusIndicator.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-300 border border-green-500/30';
                statusIndicator.innerHTML = 'üü¢ Aktif';
            } else {
                statusIndicator.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-300 border border-red-500/30';
                statusIndicator.innerHTML = 'üî¥ NonAktif';
            }
        }
        
        // FIREBASE FREE STORAGE SYSTEM - 100% Gratis Selamanya!
        let dailySummaryListener = null;
        let recentReportsListener = null;
        let recentFeedListener = null;
        let readOptimizationActive = true;
        let lastReadCount = 0;
        let freeStorageMode = true;
        let storageUsed = 0;
        let maxFreeStorage = 1024 * 1024; // 1MB limit for free tier
        
        // Initialize Firebase real-time listeners with READ OPTIMIZATION
        function initializeFirebaseListeners() {
            try {
                console.log('üîÑ Setting up OPTIMIZED Firebase listeners - Hemat Reads Mode!');
                
                if (readOptimizationActive) {
                    initializeOptimizedListeners();
                } else {
                    initializeStandardListeners();
                }
                
                // Spreadsheet links listener (unchanged - minimal reads)
                const spreadsheetDoc = doc(window.db, 'settings', 'spreadsheet_links');
                spreadsheetListener = onSnapshot(spreadsheetDoc, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        console.log('üìä Spreadsheet links updated from Firebase');
                        spreadsheetLinks = docSnapshot.data().links || defaultSpreadsheetLinks;
                    } else {
                        console.log('üìä No spreadsheet links in Firebase, using defaults');
                        spreadsheetLinks = defaultSpreadsheetLinks;
                        // Save defaults to Firebase
                        setDoc(spreadsheetDoc, { 
                            links: defaultSpreadsheetLinks,
                            updatedAt: serverTimestamp(),
                            updatedBy: 'system'
                        }).catch(console.error);
                    }
                    
                    loadSpreadsheetLinks();
                    updateCurrentLinksPreview();
                    localStorage.setItem('ppsu_spreadsheet_links', JSON.stringify(spreadsheetLinks));
                });
                
                console.log('üéØ OPTIMIZED Firebase listeners active - Read cost minimized!');
                
            } catch (error) {
                console.error('‚ùå Firebase listeners setup failed:', error);
                showNotification('‚ö†Ô∏è Real-time sync gagal. Menggunakan mode offline.', 'info');
                initializeFallbackMode();
            }
        }
        
        // OPTIMIZED LISTENERS - Hemat Reads hingga 95%!
        function initializeOptimizedListeners() {
            console.log(' Initializing READ-OPTIMIZED listeners...');
            
            // 1. DAILY SUMMARY LISTENER - Hanya 1 dokumen per hari!
            const today = new Date().toISOString().split('T')[0];
            const summaryDoc = doc(window.db, 'daily_summaries', today);
            
            dailySummaryListener = onSnapshot(summaryDoc, (docSnapshot) => {
                console.log('üìà Daily summary updated - 1 READ only!');
                
                if (docSnapshot.exists()) {
                    const summary = docSnapshot.data();
                    updateStatsFromSummary(summary);
                } else {
                    // Create initial summary if doesn't exist
                    createDailySummary(today);
                }
                
                lastReadCount += 1;
                updateReadCounter();
            });
            
            // 2. RECENT REPORTS LISTENER - Hanya 45 laporan terbaru untuk live feed
            const recentReportsQuery = query(
                collection(window.db, 'reports'), 
                orderBy('c', 'desc'),  // createdAt (shortened field)
                limit(45)  // LIMIT 45 - Hemat reads!
            );
            
            recentReportsListener = onSnapshot(recentReportsQuery, (snapshot) => {
                console.log(`üìä Recent reports updated: ${snapshot.size} documents (LIMITED)`);
                
                reports = [];
                snapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                
                updateReportsTable();
                lastReadCount += snapshot.size;
                updateReadCounter();
                console.log('‚úÖ Recent reports synchronized (READ OPTIMIZED)');
                
                // Initialize filters after data load
                initializeFilters();
                applyFilters();
            });
            
            // 3. RECENT FEED LISTENER - Hanya 45 post terbaru untuk feed
            const recentFeedQuery = query(
                collection(window.db, 'feed'), 
                orderBy('createdAt', 'desc'),
                limit(45)  // LIMIT 45 - Hemat reads!
            );
            
            recentFeedListener = onSnapshot(recentFeedQuery, (snapshot) => {
                console.log(`üí¨ Recent feed updated: ${snapshot.size} posts (LIMITED)`);
                
                feedPosts = [];
                snapshot.forEach((doc) => {
                    feedPosts.push({ id: doc.id, ...doc.data() });
                });
                
                loadFeedPosts();
                updateFeedTable();
                lastReadCount += snapshot.size;
                updateReadCounter();
                console.log('‚úÖ Recent feed synchronized (READ OPTIMIZED)');
                
                // Update filters after data load
                applyFilters();
            });
            
            // Update summary setiap 5 menit untuk akurasi data
            setInterval(() => {
                updateDailySummary();
            }, 5 * 60 * 1000); // 5 minutes
        }
        
        // STANDARD LISTENERS - Mode lama (boros reads)
        function initializeStandardListeners() {
            console.log('‚ö†Ô∏è Using STANDARD listeners - High read cost!');
            
            const reportsQuery = query(collection(window.db, 'reports'), orderBy('createdAt', 'desc'));
            reportsListener = onSnapshot(reportsQuery, (snapshot) => {
                console.log(`üìä ALL Reports updated: ${snapshot.size} documents`);
                
                reports = [];
                snapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                
                updateAdminStats();
                updateReportsTable();
                lastReadCount += snapshot.size;
                updateReadCounter();
                console.log('‚úÖ All reports synchronized (STANDARD MODE)');
            });
            
            const feedQuery = query(collection(window.db, 'feed'), orderBy('createdAt', 'desc'));
            feedListener = onSnapshot(feedQuery, (snapshot) => {
                console.log(`üí¨ ALL Feed updated: ${snapshot.size} posts`);
                
                feedPosts = [];
                snapshot.forEach((doc) => {
                    feedPosts.push({ id: doc.id, ...doc.data() });
                });
                
                loadFeedPosts();
                updateFeedTable();
                lastReadCount += snapshot.size;
                updateReadCounter();
                console.log('‚úÖ All feed synchronized (STANDARD MODE)');
            });
        }
        
        // CREATE DAILY SUMMARY DOCUMENT
        async function createDailySummary(dateString) {
            try {
                console.log(`üìä Creating daily summary for ${dateString}...`);
                
                const summaryData = {
                    date: dateString,
                    totalReports: 0,
                    totalPosts: 0,
                    activeTeams: [],
                    activeOfficers: [],
                    lastUpdated: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    optimizedReads: true
                };
                
                const summaryDoc = doc(window.db, 'daily_summaries', dateString);
                await setDoc(summaryDoc, summaryData);
                
                console.log('‚úÖ Daily summary created');
                
            } catch (error) {
                console.error('‚ùå Error creating daily summary:', error);
            }
        }
        
        // UPDATE DAILY SUMMARY - Dipanggil saat ada laporan/post baru
        async function updateDailySummary() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Count today's data efficiently
                const todayStart = new Date(today + 'T00:00:00.000Z');
                const todayEnd = new Date(today + 'T23:59:59.999Z');
                
                // Use aggregation queries to minimize reads
                const reportsQuery = query(
                    collection(window.db, 'reports'),
                    where('dt', '==', today)  // Use date field for efficient filtering
                );
                
                const feedQuery = query(
                    collection(window.db, 'feed'),
                    where('dt', '==', today)  // Use date field for efficient filtering
                );
                
                const [reportsSnapshot, feedSnapshot] = await Promise.all([
                    getDocs(reportsQuery),
                    getDocs(feedQuery)
                ]);
                
                const activeTeams = new Set();
                const activeOfficers = new Set();
                
                reportsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const team = data.t || data.team;
                    const officers = data.ao || data.activeOfficers;
                    
                    if (team) activeTeams.add(team);
                    if (officers) {
                        officers.split(',').forEach(officer => {
                            activeOfficers.add(officer.trim());
                        });
                    }
                });
                
                const summaryData = {
                    date: today,
                    totalReports: reportsSnapshot.size,
                    totalPosts: feedSnapshot.size,
                    activeTeams: Array.from(activeTeams),
                    activeOfficers: Array.from(activeOfficers),
                    lastUpdated: serverTimestamp(),
                    optimizedReads: true,
                    readsSaved: Math.max(0, (reportsSnapshot.size + feedSnapshot.size) - 35) // Estimate reads saved
                };
                
                const summaryDoc = doc(window.db, 'daily_summaries', today);
                await setDoc(summaryDoc, summaryData, { merge: true });
                
                console.log(`üìä Daily summary updated: ${summaryData.totalReports} reports, ${summaryData.totalPosts} posts`);
                
            } catch (error) {
                console.error('‚ùå Error updating daily summary:', error);
            }
        }
        
        // UPDATE STATS FROM SUMMARY - Hemat reads!
        function updateStatsFromSummary(summary) {
            console.log('üìà Updating stats from summary (READ OPTIMIZED)');
            
            document.getElementById('totalReports').textContent = reports.length || 0;
            document.getElementById('todayReports').textContent = summary.totalReports || 0;
            document.getElementById('activeOfficersCount').textContent = summary.activeOfficers?.length || 0;
            document.getElementById('totalPosts').textContent = feedPosts.length || 0;
            
            // Show optimization info
            const readsSaved = summary.readsSaved || 0;
            if (readsSaved > 0) {
                showNotification(` Hemat ${readsSaved} Firebase reads hari ini!`, 'success');
            }
        }
        
        // READ COUNTER - Monitor penggunaan reads
        function updateReadCounter() {
            const statusIndicator = document.getElementById('firebaseStatus');
            if (statusIndicator && readOptimizationActive) {
                statusIndicator.innerHTML = `üü¢ Optimized (${lastReadCount} reads)`;
                statusIndicator.title = `Firebase Read Optimization Active\nTotal reads today: ${lastReadCount}\nEstimated cost savings: 90-95%`;
            }
            
            // Update admin panel counters
            updateOptimizationPanel();
        }
        
        // UPDATE OPTIMIZATION PANEL - Show real-time stats
        function updateOptimizationPanel() {
            const currentReadsEl = document.getElementById('currentReads');
            const readsSavedEl = document.getElementById('readsSaved');
            const optimizationStatusEl = document.getElementById('optimizationStatus');
            const optimizationToggleEl = document.getElementById('optimizationToggle');
            
            if (currentReadsEl) currentReadsEl.textContent = lastReadCount;
            
            if (readOptimizationActive) {
                // Estimate reads without optimization (44 employees √ó 10 reports = 440+ reads)
                const estimatedWithoutOptimization = Math.max(440, reports.length + feedPosts.length);
                const readsSaved = Math.max(0, estimatedWithoutOptimization - lastReadCount);
                
                if (readsSavedEl) readsSavedEl.textContent = `Hemat ${readsSaved} reads`;
                if (optimizationStatusEl) {
                    optimizationStatusEl.textContent = 'ACTIVE';
                    optimizationStatusEl.className = 'ml-auto text-sm text-green-300';
                }
                if (optimizationToggleEl) {
                    optimizationToggleEl.innerHTML = 'üí∞ Mode: OPTIMIZED';
                    optimizationToggleEl.className = 'w-full bg-gradient-to-r from-green-500/20 to-blue-500/20 hover:from-green-500/30 hover:to-blue-500/30 text-green-300 px-4 py-2 rounded-lg transition-all text-sm font-medium border border-green-500/20';
                }
                
                // Update cost estimation
                updateCostEstimation(estimatedWithoutOptimization, lastReadCount);
                
            } else {
                if (readsSavedEl) readsSavedEl.textContent = 'Mode boros aktif';
                if (optimizationStatusEl) {
                    optimizationStatusEl.textContent = 'DISABLED';
                    optimizationStatusEl.className = 'ml-auto text-sm text-red-300';
                }
                if (optimizationToggleEl) {
                    optimizationToggleEl.innerHTML = '‚ö†Ô∏è Mode: STANDARD';
                    optimizationToggleEl.className = 'w-full bg-gradient-to-r from-red-500/20 to-orange-500/20 hover:from-red-500/30 hover:to-orange-500/30 text-red-300 px-4 py-2 rounded-lg transition-all text-sm font-medium border border-red-500/20';
                }
                
                // Update cost estimation
                updateCostEstimation(lastReadCount, 0);
            }
        }
        
        // UPDATE COST ESTIMATION - Calculate Firebase costs
        function updateCostEstimation(withoutOptimization, withOptimization) {
            // Firebase Firestore pricing: $0.06 per 100,000 reads
            const costPerRead = 0.06 / 100000;
            
            const costWithout = (withoutOptimization * costPerRead * 30).toFixed(4); // Monthly
            const costWith = (withOptimization * costPerRead * 30).toFixed(4); // Monthly
            const savings = (parseFloat(costWithout) - parseFloat(costWith)).toFixed(4);
            
            const costWithoutEl = document.getElementById('costWithoutOptimization');
            const costWithEl = document.getElementById('costWithOptimization');
            const costSavingsEl = document.getElementById('costSavings');
            
            if (costWithoutEl) costWithoutEl.textContent = `$${costWithout}`;
            if (costWithEl) costWithEl.textContent = `$${costWith}`;
            if (costSavingsEl) costSavingsEl.textContent = `$${savings}`;
        }
        
        // UPDATE DAILY SUMMARY AFTER SUBMIT - Increment counters tanpa read
        async function updateDailySummaryAfterSubmit(type, team, officers) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const summaryDoc = doc(window.db, 'daily_summaries', today);
                
                // Get current summary first (1 read only)
                const currentSummary = await getDocs(query(collection(window.db, 'daily_summaries'), where('date', '==', today)));
                
                let summaryData = {
                    date: today,
                    totalReports: 0,
                    totalPosts: 0,
                    activeTeams: [],
                    activeOfficers: [],
                    lastUpdated: serverTimestamp(),
                    optimizedReads: true
                };
                
                // Update existing summary if exists
                if (!currentSummary.empty) {
                    const existing = currentSummary.docs[0].data();
                    summaryData = {
                        ...existing,
                        lastUpdated: serverTimestamp()
                    };
                }
                
                // Increment counters
                if (type === 'report') {
                    summaryData.totalReports = (summaryData.totalReports || 0) + 1;
                } else if (type === 'post') {
                    summaryData.totalPosts = (summaryData.totalPosts || 0) + 1;
                }
                
                // Update active teams and officers
                const activeTeams = new Set(summaryData.activeTeams || []);
                const activeOfficers = new Set(summaryData.activeOfficers || []);
                
                if (team) activeTeams.add(team);
                if (officers) {
                    officers.split(',').forEach(officer => {
                        activeOfficers.add(officer.trim());
                    });
                }
                
                summaryData.activeTeams = Array.from(activeTeams);
                summaryData.activeOfficers = Array.from(activeOfficers);
                
                // Calculate reads saved
                summaryData.readsSaved = Math.max(0, (summaryData.totalReports + summaryData.totalPosts) - 90);
                
                await setDoc(summaryDoc, summaryData, { merge: true });
                
                console.log(`üìä Daily summary updated incrementally: +1 ${type}`);
                
            } catch (error) {
                console.error('‚ùå Error updating daily summary after submit:', error);
            }
        }
        
        // FREE STORAGE MONITORING & CLEANUP SYSTEM
        function toggleFreeStorageMode() {
            freeStorageMode = !freeStorageMode;
            
            if (freeStorageMode) {
                showNotification('üÜì Mode aktif - Storage unlimited dengan auto cleanup!', 'success');
                startStorageMonitoring();
            } else {
                showNotification('‚ö†Ô∏è Mode dinonaktifkan - Hati-hati dengan storage limit!', 'info');
                stopStorageMonitoring();
            }
            
            updateFreeStoragePanel();
        }
        
        // STORAGE MONITORING SYSTEM
        function startStorageMonitoring() {
            console.log('üîç Starting FREE storage monitoring...');
            
            // Monitor storage usage every 30 seconds
            setInterval(() => {
                calculateStorageUsage();
                updateStorageDisplay();
                
                // Auto cleanup if approaching limit
                if (storageUsed > maxFreeStorage * 0.8) { // 80% of 1GB
                    console.log('‚ö†Ô∏è Storage approaching limit, starting auto cleanup...');
                    performAutoCleanup();
                }
            }, 30000); // 30 seconds
            
            // Initial calculation
            calculateStorageUsage();
            updateStorageDisplay();
        }
        
        function stopStorageMonitoring() {
            console.log('‚èπÔ∏è Storage monitoring stopped');
        }
        
        // CALCULATE STORAGE USAGE
        async function calculateStorageUsage() {
            try {
                let totalSize = 0;
                
                // Calculate Firebase storage (estimate from data)
                reports.forEach(report => {
                    const photo = report.p || report.photo || '';
                    if (photo) {
                        totalSize += Math.round((photo.length * 0.75) / 1024); // Convert to KB
                    }
                    
                    // Add text data size (minimal)
                    const textData = JSON.stringify(report);
                    totalSize += Math.round(textData.length / 1024);
                });
                
                feedPosts.forEach(post => {
                    const photo = post.p || post.photo || '';
                    if (photo) {
                        totalSize += Math.round((photo.length * 0.75) / 1024);
                    }
                    
                    const textData = JSON.stringify(post);
                    totalSize += Math.round(textData.length / 1024);
                });
                
                // Add localStorage backup size
                const localReports = localStorage.getItem('ppsu_reports') || '[]';
                const localFeed = localStorage.getItem('ppsu_feed') || '[]';
                const localLinks = localStorage.getItem('ppsu_spreadsheet_links') || '{}';
                
                totalSize += Math.round((localReports.length + localFeed.length + localLinks.length) / 1024);
                
                storageUsed = totalSize * 1024; // Convert back to bytes for calculations
                
                console.log(`üìä Storage usage calculated: ${Math.round(totalSize)} KB`);
                
            } catch (error) {
                console.error('‚ùå Error calculating storage:', error);
            }
        }
        
        // UPDATE STORAGE DISPLAY
        function updateStorageDisplay() {
            const storageUsedEl = document.getElementById('storageUsed');
            const storageBarEl = document.getElementById('storageBar');
            const storagePercentEl = document.getElementById('storagePercent');
            
            const usedKB = Math.round(storageUsed / 1024);
            const usedMB = Math.round(storageUsed / (1024 * 1024));
            const maxGB = Math.round(maxFreeStorage / (1024 * 1024 * 1024));
            const percentage = Math.round((storageUsed / maxFreeStorage) * 100);
            
            if (storageUsedEl) {
                if (usedMB > 0) {
                    storageUsedEl.textContent = `${usedMB} MB`;
                } else {
                    storageUsedEl.textContent = `${usedKB} KB`;
                }
            }
            
            if (storageBarEl) {
                storageBarEl.style.width = `${Math.min(percentage, 100)}%`;
                
                // Change color based on usage
                if (percentage > 90) {
                    storageBarEl.className = 'bg-gradient-to-r from-red-500 to-pink-500 h-2 rounded-full transition-all';
                } else if (percentage > 70) {
                    storageBarEl.className = 'bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full transition-all';
                } else {
                    storageBarEl.className = 'bg-gradient-to-r from-emerald-500 to-cyan-500 h-2 rounded-full transition-all';
                }
            }
            
            if (storagePercentEl) {
                storagePercentEl.textContent = `${percentage}% dari ${maxGB}GB gratis`;
                
                if (percentage > 90) {
                    storagePercentEl.className = 'text-xs text-red-400 mt-1';
                } else if (percentage > 70) {
                    storagePercentEl.className = 'text-xs text-yellow-400 mt-1';
                } else {
                    storagePercentEl.className = 'text-xs text-emerald-400 mt-1';
                }
            }
            
            // Show warnings
            if (percentage > 90) {
                showNotification(' ', 'error');
            } else if (percentage > 80) {
                showNotification('‚ö†Ô∏è Storage mencapai 80%. Siap-siap auto cleanup...', 'info');
            }
        }
        
        // AUTO CLEANUP SYSTEM - Keep Firebase FREE forever!
        async function performAutoCleanup() {
            try {
                console.log('üßπ Starting AUTO CLEANUP ...');
                
                let cleanedSize = 0;
                let cleanedItems = 0;
                
                // 1. Clean old reports (keep only last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const oldReports = reports.filter(report => {
                    const reportDate = new Date(report.dt || report.date || report.c?.toDate?.() || report.createdAt?.toDate?.() || Date.now());
                    return reportDate < thirtyDaysAgo;
                });
                
                for (const report of oldReports) {
                    try {
                        await deleteDoc(doc(window.db, 'reports', report.id));
                        
                        // Calculate cleaned size
                        const photo = report.p || report.photo || '';
                        if (photo) {
                            cleanedSize += Math.round((photo.length * 0.75) / 1024);
                        }
                        cleanedItems++;
                        
                    } catch (error) {
                        console.log('Error deleting old report:', error);
                    }
                }
                
                // 2. Clean old feed posts (keep only last 30 days)
                const oldPosts = feedPosts.filter(post => {
                    const postDate = new Date(post.dt || post.date || post.createdAt?.toDate?.() || Date.now());
                    return postDate < thirtyDaysAgo;
                });
                
                for (const post of oldPosts) {
                    try {
                        await deleteDoc(doc(window.db, 'feed', post.id));
                        
                        const photo = post.p || post.photo || '';
                        if (photo) {
                            cleanedSize += Math.round((photo.length * 0.75) / 1024);
                        }
                        cleanedItems++;
                        
                    } catch (error) {
                        console.log('Error deleting old post:', error);
                    }
                }
                
                // 3. If still not enough, clean more aggressively (keep only last 7 days)
                if (storageUsed > maxFreeStorage * 0.7) {
                    console.log('üî• AGGRESSIVE CLEANUP - Keeping only last 7 days...');
                    
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    
                    const veryOldReports = reports.filter(report => {
                        const reportDate = new Date(report.dt || report.date || report.c?.toDate?.() || report.createdAt?.toDate?.() || Date.now());
                        return reportDate < sevenDaysAgo;
                    });
                    
                    for (const report of veryOldReports) {
                        try {
                            await deleteDoc(doc(window.db, 'reports', report.id));
                            cleanedItems++;
                        } catch (error) {
                            console.log('Error in aggressive cleanup:', error);
                        }
                    }
                }
                
                // 4. Clean localStorage backup
                  const localReports = JSON.parse(localStorage.getItem('ppsu_reports') || '[]');
                const recentLocalReports = localReports.filter(report => {
                    const reportDate = new Date(report.date);
                    return reportDate >= thirtyDaysAgo;
                });
                localStorage.setItem('ppsu_reports', JSON.stringify(recentLocalReports));

                const localFeed = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
                const recentLocalFeed = localFeed.filter(post => {
                    const postDate = new Date(post.date);
                    return postDate >= thirtyDaysAgo;
                });
                localStorage.setItem('ppsu_feed', JSON.stringify(recentLocalFeed));

                console.log(`‚úÖ AUTO CLEANUP completed: ${cleanedItems} items, ${cleanedSize}KB freed`);
                // Notifikasi hanya bila melewati cooldown
                const now = Date.now();
                if (cleanedItems > 0) {
                    if (now - lastAutoCleanupNotifyAt > AUTO_CLEANUP_NOTIFY_COOLDOWN_MS) {
                        showNotification(`üßπ Auto cleanup selesai: ${cleanedItems} item dihapus, ${cleanedSize}KB dibebaskan.`, 'success');
                        lastAutoCleanupNotifyAt = now;
                    } else {
                        console.log('Auto cleanup occurred but notification suppressed by cooldown.');
                    }
                } else {
                    console.log('Auto cleanup dijalankan: tidak ada item untuk dihapus.');
                }
                
                // Recalculate storage after cleanup
                setTimeout(() => {
                    calculateStorageUsage();
                    updateStorageDisplay();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error in auto cleanup:', error);
                showNotification('‚ùå Auto cleanup gagal, tapi aplikasi tetap berjalan', 'error');
            }
        }
        
        // UPDATE FREE STORAGE PANEL
        function updateFreeStoragePanel() {
            const freeStorageStatusEl = document.getElementById('freeStorageStatus');
            const freeStorageToggleEl = document.getElementById('freeStorageToggle');
            
            if (freeStorageMode) {
                if (freeStorageStatusEl) {
                    freeStorageStatusEl.textContent = 'ACTIVE';
                    freeStorageStatusEl.className = 'ml-auto text-sm text-emerald-300';
                }
                if (freeStorageToggleEl) {
                    freeStorageToggleEl.innerHTML = 'üÜì Mode: GRATIS';
                    freeStorageToggleEl.className = 'w-full bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 hover:from-emerald-500/30 hover:to-cyan-500/30 text-emerald-300 px-4 py-2 rounded-lg transition-all text-sm font-medium border border-emerald-500/20';
                }
            } else {
                if (freeStorageStatusEl) {
                    freeStorageStatusEl.textContent = 'DISABLED';
                    freeStorageStatusEl.className = 'ml-auto text-sm text-red-300';
                }
                if (freeStorageToggleEl) {
                    freeStorageToggleEl.innerHTML = '‚ö†Ô∏è Mode: BERBAYAR';
                    freeStorageToggleEl.className = 'w-full bg-gradient-to-r from-red-500/20 to-orange-500/20 hover:from-red-500/30 hover:to-orange-500/30 text-red-300 px-4 py-2 rounded-lg transition-all text-sm font-medium border border-red-500/20';
                }
            }
        }
        
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Report form submit
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitReport();
                });
            }
            
            // Post form submit
            const postForm = document.getElementById('postForm');
            if (postForm) {
                postForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitPost();
                });
            }
            
            // Admin login form
            const adminForm = document.getElementById('adminLoginForm');
            if (adminForm) {
                adminForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    adminLogin();
                });
            }
            
            // Edit report form
            const editReportForm = document.getElementById('editReportForm');
            if (editReportForm) {
                editReportForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveReportEdit();
                });
            }
            
            // Edit post form
            const editPostForm = document.getElementById('editPostForm');
            if (editPostForm) {
                editPostForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    savePostEdit();
                });
            }
        }
        
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const hamburger = document.querySelector('.hamburger');
            
            if (mobileMenu && mobileOverlay && hamburger) {
                mobileMenu.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                hamburger.classList.toggle('active');
            }
        }
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Update navigation style based on page
            const mainNav = document.getElementById('mainNav');
            if (pageId === 'feed') {
                mainNav.className = 'bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm sticky top-0 z-50';
                mainNav.querySelector('h1').className = 'text-gray-800 text-lg font-semibold tracking-tight';
                mainNav.querySelector('#firebaseStatus').className = 'hidden sm:block text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-600 border border-blue-500/30';
                
                // Update desktop navigation buttons for feed page
                const desktopBtns = mainNav.querySelectorAll('.nav-desktop-btn');
                desktopBtns.forEach(btn => {
                    btn.className = 'nav-desktop-btn px-4 py-2 rounded-lg text-gray-600 hover:text-gray-800 hover:bg-gray-100 transition-all duration-200 text-sm font-medium flex items-center space-x-2';
                });
                
                // Update hamburger color for feed page
                const hamburgerSpans = mainNav.querySelectorAll('.hamburger span');
                hamburgerSpans.forEach(span => {
                    span.style.background = '#374151'; // gray-700
                });
            } else {
                mainNav.className = 'bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50';
                mainNav.querySelector('h1').className = 'text-white text-lg font-semibold tracking-tight';
                mainNav.querySelector('#firebaseStatus').className = 'hidden sm:block text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-300 border border-blue-500/30';
                
                // Reset desktop navigation buttons
                const desktopBtns = mainNav.querySelectorAll('.nav-desktop-btn');
                desktopBtns.forEach(btn => {
                    btn.className = 'nav-desktop-btn px-4 py-2 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 text-sm font-medium flex items-center space-x-2';
                });
                
                // Reset hamburger color
                const hamburgerSpans = mainNav.querySelectorAll('.hamburger span');
                hamburgerSpans.forEach(span => {
                    span.style.background = 'white';
                });
            }
            
            // Show requested page
            if (pageId === 'admin') {
                if (currentUser && currentUser.role === 'admin') {
                    const adminDashboard = document.getElementById('adminDashboard');
                    if (adminDashboard) {
                        adminDashboard.classList.remove('hidden');
                        updateAdminStats();
                        initializeFilters();
                        updateReportsTable();
                        updateFeedTable();
                    }
                } else {
                    const adminLogin = document.getElementById('adminLoginPage');
                    if (adminLogin) {
                        adminLogin.classList.remove('hidden');
                    }
                }
            } else {
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }
            }
            
            // Add fade-in animation
            setTimeout(() => {
                const visiblePage = document.querySelector('.page:not(.hidden)');
                if (visiblePage) {
                    visiblePage.classList.add('fade-in');
                }
            }, 50);
        }
        
        // GOOGLE MAPS LOCATION FUNCTIONS
        async function getLocationWithGoogleMaps() {
            const locationInput = document.getElementById('location');
            const button = event.target;
            const statusDiv = document.getElementById('locationStatus');
            const statusText = document.getElementById('locationStatusText');
            
            button.innerHTML = '‚è≥ Mengambil...';
            button.disabled = true;
            statusDiv.className = 'location-status loading';
            statusDiv.classList.remove('hidden');
            statusText.textContent = 'üìç Mengambil lokasi GPS...';
            
            if (!navigator.geolocation) {
                locationInput.readOnly = false;
                locationInput.placeholder = 'GPS tidak tersedia - Masukkan lokasi manual';
                locationInput.focus();
                
                statusDiv.className = 'location-status error';
                statusText.textContent = '‚ùå GPS tidak tersedia - Input manual aktif';
                
                button.innerHTML = 'üìç Ambil Lokasi';
                button.disabled = false;
                
                showNotification('GPS tidak tersedia. Silakan input lokasi manual.', 'info');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                statusText.textContent = `üìç GPS ditemukan (akurasi: ${Math.round(accuracy)}m) - Mengambil alamat dari Google Maps...`;
                
                // Try Google Maps Geocoding first, then fallback to free services
                let address = await getAddressFromGoogleMaps(lat, lon);
                
                if (!address) {
                    statusText.textContent = `üìç Mencoba layanan alternatif...`;
                    address = await getAddressFromFreeService(lat, lon);
                }
                
                if (address) {
                    locationInput.value = address;
                    statusDiv.className = 'location-status success';
                    statusText.textContent = `‚úÖ Lokasi berhasil dari Google Maps (akurasi: ${Math.round(accuracy)}m)`;
                    showNotification(`üìç Lokasi berhasil diambil dari Google Maps! Akurasi ${Math.round(accuracy)}m`, 'success');
                } else {
                    locationInput.value = `Koordinat: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    statusDiv.className = 'location-status success';
                    statusText.textContent = `‚úÖ Koordinat GPS (akurasi: ${Math.round(accuracy)}m)`;
                    showNotification('Lokasi diambil dalam bentuk koordinat GPS', 'info');
                }
                
            } catch (error) {
                console.error('GPS location error:', error);
                
                let errorMessage = 'GPS tidak dapat diakses';
                if (error.code === 1) {
                    errorMessage = 'Izin GPS ditolak - Aktifkan di pengaturan browser';
                } else if (error.code === 2) {
                    errorMessage = 'Posisi tidak tersedia - Coba di area terbuka';
                } else if (error.code === 3) {
                    errorMessage = 'Timeout GPS - Sinyal lemah';
                }
                
                locationInput.readOnly = false;
                locationInput.placeholder = 'GPS gagal - Masukkan lokasi manual';
                locationInput.focus();
                
                statusDiv.className = 'location-status error';
                statusText.textContent = `‚ùå ${errorMessage}`;
                
                showNotification(`${errorMessage}. Input manual diaktifkan.`, 'info');
            }
            
            button.innerHTML = 'üìç Ambil Lokasi';
            button.disabled = false;
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Google Maps Geocoding API (requires API key)
        async function getAddressFromGoogleMaps(lat, lng) {
            // Note: Replace 'YOUR_API_KEY' with actual Google Maps API key
            // For demo purposes, we'll use the free services as primary
            // To use Google Maps: Get API key from Google Cloud Console
            const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY'; // Replace with your API key
            
            if (GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.log('Google Maps API key not configured, using free services');
                return null;
            }
            
            try {
                const response = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}&language=id&region=ID`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'OK' && data.results.length > 0) {
                        const result = data.results[0];
                        
                        // Extract detailed address components
                        const addressComponents = result.address_components;
                        let formattedAddress = '';
                        
                        // Build a clean address from components
                        const streetNumber = addressComponents.find(c => c.types.includes('street_number'))?.long_name || '';
                        const route = addressComponents.find(c => c.types.includes('route'))?.long_name || '';
                        const sublocality = addressComponents.find(c => c.types.includes('sublocality_level_1'))?.long_name || '';
                        const locality = addressComponents.find(c => c.types.includes('locality'))?.long_name || '';
                        const adminArea = addressComponents.find(c => c.types.includes('administrative_area_level_2'))?.long_name || '';
                        
                        if (streetNumber && route) {
                            formattedAddress = `${route} ${streetNumber}`;
                        } else if (route) {
                            formattedAddress = route;
                        }
                        
                        if (sublocality) {
                            formattedAddress += formattedAddress ? `, ${sublocality}` : sublocality;
                        }
                        
                        if (locality) {
                            formattedAddress += formattedAddress ? `, ${locality}` : locality;
                        }
                        
                        if (adminArea && adminArea !== locality) {
                            formattedAddress += formattedAddress ? `, ${adminArea}` : adminArea;
                        }
                        
                        return formattedAddress || result.formatted_address;
                    }
                }
            } catch (error) {
                console.log('Google Maps geocoding failed:', error);
            }
            
            return null;
        }
        
        async function getAddressFromFreeService(lat, lng) {
            const sources = [
                {
                    url: `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=id`,
                    parser: (data) => {
                        let addressParts = [];
                        if (data.locality) addressParts.push(data.locality);
                        if (data.city && data.city !== data.locality) addressParts.push(data.city);
                        if (data.principalSubdivision) addressParts.push(data.principalSubdivision);
                        if (data.countryName) addressParts.push(data.countryName);
                        return addressParts.length > 0 ? addressParts.join(', ') : null;
                    }
                },
                {
                    url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=id&addressdetails=1&zoom=18`,
                    parser: (data) => {
                        if (data.address) {
                            const addr = data.address;
                            let addressParts = [];
                            if (addr.road) addressParts.push(addr.road);
                            if (addr.neighbourhood) addressParts.push(addr.neighbourhood);
                            if (addr.suburb) addressParts.push(addr.suburb);
                            if (addr.city || addr.town) addressParts.push(addr.city || addr.town);
                            if (addr.state) addressParts.push(addr.state);
                            return addressParts.length > 0 ? addressParts.slice(0, 4).join(', ') : null;
                        }
                        return null;
                    }
                }
            ];
            
            for (const source of sources) {
                try {
                    const response = await fetch(source.url);
                    if (response.ok) {
                        const data = await response.json();
                        const address = source.parser(data);
                        if (address && address.length > 10) {
                            return address;
                        }
                    }
                } catch (error) {
                    console.log(`Geocoding source failed:`, error);
                    continue;
                }
            }
            
            return null;
        }
        
        async function getPostLocationWithGoogleMaps() {
            const locationInput = document.getElementById('postLocation');
            const button = event.target;
            
            button.innerHTML = '‚è≥ Mengambil...';
            button.disabled = true;
            
            if (!navigator.geolocation) {
                showNotification('GPS tidak tersedia. Input manual tersedia.', 'info');
                button.innerHTML = 'üìç Ambil Lokasi';
                button.disabled = false;
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                const address = await getAddressFromFreeService(lat, lon);
                
                if (address) {
                    locationInput.value = address;
                    showNotification(`üìç Lokasi berhasil diambil! Akurasi ${Math.round(accuracy)}m`, 'success');
                } else {
                    locationInput.value = `Koordinat: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    showNotification('Lokasi diambil dalam bentuk koordinat GPS', 'info');
                }
                
            } catch (error) {
                console.error('Post location error:', error);
                showNotification('GPS gagal. Silakan input lokasi manual.', 'info');
            }
            
            button.innerHTML = 'üìç Ambil Lokasi';
            button.disabled = false;
        }
        
        // CAMERA FUNCTIONS - OPTIMIZED FOR FIREBASE STORAGE
        async function startCameraAdvanced() {
            const video = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraStatusText');
            
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                await enumerateCameras();
                
                if (availableCameras.length === 0) {
                    throw new Error('Tidak ada kamera yang tersedia');
                }
                
                // OPTIMIZED: Lower resolution to save Firebase storage
                let constraints = {
                    video: {
                        width: { ideal: 800, max: 1024 },  // Reduced from 1280
                        height: { ideal: 600, max: 768 },  // Reduced from 720
                        facingMode: 'environment'
                    }
                };
                
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (backCameraError) {
                    constraints.video.facingMode = 'user';
                    try {
                        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (frontCameraError) {
                        if (availableCameras.length > 0) {
                            constraints.video = {
                                width: { ideal: 800, max: 1024 },
                                height: { ideal: 600, max: 768 },
                                deviceId: { exact: availableCameras[0].deviceId }
                            };
                            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                        } else {
                            throw frontCameraError;
                        }
                    }
                }
                
                video.srcObject = cameraStream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                video.classList.remove('hidden');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                cameraControls.classList.remove('hidden');
                statusDiv.classList.remove('hidden');
                
                const track = cameraStream.getVideoTracks()[0];
                const settings = track.getSettings();
                const label = track.label || 'Kamera';
                statusText.innerHTML = `üî¥ ${label} - ${settings.width}x${settings.height} (Optimized)`;
                
                showNotification(`üì∑ Kamera live aktif! ${label} (${settings.width}x${settings.height}) - Mode hemat storage`, 'success');
                
            } catch (error) {
                console.error('Camera error:', error);
                
                let errorMessage = 'Gagal mengakses kamera';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Izin kamera ditolak. Aktifkan di pengaturan browser.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'Kamera tidak ditemukan di perangkat ini.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Kamera sedang digunakan aplikasi lain.';
                }
                
                showNotification(errorMessage, 'error');
                
                statusDiv.classList.remove('hidden');
                statusText.innerHTML = '‚ùå Kamera Error';
            }
        }
        
        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                console.log(`Found ${availableCameras.length} camera(s):`, availableCameras);
            } catch (error) {
                console.error('Error enumerating cameras:', error);
                availableCameras = [];
            }
        }
        
        async function switchCamera() {
            if (availableCameras.length <= 1) {
                showNotification('Hanya ada satu kamera tersedia', 'info');
                return;
            }
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            await switchToCamera(currentCameraIndex);
        }
        
        async function switchToCamera(cameraIndex) {
            if (!availableCameras[cameraIndex]) return;
            
            const video = document.getElementById('cameraPreview');
            const statusText = document.getElementById('cameraStatusText');
            
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        deviceId: { exact: availableCameras[cameraIndex].deviceId }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                const track = cameraStream.getVideoTracks()[0];
                const settings = track.getSettings();
                const label = availableCameras[cameraIndex].label || `Kamera ${cameraIndex + 1}`;
                statusText.innerHTML = `üî¥ ${label} - ${settings.width}x${settings.height}`;
                
                currentCameraIndex = cameraIndex;
                
                showNotification(`üì∑ Beralih ke ${label}`, 'success');
                
            } catch (error) {
                console.error('Error switching camera:', error);
                showNotification('Gagal beralih kamera', 'error');
            }
        }

        // ...existing code...
        async function switchToFacingMode(facingMode = 'user') {
            const video = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraStatusText');

            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(t => t.stop());
                    cameraStream = null;
                }

                await enumerateCameras();

                let constraints = {
                    video: {
                        width: { ideal: 800, max: 1024 },
                        height: { ideal: 600, max: 768 },
                        facingMode: facingMode
                    }
                };

                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (err) {
                    // fallback: cari deviceId dengan label front/user
                    const target = availableCameras.find(dev => {
                        const lbl = (dev.label || '').toLowerCase();
                        if (facingMode === 'user') {
                            return lbl.includes('front') || lbl.includes('user') || lbl.includes('kamera depan') || lbl.includes('front camera');
                        } else {
                            return lbl.includes('back') || lbl.includes('rear') || lbl.includes('kamera belakang') || lbl.includes('back camera');
                        }
                    });

                    if (target) {
                        constraints.video = {
                            deviceId: { exact: target.deviceId },
                            width: { ideal: 800, max: 1024 },
                            height: { ideal: 600, max: 768 }
                        };
                        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                        const idx = availableCameras.findIndex(d => d.deviceId === target.deviceId);
                        if (idx >= 0) currentCameraIndex = idx;
                    } else {
                        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    }
                }

                video.srcObject = cameraStream;
                await new Promise(resolve => { video.onloadedmetadata = resolve; });

                video.classList.remove('hidden');
                startBtn && startBtn.classList.add('hidden');
                stopBtn && stopBtn.classList.remove('hidden');
                cameraControls && cameraControls.classList.remove('hidden');
                statusDiv && statusDiv.classList.remove('hidden');

                const track = cameraStream.getVideoTracks()[0];
                const settings = track.getSettings();
                const label = track.label || (facingMode === 'user' ? 'Kamera Depan' : 'Kamera Belakang');
                statusText.innerHTML = `üî¥ ${label} - ${settings.width || 'auto'}x${settings.height || 'auto'} (Facing: ${facingMode})`;

                showNotification(`üì∑ Kamera ${facingMode === 'user' ? 'depan' : 'belakang'} aktif`, 'success');

            } catch (error) {
                console.error('Error opening facing camera:', error);
                showNotification(`‚ùå Gagal membuka kamera ${facingMode === 'user' ? 'depan' : 'belakang'}`, 'error');
            }
        }

        function openFrontCamera() {
            switchToFacingMode('user');
        }
// ...existing code...
        
        function stopCameraAdvanced() {
            const video = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            cameraControls.classList.add('hidden');
            statusDiv.classList.add('hidden');
            
            showNotification('üì∑ Kamera ditutup', 'info');
        }
        
        function capturePhotoAdvanced() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const previewDiv = document.getElementById('photoPreview');
            const previewImg = document.getElementById('previewImage');
            const photoInfo = document.getElementById('photoInfo');
            const retakeBtn = document.getElementById('retakeBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            
            if (!video.videoWidth || !video.videoHeight) {
                showNotification('Kamera belum siap. Tunggu sebentar dan coba lagi.', 'error');
                return;
            }
            
            // Add capture animation effect
            video.style.filter = 'brightness(1.5)';
            setTimeout(() => {
                video.style.filter = 'none';
            }, 150);
            
            // FIREBASE OPTIMIZATION: Resize to maximum 800x600 for storage efficiency
            const maxWidth = 800;
            const maxHeight = 600;
            let { width, height } = video.getBoundingClientRect();
            
            // Calculate aspect ratio and resize
            const aspectRatio = video.videoWidth / video.videoHeight;
            if (video.videoWidth > maxWidth || video.videoHeight > maxHeight) {
                if (aspectRatio > 1) {
                    width = maxWidth;
                    height = maxWidth / aspectRatio;
                } else {
                    height = maxHeight;
                    width = maxHeight * aspectRatio;
                }
            } else {
                width = video.videoWidth;
                height = video.videoHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, width, height);
            
            // ULTRA COMPRESSION for FREE Firebase storage - Target: 50KB max!
            let quality = 0.4; // Start with very low quality for maximum compression
            let compressedPhoto = canvas.toDataURL('image/jpeg', quality);
            let fileSizeKB = Math.round((compressedPhoto.length * 0.75) / 1024);
            
            // AGGRESSIVE TARGET: Keep under 50KB for FREE tier efficiency!
            while (fileSizeKB > 50 && quality > 0.1) {
                quality -= 0.02;
                compressedPhoto = canvas.toDataURL('image/jpeg', quality);
                fileSizeKB = Math.round((compressedPhoto.length * 0.75) / 1024);
            }
            
            // If still too large, resize image further
            if (fileSizeKB > 50) {
                const newWidth = Math.floor(width * 0.8);
                const newHeight = Math.floor(height * 0.8);
                canvas.width = newWidth;
                canvas.height = newHeight;
                context.drawImage(video, 0, 0, newWidth, newHeight);
                
                quality = 0.3;
                compressedPhoto = canvas.toDataURL('image/jpeg', quality);
                fileSizeKB = Math.round((compressedPhoto.length * 0.75) / 1024);
                
                while (fileSizeKB > 50 && quality > 0.1) {
                    quality -= 0.02;
                    compressedPhoto = canvas.toDataURL('image/jpeg', quality);
                    fileSizeKB = Math.round((compressedPhoto.length * 0.75) / 1024);
                }
            }
            
            capturedPhoto = compressedPhoto;
            
            previewImg.src = capturedPhoto;
            photoInfo.innerHTML = `üì∑ ${Math.round(width)}x${Math.round(height)}px ‚Ä¢ ${fileSizeKB}KB ‚Ä¢ Q:${Math.round(quality * 100)}% ‚Ä¢ Firebase Optimized`;
            previewDiv.classList.remove('hidden');
            
            video.classList.add('hidden');
            retakeBtn.classList.remove('hidden');
            cameraControls.classList.add('hidden');
            statusDiv.classList.add('hidden');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            showNotification(`üì∏ Foto berhasil diambil! ${Math.round(width)}x${Math.round(height)}px (${fileSizeKB}KB) - Hemat Firebase!`, 'success');
        }
        
        function retakePhotoAdvanced() {
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            
            capturedPhoto = null;
            document.getElementById('photoInfo').innerHTML = 'üì∑ Resolusi: Loading...';
            
            showNotification('üîÑ Siap untuk foto ulang! Klik "Buka Kamera Live"', 'info');
        }
        
        async function submitReport() {
            const team = document.getElementById('team').value.trim();
            const shift = document.getElementById('shift').value.trim();
            const activeOfficers = document.getElementById('activeOfficers').value.trim();
            const inactiveOfficers = document.getElementById('inactiveOfficers').value.trim();
            const location = document.getElementById('location').value.trim();
            const description = document.getElementById('description').value.trim();
            const photo = capturedPhoto || '';
            
            if (!team || !shift || !activeOfficers || !location || !description) {
                showNotification('‚ùå Mohon lengkapi semua field wajib!', 'error');
                return;
            }
            
            if (!photo) {
                showNotification('üì∏ Foto dokumentasi WAJIB! Gunakan fitur "Buka Kamera Live".', 'error');
                return;
            }
            
            // DUPLICATE PREVENTION: Check for similar reports
            const isDuplicate = await checkForDuplicateReport(team, shift, activeOfficers, location, description);
            if (isDuplicate) {
                const confirmSubmit = confirm(
                    '‚ö†Ô∏è PERINGATAN DUPLIKASI!\n\n' +
                    'Ditemukan laporan serupa yang baru saja dikirim:\n' +
                    `‚Ä¢ Tim: ${team}\n` +
                    `‚Ä¢ Shift: ${shift}\n` +
                    `‚Ä¢ Petugas: ${activeOfficers}\n` +
                    `‚Ä¢ Lokasi: ${location}\n\n` +
                    'Apakah Anda yakin ingin mengirim laporan ini lagi?\n\n' +
                    'Klik OK untuk tetap kirim, atau Cancel untuk batalkan.'
                );
                
                if (!confirmSubmit) {
                    showNotification('üìã Pengiriman laporan dibatalkan untuk mencegah duplikasi', 'info');
                    return;
                }
            }
            
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Menyimpan ke Firebase...';
            submitBtn.disabled = true;
            
            // FIREBASE OPTIMIZATION: Minimal data structure to save storage
            const currentDate = new Date();
            const dateString = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
            const timeString = currentDate.toLocaleTimeString('id-ID', { hour12: false }); // HH:mm:ss format

            const formData = {
                // Core data only - optimized for Firebase
                t: team,                    // team (shortened field name)
                s: shift,                   // shift
                ao: activeOfficers,         // activeOfficers
                io: inactiveOfficers || '', // inactiveOfficers
                l: location,                // location
                p: photo,                   // photo (compressed)
                d: description,             // description
                c: serverTimestamp(),       // createdAt
                dt: dateString,             // date (short format)
                jam: timeString,            // waktu jam laporan (HH:mm:ss)
                st: 'ok',                   // status (shortened)
                by: activeOfficers.split(',')[0].trim(), // submittedBy
                sz: Math.round((photo.length * 0.75) / 1024) // photo size in KB
          };
            
            try {
                console.log('üì§ Submitting optimized report to Firebase...');
                console.log(`üìä Photo size: ${formData.sz}KB (Firebase optimized)`);
                
                const reportRef = await addDoc(collection(window.db, 'reports'), formData);
                console.log('‚úÖ Report saved with ID:', reportRef.id);
                
                // Create optimized feed post
                const feedPost = {
                    a: activeOfficers.split(',')[0].trim(), // author
                    t: team,                                 // team
                    c: `üìù Laporan Kerja: ${description.substring(0, 100)}${description.length > 100 ? '...' : ''}`, // content (truncated)
                    l: location,                            // location
                    p: photo,                               // photo
                    lk: 0,                                  // likes
                    cm: [],                                 // comments
                    tp: 'rpt',                              // type (shortened)
                    rid: reportRef.id,                      // reportId
                    createdAt: serverTimestamp(),           // createdAt (full name for compatibility)
                    dt: dateString                          // date
                };
                
                const feedRef = await addDoc(collection(window.db, 'feed'), feedPost);
                console.log('‚úÖ Optimized feed post created with ID:', feedRef.id);
                
                // UPDATE DAILY SUMMARY - Hemat reads dengan batch update
                await updateDailySummaryAfterSubmit('report', team, activeOfficers);
                
                resetReportForm();
                showNotification(`üéâ Laporan tersimpan! Foto ${formData.sz}KB (Ultra Compressed untuk FREE Firebase)`, 'success');
                
                // Update storage tracking
                if (freeStorageMode) {
                    setTimeout(() => {
                        calculateStorageUsage();
                        updateStorageDisplay();
                    }, 1000);
                }
                
                // Auto cleanup old data (keep last 100 reports per team)
                setTimeout(() => cleanupOldReports(team), 2000);
                
                setTimeout(() => {
                    showPage('feed');
                    showNotification('üí¨ Lihat laporan Anda di feed!', 'info');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Firebase save error:', error);
                showNotification(`‚ùå Gagal menyimpan ke Firebase: ${error.message}`, 'error');
                
                // Fallback to localStorage with original format for compatibility
                const localData = {
                    id: Date.now(),
                    team: team,
                    shift: shift,
                    activeOfficers: activeOfficers,
                    inactiveOfficers: inactiveOfficers,
                    location: location,
                    photo: photo,
                    description: description,
                    date: new Date().toISOString(),
                    status: 'completed',
                    submittedBy: activeOfficers.split(',')[0].trim(),
                    offline: true
                };
                
                let localReports = JSON.parse(localStorage.getItem('ppsu_reports') || '[]');
                localReports.push(localData);
                localStorage.setItem('ppsu_reports', JSON.stringify(localReports));
                
                resetReportForm();
                showNotification('üì± Laporan tersimpan offline.', 'info');
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        // DUPLICATE PREVENTION SYSTEM
        async function checkForDuplicateReport(team, shift, activeOfficers, location, description) {
            try {
                console.log('üîç Checking for duplicate reports...');
                
                // Check last 2 hours for potential duplicates
                const twoHoursAgo = new Date();
                twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);
                
                // Check Firebase reports
                if (window.db) {
                    const recentReportsQuery = query(
                        collection(window.db, 'reports'),
                        orderBy('c', 'desc')  // Order by createdAt
                    );
                    
                    const snapshot = await getDocs(recentReportsQuery);
                    
                    for (const doc of snapshot.docs) {
                        const report = doc.data();
                        const reportDate = report.c?.toDate?.() || new Date(report.dt || report.date);
                        
                        // Only check reports from last 2 hours
                        if (reportDate < twoHoursAgo) continue;
                        
                        // Check for exact matches
                        const reportTeam = report.t || report.team || '';
                        const reportShift = report.s || report.shift || '';
                        const reportOfficers = report.ao || report.activeOfficers || '';
                        const reportLocation = report.l || report.location || '';
                        const reportDescription = report.d || report.description || '';
                        
                        // Exact match detection
                        if (reportTeam.toLowerCase() === team.toLowerCase() &&
                            reportShift.toLowerCase() === shift.toLowerCase() &&
                            reportOfficers.toLowerCase() === activeOfficers.toLowerCase() &&
                            reportLocation.toLowerCase() === location.toLowerCase()) {
                            
                            console.log('üö® Exact duplicate found!');
                            return true;
                        }
                        
                        // Similar content detection (80% similarity)
                        const similarity = calculateSimilarity(reportDescription, description);
                        if (similarity > 0.8 && 
                            reportTeam.toLowerCase() === team.toLowerCase() &&
                            reportShift.toLowerCase() === shift.toLowerCase()) {
                            
                            console.log(`üö® Similar report found! Similarity: ${Math.round(similarity * 100)}%`);
                            return true;
                        }
                    }
                }
                
                // Fallback: Check localStorage for offline mode
                const localReports = JSON.parse(localStorage.getItem('ppsu_reports') || '[]');
                for (const report of localReports) {
                    const reportDate = new Date(report.date);
                    
                    // Only check reports from last 2 hours
                    if (reportDate < twoHoursAgo) continue;
                    
                    // Check for exact matches
                    if (report.team?.toLowerCase() === team.toLowerCase() &&
                        report.shift?.toLowerCase() === shift.toLowerCase() &&
                        report.activeOfficers?.toLowerCase() === activeOfficers.toLowerCase() &&
                        report.location?.toLowerCase() === location.toLowerCase()) {
                        
                        console.log('üö® Local duplicate found!');
                        return true;
                    }
                }
                
                console.log('‚úÖ No duplicates found');
                return false;
                
            } catch (error) {
                console.error('‚ùå Error checking duplicates:', error);
                // If error occurs, don't block submission
                return false;
            }
        }
        
        // Calculate text similarity using Levenshtein distance
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer.toLowerCase(), shorter.toLowerCase());
            return (longer.length - distance) / longer.length;
        }
        
        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // DUPLICATE PREVENTION FOR POSTS
        async function checkForDuplicatePost(author, team, content) {
            try {
                console.log('üîç Checking for duplicate posts...');
                
                // Check last 1 hour for potential duplicate posts
                const oneHourAgo = new Date();
                oneHourAgo.setHours(oneHourAgo.getHours() - 1);
                
                // Check Firebase posts
                if (window.db) {
                    const recentPostsQuery = query(
                        collection(window.db, 'feed'),
                        orderBy('createdAt', 'desc')
                    );
                    
                    const snapshot = await getDocs(recentPostsQuery);
                    
                    for (const doc of snapshot.docs) {
                        const post = doc.data();
                        const postDate = post.createdAt?.toDate?.() || new Date(post.date);
                        
                        // Only check posts from last 1 hour
                        if (postDate < oneHourAgo) continue;
                        
                        // Check for exact matches
                        const postAuthor = post.author || post.a || '';
                        const postTeam = post.team || post.t || '';
                        const postContent = post.content || post.c || '';
                        
                        // Exact match detection
                        if (postAuthor.toLowerCase() === author.toLowerCase() &&
                            postTeam.toLowerCase() === team.toLowerCase() &&
                            postContent.toLowerCase() === content.toLowerCase()) {
                            
                            console.log('üö® Exact duplicate post found!');
                            return true;
                        }
                        
                        // Similar content detection (85% similarity for posts)
                        const similarity = calculateSimilarity(postContent, content);
                        if (similarity > 0.85 && 
                            postAuthor.toLowerCase() === author.toLowerCase() &&
                            postTeam.toLowerCase() === team.toLowerCase()) {
                            
                            console.log(`üö® Similar post found! Similarity: ${Math.round(similarity * 100)}%`);
                            return true;
                        }
                    }
                }
                
                // Fallback: Check localStorage for offline mode
                const localPosts = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
                for (const post of localPosts) {
                    const postDate = new Date(post.date);
                    
                    // Only check posts from last 1 hour
                    if (postDate < oneHourAgo) continue;
                    
                    // Check for exact matches
                    if (post.author?.toLowerCase() === author.toLowerCase() &&
                        post.team?.toLowerCase() === team.toLowerCase() &&
                        post.content?.toLowerCase() === content.toLowerCase()) {
                        
                        console.log('üö® Local duplicate post found!');
                        return true;
                    }
                }
                
                console.log('‚úÖ No duplicate posts found');
                return false;
                
            } catch (error) {
                console.error('‚ùå Error checking duplicate posts:', error);
                // If error occurs, don't block submission
                return false;
            }
        }
        
        // Firebase cleanup function to prevent storage bloat
        async function cleanupOldReports(currentTeam) {
            try {
                console.log(`üßπ Checking for cleanup of old reports for team: ${currentTeam}`);
                
                const reportsQuery = query(
                    collection(window.db, 'reports'), 
                    orderBy('c', 'desc')  // Order by createdAt (shortened field)
                );
                
                const snapshot = await getDocs(reportsQuery);
                const teamReports = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if ((data.t || data.team) === currentTeam) {  // Support both old and new format
                        teamReports.push({ id: doc.id, ...data });
                    }
                });
                
                // Keep only last 50 reports per team to save Firebase storage
                if (teamReports.length > 50) {
                    const reportsToDelete = teamReports.slice(50);
                    console.log(`üóëÔ∏è Cleaning up ${reportsToDelete.length} old reports for team ${currentTeam}`);
                    
                    for (const report of reportsToDelete) {
                        await deleteDoc(doc(window.db, 'reports', report.id));
                    }
                    
                    showNotification(`üßπ Cleaned up ${reportsToDelete.length} old reports to save Firebase storage`, 'info');
                }
                
            } catch (error) {
                console.log('Cleanup error (non-critical):', error);
            }
        }
        
        function resetReportForm() {
            document.getElementById('reportForm').reset();
            
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            capturedPhoto = null;
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('cameraControls').classList.add('hidden');
            document.getElementById('cameraStatus').classList.add('hidden');
            document.getElementById('stopCameraBtn').classList.add('hidden');
            document.getElementById('locationStatus').classList.add('hidden');
        }
        
        async function submitPost() {
            const author = document.getElementById('postAuthor').value.trim();
            const team = document.getElementById('postTeam').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const location = document.getElementById('postLocation').value.trim();
            
            if (!author || !team || !content) {
                showNotification('‚ùå Mohon lengkapi nama penulis, tim, dan konten postingan!', 'error');
                return;
            }
            
            // DUPLICATE PREVENTION: Check for similar posts
            const isDuplicatePost = await checkForDuplicatePost(author, team, content);
            if (isDuplicatePost) {
                const confirmSubmit = confirm(
                    '‚ö†Ô∏è PERINGATAN DUPLIKASI POSTINGAN!\n\n' +
                    'Ditemukan postingan serupa yang baru saja dikirim:\n' +
                    `‚Ä¢ Penulis: ${author}\n` +
                    `‚Ä¢ Tim: ${team}\n` +
                    `‚Ä¢ Konten: ${content.substring(0, 100)}${content.length > 100 ? '...' : ''}\n\n` +
                    'Apakah Anda yakin ingin mengirim postingan ini lagi?\n\n' +
                    'Klik OK untuk tetap kirim, atau Cancel untuk batalkan.'
                );
                
                if (!confirmSubmit) {
                    showNotification('üìã Pengiriman postingan dibatalkan untuk mencegah duplikasi', 'info');
                    return;
                }
            }
            
            const submitBtn = document.querySelector('#postForm button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Posting ke Firebase...';
            submitBtn.disabled = true;
            
            const postData = {
                author: author,
                team: team,
                content: content,
                location: location,
                likes: 0,
                comments: [],
                type: 'post',
                createdAt: serverTimestamp(),
                date: new Date().toISOString()
            };
            
            try {
                console.log('üì§ Submitting post to Firebase...');
                
                // Add date field for efficient querying
                postData.dt = new Date().toISOString().split('T')[0];
                
                const postRef = await addDoc(collection(window.db, 'feed'), postData);
                console.log('‚úÖ Post saved with ID:', postRef.id);
                
                // UPDATE DAILY SUMMARY - Hemat reads dengan batch update
                await updateDailySummaryAfterSubmit('post', team, author);
                
                document.getElementById('postForm').reset();
                toggleCreatePost(); // Hide the form after successful submission
                showNotification('üéâ Postingan berhasil dipublikasi di Firebase! (Mode FREE aktif)', 'success');
                
                // Update storage tracking
                if (freeStorageMode) {
                    setTimeout(() => {
                        calculateStorageUsage();
                        updateStorageDisplay();
                    }, 1000);
                }
                
                setTimeout(() => {
                    document.getElementById('feedContainer').scrollIntoView({ behavior: 'smooth' });
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Firebase post error:', error);
                showNotification(`‚ùå Gagal posting ke Firebase: ${error.message}`, 'error');
                
                // Fallback to localStorage
                const localPost = {
                    id: Date.now(),
                    ...postData,
                    date: new Date().toISOString(),
                    offline: true
                };
                
                let localFeed = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
                localFeed.unshift(localPost);
                localStorage.setItem('ppsu_feed', JSON.stringify(localFeed));
                
                document.getElementById('postForm').reset();
                toggleCreatePost(); // Hide the form after successful submission
                showNotification('üì± Postingan tersimpan offline.', 'info');
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        function loadFeedPosts() {
            const feedContainer = document.getElementById('feedContainer');
            
            if (feedPosts.length === 0) {
                feedContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                        <div class="text-4xl mb-4">üì≠</div>
                        <p class="text-gray-600">Belum ada postingan. Buat postingan pertama Anda!</p>
                    </div>
                `;
                return;
            }
            
            feedContainer.innerHTML = feedPosts.map(post => {
                const date = new Date(post.date || post.createdAt?.toDate?.() || Date.now());
                const timeAgo = getTimeAgo(date);
                const author = post.author || post.a || 'Unknown';
                const team = post.team || post.t || '';
                const content = post.content || post.c || '';
                const location = post.location || post.l || '';
                const photo = post.photo || post.p || '';
                
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 post-animation">
                        <!-- Post Header -->
                        <div class="p-4 pb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-white font-semibold text-sm">${author.charAt(0).toUpperCase()}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-1">
                                        <h4 class="font-semibold text-gray-900 text-sm truncate">${author}</h4>
                                        ${team ? `<span class="text-gray-500 text-sm">‚Ä¢ ${team}</span>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-1 text-xs text-gray-500">
                                        <span>${timeAgo}</span>
                                        ${post.type === 'report' ? '<span class="text-blue-600">‚Ä¢ üìù Laporan</span>' : '<span class="text-green-600">‚Ä¢ üì¢ Post</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Post Content -->
                        <div class="px-4 pb-3">
                            <p class="text-gray-800 text-sm leading-relaxed">${content}</p>
                            
                            ${location ? `
                                <div class="flex items-center text-gray-600 text-xs mt-2">
                                    <span class="mr-1">üìç</span>
                                    <span class="truncate">${location}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Post Photo -->
                        ${photo ? `
                            <div class="px-4 pb-3">
                                <img src="${photo}" alt="Post photo" class="w-full max-w-sm mx-auto rounded-lg cursor-pointer hover:opacity-95 transition-opacity" onclick="openImageModal('${photo}')">
                            </div>
                        ` : ''}
                        
                        <!-- Post Actions -->
                        <div class="px-4 py-3 border-t border-gray-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-6">
                                    <button onclick="likePost('${post.id}')" class="flex items-center space-x-1 text-gray-600 hover:text-blue-600 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L9 7v13m-3-4h-2m-2-2h2m0 0V9a2 2 0 012-2h2"></path>
                                        </svg>
                                        <span class="text-sm">${post.likes || 0}</span>
                                    </button>
                                    <button onclick="toggleComments('${post.id}')" class="flex items-center space-x-1 text-gray-600 hover:text-blue-600 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                        <span class="text-sm">${post.comments?.length || 0}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div id="comments-${post.id}" class="hidden border-t border-gray-100">
                            ${(post.comments || []).length > 0 ? `
                                <div class="px-4 py-3 space-y-3 max-h-60 overflow-y-auto">
                                    ${(post.comments || []).map(comment => `
                                        <div class="flex space-x-2">
                                            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                                <span class="text-gray-600 font-medium text-xs">${comment.author.charAt(0).toUpperCase()}</span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="bg-gray-100 rounded-2xl px-3 py-2">
                                                    <div class="font-medium text-sm text-gray-900">${comment.author}</div>
                                                    <p class="text-sm text-gray-800">${comment.content}</p>
                                                </div>
                                                <div class="text-xs text-gray-500 mt-1 ml-3">${getTimeAgo(new Date(comment.date))}</div>
                                                <div class="text-xs text-gray-500 mt-1 ml-3">${getTimeAgo(new Date(comment.date))}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <!-- Add Comment -->
                            <div class="px-4 py-3 border-t border-gray-100">
                                <div class="flex space-x-2">
                                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-gray-600 font-medium text-xs">üë§</span>
                                    </div>
                                    <div class="flex-1 flex space-x-2">
                                        <input type="text" id="comment-input-${post.id}" placeholder="Tulis komentar..." class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white border border-transparent focus:border-blue-500">
                                        <button onclick="addComment('${post.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full transition-colors text-sm font-medium">
                                            Kirim
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Baru saja';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} menit lalu`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} jam lalu`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} hari lalu`;
            
            return date.toLocaleDateString('id-ID');
        }
        
        async function likePost(postId) {
            try {
                const postRef = doc(window.db, 'feed', postId);
                const post = feedPosts.find(p => p.id === postId);
                
                if (post) {
                    const newLikeCount = (post.likes || 0) + 1;
                    
                    await updateDoc(postRef, {
                        likes: newLikeCount,
                        lastLiked: serverTimestamp()
                    });
                    
                    showNotification(`üëç Like ditambahkan! Total: ${newLikeCount}`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error liking post:', error);
                showNotification('‚ùå Gagal menambah like', 'error');
            }
        }
        
        function toggleComments(postId) {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.classList.toggle('hidden');
        }
        
        async function addComment(postId) {
            const commentInput = document.getElementById(`comment-input-${postId}`);
            const content = commentInput.value.trim();
            
            if (!content) {
                showNotification('‚ùå Tulis komentar terlebih dahulu!', 'error');
                return;
            }
            
            const comment = {
                author: 'Petugas PPSU',
                content: content,
                date: new Date().toISOString(),
                timestamp: serverTimestamp()
            };
            
            try {
                const postRef = doc(window.db, 'feed', postId);
                const post = feedPosts.find(p => p.id === postId);
                
                if (post) {
                    const updatedComments = [...(post.comments || []), comment];
                    
                    await updateDoc(postRef, {
                        comments: updatedComments,
                        lastCommented: serverTimestamp()
                    });
                    
                    commentInput.value = '';
                    showNotification(`üí¨ Komentar ditambahkan! Total: ${updatedComments.length}`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error adding comment:', error);
                showNotification('‚ùå Gagal menambah komentar', 'error');
            }
        }
        
        function openImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/95 image-modal flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.animation = 'modalFadeOut 0.3s ease-in forwards';
                    setTimeout(() => modal.remove(), 300);
                }
            };
            
            // Add fade out animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes modalFadeOut {
                    from { opacity: 1; transform: scale(1); }
                    to { opacity: 0; transform: scale(0.9); }
                }
            `;
            document.head.appendChild(style);
            
            modal.innerHTML = `
                <div class="image-modal-content max-w-6xl max-h-full flex flex-col items-center">
                    <!-- Image Container -->
                    <div class="relative bg-white/5 backdrop-blur-sm rounded-2xl p-4 shadow-2xl border border-white/10">
                        <img src="${imageSrc}" alt="Full size image" class="max-w-full max-h-[80vh] object-contain rounded-xl shadow-lg">
                        
                        <!-- Image Info Overlay -->
                        <div class="absolute top-2 left-2 bg-black/70 text-white px-3 py-1 rounded-lg text-xs font-medium">
                            üì∑ Foto Dokumentasi PPSU
                        </div>
                        
                        <!-- Close Button -->
                        <button onclick="closeImageModal(this)" class="absolute top-2 right-2 w-10 h-10 bg-black/70 hover:bg-black/90 text-white rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110">
                            <span class="text-lg">‚úï</span>
                        </button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
                        <button onclick="downloadImage('${imageSrc}')" class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:scale-105 shadow-lg">
                            üì• Download Foto
                        </button>
                        <button onclick="shareImage('${imageSrc}')" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:scale-105 shadow-lg">
                            üì§ Share
                        </button>
                        <button onclick="closeImageModal(this)" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:scale-105 backdrop-blur-sm border border-white/20">
                            ‚úï Tutup
                        </button>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mt-4 text-center text-white/60 text-sm">
                        <p>üí° Klik di luar gambar atau tombol ‚úï untuk menutup</p>
                        <p>üñ±Ô∏è Scroll untuk zoom pada perangkat mobile</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add keyboard support
            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    closeImageModal();
                    document.removeEventListener('keydown', handleKeyPress);
                }
            };
            document.addEventListener('keydown', handleKeyPress);
        }
        
        function closeImageModal(button) {
            const modal = button ? button.closest('.image-modal') : document.querySelector('.image-modal');
            if (modal) {
                modal.style.animation = 'modalFadeOut 0.3s ease-in forwards';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        function shareImage(imageSrc) {
            if (navigator.share) {
                // Convert data URL to blob for sharing
                fetch(imageSrc)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], `PPSU-Photo-${Date.now()}.jpg`, { type: 'image/jpeg' });
                        navigator.share({
                            title: 'Foto Dokumentasi PPSU',
                            text: 'Foto dokumentasi kegiatan PPSU Pisbar',
                            files: [file]
                        });
                    })
                    .catch(() => {
                        // Fallback: copy to clipboard
                        navigator.clipboard.writeText(imageSrc).then(() => {
                            showNotification('üìã Link foto disalin ke clipboard!', 'success');
                        });
                    });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(imageSrc).then(() => {
                    showNotification('üìã Link foto disalin ke clipboard!', 'success');
                }).catch(() => {
                    showNotification('‚ùå Fitur share tidak didukung browser ini', 'error');
                });
            }
        }
        
        function downloadImage(imageSrc) {
            try {
                const link = document.createElement('a');
                link.href = imageSrc;
                link.download = `PPSU-Photo-${new Date().toISOString().split('T')[0]}-${Date.now()}.jpg`;
                
                // For data URLs, we need to handle differently
                if (imageSrc.startsWith('data:')) {
                    link.click();
                } else {
                    // For external URLs, we might need to fetch and convert
                    fetch(imageSrc)
                        .then(response => response.blob())
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            link.href = url;
                            link.click();
                            window.URL.revokeObjectURL(url);
                        })
                        .catch(() => {
                            // Fallback: just try direct download
                            link.click();
                        });
                }
                
                showNotification('üì• Foto sedang didownload...', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showNotification('‚ùå Gagal download foto. Coba klik kanan > Save Image.', 'error');
            }
        }
        
        function adminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (username === 'elfida' && password === 'Pis212bar@') {
                currentUser = { username: 'elfida', role: 'admin' };
                showPage('admin');
                showNotification('‚úÖ Selamat datang Admin !', 'success');
            } else {
                showNotification('‚ùå Username atau password salah!', 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            showPage('home');
            showNotification('üëã Logout berhasil', 'info');
        }
        
        function updateAdminStats() {
            const today = new Date().toDateString();
            const todayReports = reports.filter(report => {
                const reportDate = new Date(report.date || report.createdAt?.toDate?.() || Date.now()).toDateString();
                return reportDate === today;
            });
            
            const activeOfficersSet = new Set();
            reports.forEach(report => {
                if (report.activeOfficers) {
                    report.activeOfficers.split(',').forEach(officer => {
                        activeOfficersSet.add(officer.trim());
                    });
                }
            });
            
            document.getElementById('totalReports').textContent = reports.length;
            document.getElementById('todayReports').textContent = todayReports.length;
            document.getElementById('activeOfficersCount').textContent = activeOfficersSet.size;
            document.getElementById('totalPosts').textContent = feedPosts.length;
        }
        
        // FILTER SYSTEM FUNCTIONS
        function initializeFilters() {
            console.log('üîç Initializing filter system...');
            
            // Populate filter dropdowns
            populateFilterDropdowns();
            
            // Set up event listeners
            setupFilterEventListeners();
            
            // Initialize filtered data
            filteredReports = [...reports];
            filteredPosts = [...feedPosts];
            
            // Update filter stats
            updateFilterStats();
            
            console.log('‚úÖ Filter system initialized');
        }
        
        function populateFilterDropdowns() {
            const officerSelect = document.getElementById('filterOfficer');
            const teamSelect = document.getElementById('filterTeam');
            
            if (!officerSelect || !teamSelect) return;
            
            // Clear existing options (keep default)
            officerSelect.innerHTML = '<option value="">Semua Petugas</option>';
            teamSelect.innerHTML = '<option value="">Semua Tim</option>';
            
            // Get unique officers and teams
            const officers = new Set();
            const teams = new Set();
            
            reports.forEach(report => {
                const team = report.t || report.team;
                const activeOfficers = report.ao || report.activeOfficers;
                
                if (team) teams.add(team);
                if (activeOfficers) {
                    activeOfficers.split(',').forEach(officer => {
                        officers.add(officer.trim());
                    });
                }
            });
            
            feedPosts.forEach(post => {
                const team = post.t || post.team;
                const author = post.a || post.author;
                
                if (team) teams.add(team);
                if (author) officers.add(author.trim());
            });
            
            // Populate officers dropdown
            Array.from(officers).sort().forEach(officer => {
                const option = document.createElement('option');
                option.value = officer;
                option.textContent = officer;
                officerSelect.appendChild(option);
            });
            
            // Populate teams dropdown
            Array.from(teams).sort().forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
            
            console.log(`üìä Filter dropdowns populated: ${officers.size} officers, ${teams.size} teams`);
        }
        
        function setupFilterEventListeners() {
            const filterPeriod = document.getElementById('filterPeriod');
            const customDateRange = document.getElementById('customDateRange');
            
            if (filterPeriod) {
                filterPeriod.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customDateRange.classList.remove('hidden');
                        // Set default dates
                        const today = new Date();
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        
                        document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
                        document.getElementById('endDate').value = today.toISOString().split('T')[0];
                    } else {
                        customDateRange.classList.add('hidden');
                    }
                });
            }
        }
        
        function applyFilters() {
            console.log('üîç Applying filters...');
            
            // Get filter values
            currentFilters.officer = document.getElementById('filterOfficer')?.value || '';
            currentFilters.team = document.getElementById('filterTeam')?.value || '';
            currentFilters.period = document.getElementById('filterPeriod')?.value || '';
            currentFilters.startDate = document.getElementById('startDate')?.value || '';
            currentFilters.endDate = document.getElementById('endDate')?.value || '';
            
            // Filter reports
            filteredReports = reports.filter(report => {
                return matchesFilters(report, 'report');
            });
            
            // Filter posts
            filteredPosts = feedPosts.filter(post => {
                return matchesFilters(post, 'post');
            });
            
            // Update UI
            updateFilterStats();
            updateReportsTable();
            updateFeedTable();
            updateFilterStatus();
            
            console.log(`‚úÖ Filters applied: ${filteredReports.length} reports, ${filteredPosts.length} posts`);
            showNotification(`üîç Filter diterapkan: ${filteredReports.length} laporan, ${filteredPosts.length} postingan`, 'success');
        }
        
        function matchesFilters(item, type) {
            // Get item data (support both old and new format)
            const team = item.t || item.team || '';
            const date = new Date(item.dt || item.date || item.c?.toDate?.() || item.createdAt?.toDate?.() || Date.now());
            
            let officers = '';
            if (type === 'report') {
                officers = item.ao || item.activeOfficers || '';
            } else {
                officers = item.a || item.author || '';
            }
            
            // Officer filter
            if (currentFilters.officer) {
                const officerMatch = officers.toLowerCase().includes(currentFilters.officer.toLowerCase());
                if (!officerMatch) return false;
            }
            
            // Team filter
            if (currentFilters.team) {
                if (team.toLowerCase() !== currentFilters.team.toLowerCase()) return false;
            }
            
            // Period filter
            if (currentFilters.period) {
                if (!matchesPeriod(date, currentFilters.period)) return false;
            }
            
            // Custom date range filter
            if (currentFilters.startDate && currentFilters.endDate) {
                const startDate = new Date(currentFilters.startDate);
                const endDate = new Date(currentFilters.endDate);
                endDate.setHours(23, 59, 59, 999); // Include full end date
                
                if (date < startDate || date > endDate) return false;
            }
            
            return true;
        }
        
        function matchesPeriod(date, period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (period) {
                case 'today':
                    return date >= today;
                    
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    return date >= yesterday && date < today;
                    
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return date >= weekAgo;
                    
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return date >= monthStart;
                    
                case 'lastmonth':
                    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    return date >= lastMonthStart && date <= lastMonthEnd;
                    
                default:
                    return true;
            }
        }
        
        function resetFilters() {
            console.log('üîÑ Resetting filters...');
            
            // Reset filter controls
            document.getElementById('filterOfficer').value = '';
            document.getElementById('filterTeam').value = '';
            document.getElementById('filterPeriod').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customDateRange').classList.add('hidden');
            
            // Reset filter state
            currentFilters = {
                officer: '',
                team: '',
                period: '',
                startDate: '',
                endDate: ''
            };
            
            // Reset filtered data to show all
            filteredReports = [...reports];
            filteredPosts = [...feedPosts];
            
            // Update UI
            updateFilterStats();
            updateReportsTable();
            updateFeedTable();
            updateFilterStatus();
            
            console.log('‚úÖ Filters reset - showing all data');
            showNotification('üîÑ Filter direset - menampilkan semua data', 'info');
        }
        
        function updateFilterStats() {
            // Calculate unique officers and teams in filtered data
            const uniqueOfficers = new Set();
            const uniqueTeams = new Set();
            
            filteredReports.forEach(report => {
                const team = report.t || report.team;
                const officers = report.ao || report.activeOfficers;
                
                if (team) uniqueTeams.add(team);
                if (officers) {
                    officers.split(',').forEach(officer => {
                        uniqueOfficers.add(officer.trim());
                    });
                }
            });
            
            filteredPosts.forEach(post => {
                const team = post.t || post.team;
                const author = post.a || post.author;
                
                if (team) uniqueTeams.add(team);
                if (author) uniqueOfficers.add(author.trim());
            });
            
            // Update filter stats display
            document.getElementById('filteredReports').textContent = filteredReports.length;
            document.getElementById('filteredPosts').textContent = filteredPosts.length;
            document.getElementById('filteredOfficers').textContent = uniqueOfficers.size;
            document.getElementById('filteredTeams').textContent = uniqueTeams.size;
        }
        
        function updateFilterStatus() {
            const filterStatus = document.getElementById('filterStatus');
            if (!filterStatus) return;
            
            const activeFilters = [];
            
            if (currentFilters.officer) activeFilters.push(`Petugas: ${currentFilters.officer}`);
            if (currentFilters.team) activeFilters.push(`Tim: ${currentFilters.team}`);
            if (currentFilters.period) {
                const periodNames = {
                    'today': 'Hari Ini',
                    'yesterday': 'Kemarin',
                    'week': '7 Hari Terakhir',
                    'month': 'Bulan Ini',
                    'lastmonth': 'Bulan Lalu',
                    'custom': 'Custom Range'
                };
                activeFilters.push(`Periode: ${periodNames[currentFilters.period] || currentFilters.period}`);
            }
            if (currentFilters.startDate && currentFilters.endDate) {
                activeFilters.push(`${currentFilters.startDate} - ${currentFilters.endDate}`);
            }
            
            if (activeFilters.length > 0) {
                filterStatus.textContent = activeFilters.join(' ‚Ä¢ ');
                filterStatus.className = 'ml-auto text-sm text-purple-300';
            } else {
                filterStatus.textContent = 'Semua Data';
                filterStatus.className = 'ml-auto text-sm text-white/60';
            }
        }
        
        function updateReportsTable() {
            const tbody = document.getElementById('reportsTableBody');
            const reportsCount = document.getElementById('reportsCount');
            if (!tbody) return;

            // Use a copy of filteredReports for sorting, to avoid modifying the original filtered array
            let displayReports = [...filteredReports];

            // Sort the data based on the current sort configuration
            if (reportSortConfig.key) {
                displayReports.sort((a, b) => {
                    let valA, valB;

                    switch (reportSortConfig.key) {
                        case 'date':
                            valA = new Date(a.dt || a.date || a.c?.toDate?.() || a.createdAt?.toDate?.() || 0);
                            valB = new Date(b.dt || b.date || b.c?.toDate?.() || b.createdAt?.toDate?.() || 0);
                            break;
                        case 'team':
                            valA = (a.t || a.team || '').toLowerCase();
                            valB = (b.t || b.team || '').toLowerCase();
                            break;
                        case 'shift':
                            valA = (a.s || a.shift || '').toLowerCase();
                            valB = (b.s || b.shift || '').toLowerCase();
                            break;
                        case 'officers':
                            valA = (a.ao || a.activeOfficers || '').toLowerCase();
                            valB = (b.ao || b.activeOfficers || '').toLowerCase();
                            break;
                        case 'location':
                            valA = (a.l || a.location || '').toLowerCase();
                            valB = (b.l || b.location || '').toLowerCase();
                            break;
                        default: return 0;
                    }

                    if (valA < valB) return reportSortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return reportSortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Update counter
            if (reportsCount) {
                reportsCount.textContent = `${displayReports.length} laporan`;
            }
            
            if (displayReports.length === 0) {
                const isFiltered = Object.values(currentFilters).some(val => val !== '') || (document.getElementById('reportSearchInput')?.value || '') !== '';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-16 text-white/50">
                            <div class="flex flex-col items-center space-y-3">
                                <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center">
                                    <span class="text-3xl">${isFiltered ? 'üîç' : 'üìã'}</span>
                                </div>
                                <div class="text-center">
                                    <p class="text-lg font-medium">${isFiltered ? 'Tidak ada laporan yang sesuai filter' : 'Belum ada laporan tersimpan'}</p>
                                    <p class="text-sm text-white/40 mt-1">${isFiltered ? 'Coba ubah kriteria filter atau reset filter' : 'Laporan akan muncul di sini setelah petugas mengirim'}</p>
                                    ${isFiltered ? '<button onclick="resetFilters()" class="mt-3 bg-purple-500/20 text-purple-300 px-4 py-2 rounded-lg hover:bg-purple-500/30 transition-all text-sm">üîÑ Reset Filter</button>' : ''}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Update sort indicators in table headers
            document.querySelectorAll('[id^="sort-indicator-"]').forEach(span => span.textContent = '');
            const indicatorSpan = document.getElementById(`sort-indicator-${reportSortConfig.key}`);
            if (indicatorSpan) {
                indicatorSpan.textContent = reportSortConfig.direction === 'asc' ? '‚ñ≤' : '‚ñº';
            }
            
            tbody.innerHTML = displayReports.map(report => {
                // Support both old and new optimized format
                const date = new Date(report.dt || report.date || report.c?.toDate?.() || report.createdAt?.toDate?.() || Date.now());
                const team = report.t || report.team || 'N/A';
                const shift = report.s || report.shift || 'N/A';
                const activeOfficers = report.ao || report.activeOfficers || 'N/A';
                const location = report.l || report.location || 'N/A';
                const photo = report.p || report.photo || '';
                const description = report.d || report.description || '';
                const inactiveOfficers = report.io || report.inactiveOfficers || '';
                
                return `
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="py-4 px-4 text-white/90 font-medium">
                            <div class="flex flex-col">
                                <span>${date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
                                <span class="text-xs text-white/50">${report.jam || date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                            </div>
                        </td>
                        <td class="py-4 px-4 text-white/90 font-semibold">
                            <span class="inline-flex items-center px-2 py-1 bg-blue-500/20 text-blue-300 rounded-lg text-xs font-medium">
                                ${team}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-white/80 table-cell-truncate" title="${shift}">${shift}</td>
                        <td class="py-4 px-4 text-white/80 table-cell-truncate" title="${activeOfficers}">${activeOfficers}</td>
                        <td class="py-4 px-4 text-white/70 table-cell-truncate" title="${location}">${location}</td>
                        <td class="py-4 px-4 text-center">
                            ${photo ? `
                                <button onclick="openImageModal('${photo}')" class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-blue-500/20 to-purple-500/20 text-blue-300 rounded-xl hover:from-blue-500/30 hover:to-purple-500/30 transition-all duration-200 group-hover:scale-105">
                                    <span class="text-lg">üì∑</span>
                                </button>
                            ` : '<span class="text-white/30 text-sm">Tidak ada</span>'}
                        </td>
                        <td class="py-4 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="editReport('${report.id}')" class="inline-flex items-center justify-center w-9 h-9 bg-gradient-to-r from-green-500/20 to-blue-500/20 text-green-300 rounded-xl hover:from-green-500/30 hover:to-blue-500/30 transition-all duration-200 group-hover:scale-105" title="Edit Laporan">
                                    <span class="text-sm">‚úèÔ∏è</span>
                                </button>
                                <button onclick="deleteReport('${report.id}')" class="inline-flex items-center justify-center w-9 h-9 bg-gradient-to-r from-red-500/20 to-pink-500/20 text-red-300 rounded-xl hover:from-red-500/30 hover:to-pink-500/30 transition-all duration-200 group-hover:scale-105" title="Hapus Laporan">
                                    <span class="text-sm">üóëÔ∏è</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateFeedTable() {
            const tbody = document.getElementById('feedTableBody');
            const postsCount = document.getElementById('postsCount');
            if (!tbody) return;

            // Use a copy of filteredPosts for display
            const displayPosts = [...filteredPosts];

            // Update counter
            if (postsCount) {
                postsCount.textContent = `${displayPosts.length} postingan`;
            }

            if (displayPosts.length === 0) {
                const isFiltered = Object.values(currentFilters).some(val => val !== '');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-16 text-white/50">
                            <div class="flex flex-col items-center space-y-3">
                                <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center">
                                    <span class="text-3xl">${isFiltered ? 'üîç' : 'üí¨'}</span>
                                </div>
                                <div class="text-center">
                                    <p class="text-lg font-medium">${isFiltered ? 'Tidak ada postingan yang sesuai filter' : 'Belum ada postingan di feed'}</p>
                                    <p class="text-sm text-white/40 mt-1">${isFiltered ? 'Coba ubah kriteria filter' : 'Postingan akan muncul di sini'}</p>
                                    ${isFiltered ? '<button onclick="resetFilters()" class="mt-3 bg-purple-500/20 text-purple-300 px-4 py-2 rounded-lg hover:bg-purple-500/30 transition-all text-sm">üîÑ Reset Filter</button>' : ''}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = displayPosts.map(post => {
                const date = new Date(post.dt || post.date || post.createdAt?.toDate?.() || Date.now());
                const author = post.a || post.author || 'N/A';
                const team = post.t || post.team || 'N/A';
                const content = post.c || post.content || 'N/A';
                const type = post.tp || post.type || 'post';

                return `
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="py-4 px-4 text-white/90 font-medium">
                            <div class="flex flex-col">
                                <span>${date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
                                <span class="text-xs text-white/50">${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                        </td>
                        <td class="py-4 px-4 text-white/80 table-cell-truncate" title="${author}">${author}</td>
                        <td class="py-4 px-4 text-white/80">
                            <span class="inline-flex items-center px-2 py-1 bg-blue-500/20 text-blue-300 rounded-lg text-xs font-medium">
                                ${team}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-white/70 table-cell-truncate" title="${content}">${content}</td>
                        <td class="py-4 px-4 text-center text-white/80">
                            <span class="px-2 py-1 rounded-full text-xs ${type === 'rpt' ? 'bg-blue-500/20 text-blue-300' : 'bg-green-500/20 text-green-300'}">
                                ${type === 'rpt' ? 'Laporan' : 'Post'}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="editPost('${post.id}')" class="inline-flex items-center justify-center w-9 h-9 bg-gradient-to-r from-green-500/20 to-blue-500/20 text-green-300 rounded-xl hover:from-green-500/30 hover:to-blue-500/30 transition-all duration-200 group-hover:scale-105" title="Edit Postingan">
                                    <span class="text-sm">‚úèÔ∏è</span>
                                </button>
                                <button onclick="deletePost('${post.id}')" class="inline-flex items-center justify-center w-9 h-9 bg-gradient-to-r from-red-500/20 to-pink-500/20 text-red-300 rounded-xl hover:from-red-500/30 hover:to-pink-500/30 transition-all duration-200 group-hover:scale-105" title="Hapus Postingan">
                                    <span class="text-sm">üóëÔ∏è</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function deleteReport(reportId) {
            if (!confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(window.db, 'reports', reportId));
                showNotification('‚úÖ Laporan berhasil dihapus!', 'success');
            } catch (error) {
                console.log('Error deleting report:', error);
                showNotification('‚ùå Gagal menghapus laporan', 'error');
            }
        }
        
        async function deletePost(postId) {
            if (!confirm('Apakah Anda yakin ingin menghapus postingan ini?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(window.db, 'feed', postId));
                showNotification('‚úÖ Postingan berhasil dihapus!', 'success');
            } catch (error) {
                console.log('Error deleting post:', error);
                showNotification('‚ùå Gagal menghapus postingan', 'error');
            }
        }
        
        async function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const reportsData = reports.map(report => ({
                    'Tanggal': new Date(report.date || report.createdAt?.toDate?.() || Date.now()).toLocaleDateString('id-ID'),
                    'Tim': report.team,
                    'Shift': report.shift,
                    'Petugas Aktif': report.activeOfficers,
                    'Petugas Tidak Aktif': report.inactiveOfficers || '-',
                    'Lokasi': report.location,
                    'Deskripsi': report.description
                }));
                
                const feedData = feedPosts.map(post => ({
                    'Tanggal': new Date(post.date || post.createdAt?.toDate?.() || Date.now()).toLocaleDateString('id-ID'),
                    'Penulis': post.author,
                    'Tim': post.team,
                    'Konten': post.content,
                    'Lokasi': post.location || '-',
                    'Tipe': post.type === 'report' ? 'Laporan' : 'Postingan',
                    'Likes': post.likes || 0,
                    'Komentar': post.comments?.length || 0
                }));
                
                const reportsWS = XLSX.utils.json_to_sheet(reportsData);
                const feedWS = XLSX.utils.json_to_sheet(feedData);
                
                XLSX.utils.book_append_sheet(wb, reportsWS, 'Laporan Kerja');
                XLSX.utils.book_append_sheet(wb, feedWS, 'Feed Postingan');
                
                const filename = `PPSU-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showNotification('üìä File Excel berhasil diunduh!', 'success');
                
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('‚ùå Gagal export Excel', 'error');
            }
        }
        
        async function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('Laporan PPSU-Pisbar-App', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`, 20, 35);
                
                let yPosition = 50;
                
                doc.setFontSize(16);
                doc.text('Laporan Kerja', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                reports.forEach((report, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    const date = new Date(report.date || report.createdAt?.toDate?.() || Date.now()).toLocaleDateString('id-ID');
                    doc.text(`${index + 1}. ${date} - ${report.team}`, 20, yPosition);
                    yPosition += 5;
                    doc.text(`   Shift: ${report.shift} | Petugas: ${report.activeOfficers}`, 20, yPosition);
                    yPosition += 5;
                    doc.text(`   Lokasi: ${report.location}`, 20, yPosition);
                    yPosition += 5;
                    doc.text(`   Deskripsi: ${report.description}`, 20, yPosition);
                    yPosition += 10;
                });
                
                const filename = `PPSU-Report-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                showNotification('üìÑ File PDF berhasil diunduh!', 'success');
                
            } catch (error) {
                console.error('Export PDF error:', error);
                showNotification('‚ùå Gagal export PDF', 'error');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            notification.className = 'notification';
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else if (type === 'info') {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // Toggle create post form
        function toggleCreatePost() {
            const createPostForm = document.getElementById('createPostForm');
            createPostForm.classList.toggle('hidden');
            
            if (!createPostForm.classList.contains('hidden')) {
                document.getElementById('postAuthor').focus();
            }
        }
        
        // EDIT FUNCTIONS FOR ADMIN
        function editReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) {
                showNotification('‚ùå Laporan tidak ditemukan!', 'error');
                return;
            }
            
            // Support both old and new format
            document.getElementById('editReportId').value = reportId;
            document.getElementById('editTeam').value = report.t || report.team || '';
            document.getElementById('editShift').value = report.s || report.shift || '';
            document.getElementById('editActiveOfficers').value = report.ao || report.activeOfficers || '';
            document.getElementById('editInactiveOfficers').value = report.io || report.inactiveOfficers || '';
            document.getElementById('editLocation').value = report.l || report.location || '';
            document.getElementById('editDescription').value = report.d || report.description || '';
            
            document.getElementById('editReportModal').classList.remove('hidden');
            document.getElementById('editTeam').focus();
        }
        
        function editPost(postId) {
            const post = feedPosts.find(p => p.id === postId);
            if (!post) {
                showNotification('‚ùå Postingan tidak ditemukan!', 'error');
                return;
            }
            
            // Support both old and new format
            document.getElementById('editPostId').value = postId;
            document.getElementById('editPostAuthor').value = post.author || post.a || '';
            document.getElementById('editPostTeam').value = post.team || post.t || '';
            document.getElementById('editPostContent').value = post.content || post.c || '';
            document.getElementById('editPostLocation').value = post.location || post.l || '';
            
            document.getElementById('editPostModal').classList.remove('hidden');
            document.getElementById('editPostAuthor').focus();
        }
        
        async function saveReportEdit() {
            const reportId = document.getElementById('editReportId').value;
            const team = document.getElementById('editTeam').value.trim();
            const shift = document.getElementById('editShift').value.trim();
            const activeOfficers = document.getElementById('editActiveOfficers').value.trim();
            const inactiveOfficers = document.getElementById('editInactiveOfficers').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            
            if (!team || !shift || !activeOfficers || !location || !description) {
                showNotification('‚ùå Mohon lengkapi semua wajib!', 'error');
                return;
            }
            
            const submitBtn = document.querySelector('#editReportForm button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Menyimpan...';
            submitBtn.disabled = true;
            
            try {
                const reportRef = doc(window.db, 'reports', reportId);
                
                // Use optimized format for Firebase
                const updateData = {
                    t: team,                    // team (shortened)
                    s: shift,                   // shift
                    ao: activeOfficers,         // activeOfficers
                    io: inactiveOfficers,       // inactiveOfficers
                    l: location,                // location
                    d: description,             // description
                    updatedAt: serverTimestamp(),
                    updatedBy: 'admin'
                };
                
                await updateDoc(reportRef, updateData);
                
                closeEditModal();
                showNotification('‚úÖ Laporan berhasil diperbarui!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error updating report:', error);
                showNotification(`‚ùå Gagal memperbarui laporan: ${error.message}`, 'error');
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        async function savePostEdit() {
            const postId = document.getElementById('editPostId').value;
            const author = document.getElementById('editPostAuthor').value.trim();
            const team = document.getElementById('editPostTeam').value.trim();
            const content = document.getElementById('editPostContent').value.trim();
            const location = document.getElementById('editPostLocation').value.trim();
            
            if (!author || !team || !content) {
                showNotification('‚ùå Mohon lengkapi nama penulis, tim, dan konten!', 'error');
                return;
            }
            
            const submitBtn = document.querySelector('#editPostForm button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Menyimpan...';
            submitBtn.disabled = true;
            
            try {
                const postRef = doc(window.db, 'feed', postId);
                
                // Use optimized format for Firebase
                const updateData = {
                    a: author,                  // author (shortened)
                    t: team,                    // team
                    c: content,                 // content
                    l: location,                // location
                    updatedAt: serverTimestamp(),
                    updatedBy: 'admin'
                };
                
                await updateDoc(postRef, updateData);
                
                closeEditPostModal();
                showNotification('‚úÖ Postingan berhasil diperbarui!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error updating post:', error);
                showNotification(`‚ùå Gagal memperbarui postingan: ${error.message}`, 'error');
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        function closeEditModal() {
            document.getElementById('editReportModal').classList.add('hidden');
            document.getElementById('editReportForm').reset();
        }
        
        function closeEditPostModal() {
            document.getElementById('editPostModal').classList.add('hidden');
            document.getElementById('editPostForm').reset();
        }
        
        // SPREADSHEET LINKS MANAGEMENT FUNCTIONS
        
        function loadSpreadsheetLinks() {
            const container = document.getElementById('spreadsheetLinksContainer');
            if (!container) return;
            
            container.innerHTML = Object.entries(spreadsheetLinks).map(([teamName, link]) => {
                const teamIcon = getTeamIcon(teamName);
                const teamColor = getTeamColor(teamName);
                
                return `
                    <div class="bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10 hover:bg-white/10 transition-all duration-200 group">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-10 h-10 ${teamColor} rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="text-white text-lg">${teamIcon}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-white font-semibold text-sm truncate">${teamName}</h4>
                                <p class="text-white/50 text-xs">Laporan Kepgub September</p>
                            </div>
                        </div>
                        
                        <a href="${link}" target="_blank" rel="noopener noreferrer" 
                           class="block w-full bg-gradient-to-r from-emerald-500/20 to-teal-500/20 hover:from-emerald-500/30 hover:to-teal-500/30 text-emerald-300 text-center py-2.5 px-4 rounded-lg transition-all duration-200 text-sm font-medium border border-emerald-500/20 hover:border-emerald-500/40">
                            <span class="flex items-center justify-center space-x-2">
                                <span>üìä</span>
                                <span>Buka Spreadsheet</span>
                                <span class="text-xs opacity-60">‚Üó</span>
                            </span>
                        </a>
                    </div>
                `;
            }).join('');
        }
        
        function getTeamIcon(teamName) {
            const icons = {
                'Tim Penyapuan': 'üßπ',
                'Tim Saluran 1': 'üö∞',
                'Tim Saluran 2': 'üö∞',
                'Tim Saluran 3': 'üö∞',
                'Tim Saluran 4': 'üö∞',
                'Tim Taman': 'üå≥',
                'Tim Penataan': 'üèóÔ∏è',
                'Tim TRC': 'üöõ',
                'Tim Zondal': 'üóÇÔ∏è'
            };
            return icons[teamName] || 'üë•';
        }
        
        function getTeamColor(teamName) {
            const colors = {
                'Tim Penyapuan': 'bg-gradient-to-r from-yellow-500 to-orange-500',
                'Tim Saluran 1': 'bg-gradient-to-r from-blue-500 to-cyan-500',
                'Tim Saluran 2': 'bg-gradient-to-r from-cyan-500 to-teal-500',
                'Tim Saluran 3': 'bg-gradient-to-r from-teal-500 to-green-500',
                'Tim Saluran 4': 'bg-gradient-to-r from-blue-600 to-indigo-500',
                'Tim Taman': 'bg-gradient-to-r from-green-500 to-emerald-500',
                'Tim Penataan': 'bg-gradient-to-r from-purple-500 to-pink-500',
                'Tim TRC': 'bg-gradient-to-r from-red-500 to-orange-500',
                'Tim Zondal': 'bg-gradient-to-r from-indigo-500 to-purple-500'
            };
            return colors[teamName] || 'bg-gradient-to-r from-gray-500 to-gray-600';
        }
        
        function populateTeamSelect() {
            const select = document.getElementById('editTeamSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Pilih Tim --</option>';
            
            Object.keys(spreadsheetLinks).forEach(teamName => {
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                select.appendChild(option);
            });
            
            // Add event listener for team selection
            select.addEventListener('change', function() {
                const selectedTeam = this.value;
                const linkInput = document.getElementById('editTeamLink');
                
                if (selectedTeam && spreadsheetLinks[selectedTeam]) {
                    linkInput.value = spreadsheetLinks[selectedTeam];
                } else {
                    linkInput.value = '';
                }
            });
        }
        
        function updateCurrentLinksPreview() {
            const container = document.getElementById('currentLinksPreview');
            if (!container) return;
            
            container.innerHTML = Object.entries(spreadsheetLinks).map(([teamName, link]) => {
                const teamIcon = getTeamIcon(teamName);
                const shortLink = link.length > 40 ? link.substring(0, 37) + '...' : link;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/10">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <span class="text-lg">${teamIcon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="text-white text-sm font-medium truncate">${teamName}</div>
                                <div class="text-white/50 text-xs truncate" title="${link}">${shortLink}</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editTeamLink('${teamName}')" class="text-blue-300 hover:text-blue-200 text-xs p-1" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteTeamLink('${teamName}')" class="text-red-300 hover:text-red-200 text-xs p-1" title="Hapus">
                                üóëÔ∏è
                            </button>
                            <a href="${link}" target="_blank" class="text-emerald-300 hover:text-emerald-200 text-xs p-1" title="Buka">
                                üîó
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editTeamLink(teamName) {
            const select = document.getElementById('editTeamSelect');
            const linkInput = document.getElementById('editTeamLink');
            
            if (select && linkInput) {
                select.value = teamName;
                linkInput.value = spreadsheetLinks[teamName] || '';
                linkInput.focus();
            }
        }
        
        async function updateSpreadsheetLink() {
            const teamSelect = document.getElementById('editTeamSelect');
            const linkInput = document.getElementById('editTeamLink');
            
            const selectedTeam = teamSelect.value.trim();
            const newLink = linkInput.value.trim();
            
            if (!selectedTeam) {
                showNotification('‚ùå Pilih tim terlebih dahulu!', 'error');
                return;
            }
            
            if (!newLink) {
                showNotification('‚ùå Masukkan link spreadsheet!', 'error');
                return;
            }
            
            // Validate URL
            try {
                new URL(newLink);
            } catch (error) {
                showNotification('‚ùå Format URL tidak valid!', 'error');
                return;
            }
            
            const updateBtn = event.target;
            const originalText = updateBtn.innerHTML;
            updateBtn.innerHTML = '‚è≥ Menyimpan...';
            updateBtn.disabled = true;
            
            try {
                // Update local data
                spreadsheetLinks[selectedTeam] = newLink;
                
                // Save to Firebase
                if (window.db) {
                    const spreadsheetDoc = doc(window.db, 'settings', 'spreadsheet_links');
                    await setDoc(spreadsheetDoc, {
                        links: spreadsheetLinks,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser?.username || 'admin'
                    });
                    
                    console.log('‚úÖ Spreadsheet link updated in Firebase');
                }
                
                // Save to localStorage as backup
                localStorage.setItem('ppsu_spreadsheet_links', JSON.stringify(spreadsheetLinks));
                
                // Update UI
                loadSpreadsheetLinks();
                updateCurrentLinksPreview();
                
                // Reset form
                teamSelect.value = '';
                linkInput.value = '';
                
                showNotification(`‚úÖ Link ${selectedTeam} berhasil diperbarui!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error updating spreadsheet link:', error);
                showNotification(`‚ùå Gagal memperbarui link: ${error.message}`, 'error');
            }
            
            updateBtn.innerHTML = originalText;
            updateBtn.disabled = false;
        }
        
        function testSpreadsheetLink() {
            const linkInput = document.getElementById('editTeamLink');
            const link = linkInput.value.trim();
            
            if (!link) {
                showNotification('‚ùå Masukkan link terlebih dahulu!', 'error');
                return;
            }
            
            try {
                new URL(link);
                window.open(link, '_blank', 'noopener,noreferrer');
                showNotification('üîó Link dibuka di tab baru untuk testing', 'info');
            } catch (error) {
                showNotification('‚ùå Format URL tidak valid!', 'error');
            }
        }
        
        async function deleteTeamLink(teamName) {
            if (!confirm(`Apakah Anda yakin ingin menghapus link ${teamName}?\n\nLink akan dihapus dari Firebase dan tidak dapat dikembalikan.`)) {
                return;
            }
            
            try {
                // Remove from local data
                delete spreadsheetLinks[teamName];
                
                // Update Firebase - save the reduced data to save storage
                if (window.db) {
                    const spreadsheetDoc = doc(window.db, 'settings', 'spreadsheet_links');
                    await setDoc(spreadsheetDoc, {
                        links: spreadsheetLinks,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser?.username || 'admin',
                        deletedTeam: teamName,
                        action: 'delete_team_link'
                    });
                    
                    console.log(`‚úÖ Link ${teamName} deleted from Firebase to save storage`);
                }
                
                // Update localStorage
                localStorage.setItem('ppsu_spreadsheet_links', JSON.stringify(spreadsheetLinks));
                
                // Update UI
                loadSpreadsheetLinks();
                updateCurrentLinksPreview();
                populateTeamSelect();
                
                // Reset form if the deleted team was selected
                const teamSelect = document.getElementById('editTeamSelect');
                const linkInput = document.getElementById('editTeamLink');
                if (teamSelect.value === teamName) {
                    teamSelect.value = '';
                    linkInput.value = '';
                }
                
                showNotification(`üóëÔ∏è Link ${teamName} berhasil dihapus dari Firebase!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error deleting team link:', error);
                showNotification(`‚ùå Gagal menghapus link: ${error.message}`, 'error');
            }
        }
        
        async function resetToDefaultLinks() {
            if (!confirm('Apakah Anda yakin ingin mereset semua link ke default September 2024?')) {
                return;
            }
            
            const resetBtn = event.target;
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '‚è≥ Mereset...';
            resetBtn.disabled = true;
            
            try {
                // Reset to default
                spreadsheetLinks = { ...defaultSpreadsheetLinks };
                
                // Save to Firebase
                if (window.db) {
                    const spreadsheetDoc = doc(window.db, 'settings', 'spreadsheet_links');
                    await setDoc(spreadsheetDoc, {
                        links: spreadsheetLinks,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser?.username || 'admin',
                        resetToDefault: true
                    });
                }
                
                // Save to localStorage
                localStorage.setItem('ppsu_spreadsheet_links', JSON.stringify(spreadsheetLinks));
                
                // Update UI
                loadSpreadsheetLinks();
                updateCurrentLinksPreview();
                populateTeamSelect();
                
                // Reset form
                document.getElementById('editTeamSelect').value = '';
                document.getElementById('editTeamLink').value = '';
                
                showNotification('üîÑ Semua link berhasil direset ke default September 2024!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error resetting links:', error);
                showNotification(`‚ùå Gagal mereset link: ${error.message}`, 'error');
            }
            
            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
        }
        
        async function deleteAllLinks() {
            const totalLinks = Object.keys(spreadsheetLinks).length;
            
            if (totalLinks === 0) {
                showNotification('‚ÑπÔ∏è Tidak ada link untuk dihapus', 'info');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è PERINGATAN PENGHAPUSAN MASSAL!\n\nAnda akan menghapus SEMUA ${totalLinks} link spreadsheet dari Firebase.\n\nTindakan ini akan:\n‚Ä¢ Menghemat storage Firebase secara signifikan\n‚Ä¢ Menghapus semua link tim secara permanen\n‚Ä¢ Tidak dapat dikembalikan\n\nApakah Anda yakin ingin melanjutkan?`)) {
                return;
            }
            
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '‚è≥ Menghapus...';
            deleteBtn.disabled = true;
            
            try {
                // Clear all links
                const deletedLinks = { ...spreadsheetLinks };
                spreadsheetLinks = {};
                
                // Update Firebase with empty data to save maximum storage
                if (window.db) {
                    const spreadsheetDoc = doc(window.db, 'settings', 'spreadsheet_links');
                    await setDoc(spreadsheetDoc, {
                        links: {},
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser?.username || 'admin',
                        action: 'bulk_delete_all_links',
                        deletedCount: totalLinks,
                        deletedLinks: Object.keys(deletedLinks),
                        storageOptimized: true
                    });
                    
                    console.log(`‚úÖ All ${totalLinks} links deleted from Firebase - Storage optimized!`);
                }
                
                // Clear localStorage
                localStorage.setItem('ppsu_spreadsheet_links', JSON.stringify({}));
                
                // Update UI
                loadSpreadsheetLinks();
                updateCurrentLinksPreview();
                populateTeamSelect();
                
                // Reset form
                document.getElementById('editTeamSelect').value = '';
                document.getElementById('editTeamLink').value = '';
                
                showNotification(`üóëÔ∏è Semua ${totalLinks} link berhasil dihapus! Firebase storage dioptimalkan.`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error deleting all links:', error);
                showNotification(`‚ùå Gagal menghapus semua link: ${error.message}`, 'error');
            }
            
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
        
        function exportSpreadsheetLinks() {
            try {
                const exportData = {
                    title: 'PPSU Pisbar - Spreadsheet Links',
                    exportDate: new Date().toISOString(),
                    month: 'September 2024',
                    links: spreadsheetLinks,
                    totalTeams: Object.keys(spreadsheetLinks).length
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `PPSU-Spreadsheet-Links-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(link.href);
                
                showNotification('üì§ File spreadsheet links berhasil diexport!', 'success');
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showNotification('‚ùå Gagal export spreadsheet links', 'error');
            }
        }
        
        // Cleanup function
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            if (reportsListener) {
                reportsListener();
            }
            if (feedListener) {
                feedListener();
            }
            if (spreadsheetListener) {
                spreadsheetListener();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b5c9488571f93e',t:'MTc1NzI0MzcwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>





